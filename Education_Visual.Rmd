---
title: "Mexican Report"
author: "Education"
date: "Great Cities Institute"
output: 
  pdf_document:
    latex_engine: xelatex
    toc: true
    highlight: pygments
    extra_dependencies: ["float"]
    fig_caption: true
mainfont: "Arial"
header-includes:
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, fig.pos="H")


```


```{r echo=FALSE, message=FALSE, warning=FALSE}

library(ipumsr)
library(tidyverse)
library(purrr)
library(sf)
library(tidycensus)
library(tidyr)
library(readxl)
library(sf)
library(htmltools)
library(leaflet)
library(janitor)
library(data.table)
library(tinytex)
library(survey) # for survey analysis
library(srvyr)  # for tidy survey analysis
library(tmap)
library("kableExtra") 
library(tmaptools)
library("RColorBrewer") 
#library(OpenStreetMap)
library(knitr)
options(knitr.kable.NA = '-')
 #options(tinytex.verbose = TRUE)
# tinytex::reinstall_tinytex()
# install.packages('tinytex')

#update.packages(ask = FALSE, checkBuilt = TRUE)
# tinytex::tlmgr_update()
# tinytex::latexmk("Education_Visual.tex")


##### Chicago boarder
Chicago_boundary_shp <- read_sf("C:/Users/dsegovi2/Box/Great Cities Institute/Research/Mexican Report/Boundaries_Chicago/geo_export_8881adc5-2460-457b-892f-04f4d6028b72.shp") %>% 
  st_transform(crs = 4326)

school_indicator <- read_csv("School/df_school.csv")

# mapview(community_shp)

# Get the current bounding box of the data
bbox_data <- st_bbox(Chicago_boundary_shp)

# Calculate the range of x and y values in degrees
xrange <- bbox_data$xmax - bbox_data$xmin
yrange <- bbox_data$ymax - bbox_data$ymin

# Calculate the center of the bounding box
center_x <- (bbox_data$xmin + bbox_data$xmax) / 2
center_y <- (bbox_data$ymin + bbox_data$ymax) / 2
# Modify the bounding box to fit the desired width while keeping the height the same
bbox_new <- c(center_x - 0.24,
              center_y - 0.23,
              center_x + 0.23,
              center_y + 0.23)

# osm_chicago <- read_osm(bbox_new, 
#                         type = "bing")
```

\renewcommand{\arraystretch}{1.4}
\clearpage


```{r}

# Read Data

usa_data <- read.csv("C:/Users/dsegovi2/Box/Great Cities Institute/Research/Mexican Report/final_Mexican_IL_2000_22.csv") %>% 
  mutate(race_ethnicity = case_when(hispan ==0 & race == 1 ~ "White (non-Hispanic or Latino)",
                                    hispan ==0 & race == 2 ~ "Black (non-Hispanic or Latino)",
                                    hispan %in% c(2,3,4) ~ "Other Hispanics or Latinos",
                                    hispan ==1 ~ "Mexican", 
                                    hispan ==0 & race %in%c(3:9) ~ "Other (non-Hispanic or Latino)",
                                    TRUE ~ NA_character_),
         
  race_ethnicity = factor(race_ethnicity, level = c("Mexican", "Other Hispanics or Latinos","White (non-Hispanic or Latino)", "Black (non-Hispanic or Latino)",  "Other (non-Hispanic or Latino)")),
  
  hispan_breakdown = case_when(
  hispand == 0 ~ "Not Hispanic",
  hispand == 100 ~ "Mexican", 
  hispand == 200 ~ "Puerto Rican",
  hispand == 300 ~ "Cuban",
  hispand == 411 ~ "Costa Rican",
  hispand == 412 ~ "Guatemalan",
  hispand == 413 ~ "Honduran",
  hispand == 414 ~ "Nicaraguan",
  hispand == 415 ~ "Panamanian",
  hispand == 416 ~ "Salvadoran",
  hispand == 417 ~ "Central American, not specified",
  hispand == 420 ~ "Argentinean",
  hispand == 421 ~ "Bolivian",
  hispand == 422 ~ "Chilean",
  hispand == 423 ~ "Colombian",
  hispand == 424 ~ "Ecuadorian",
  hispand == 425 ~ "Paraguayan",
  hispand == 426 ~ "Peruvian",
  hispand == 427 ~ "Uruguayan",
  hispand == 428 ~ "Venezuelan",
  hispand == 431 ~ "South American, not specified",
  hispand == 450 ~ "Spaniard",
  hispand == 460 ~ "Dominican",
  hispand == 498 ~ "Other, not specified",
  TRUE ~ "Other"
),
mex_foreign_born = case_when(
    race_ethnicity == "Mexican" & bpl %in% as.character(1:56) ~ "U.S. Born",
    race_ethnicity == "Mexican" & bpl == "200" ~ "Mexico Born",
    TRUE ~ NA_character_  # Optional: default case for other values or groups
  )) %>% ## filter for hispanic groups here ##
 mutate(hispan_breakdown = factor(hispan_breakdown, level = c("Mexican", "Puerto Rican","Ecuadorian", "Cuban", "Guatemalan", "Colombian"))
  )

# Chicago ca populationd data
chicago_ca_pop <- read_sf("Data Tables/shp/comm_pop_chi_2022.shp") %>% as.data.frame()

```


\blandscape
 
# 2. Education

## 2.A: Number and percentages in public and private schools by race/ethnicity. 

```{r}
# analysis
# select variables
data_chi_2018_22 <- usa_data  %>% filter(year == 2022) %>% select(year:gqtyped, perwt, hispan, race, race_ethnicity, school, schltype)



# Number and Percentage of Mexican population in public and private schools compared to other groups

# Step 1: Filter for individuals enrolled in school
enrolled_in_school <- data_chi_2018_22 %>%
  filter(school == 2)


# Define the survey design
survey_design <- enrolled_in_school %>% 
  as_survey_design(weights = perwt)

# Step 3: Calculate the total weighted count for each race/ethnicity group (denominator)
total_counts <- survey_design %>%
  group_by(race_ethnicity) %>%
  summarize(total_weighted_count = survey_total(vartype = "se"))

# Step 4: Calculate the weighted count of race/ethnicity in public and private schools (numerator)
school_counts <- survey_design %>%
  group_by(schltype, race_ethnicity) %>%
  summarize(weighted_count = survey_total(vartype = "se"))
  
# Step 5: Calculate the percentage of race/ethnicity groups in public and private schools
school_percentages <- school_counts %>%
  left_join(total_counts, by = "race_ethnicity") %>%
    mutate(percentage = paste0(format(round((weighted_count / total_weighted_count) * 100, 2), nsmall = 2), "%"))


# Step 6: Recode schltype for clarity
df_all <- school_percentages %>%
  mutate(schltype = case_when(
    schltype == 2 ~ "Public",
    schltype == 3 ~ "Private",
    TRUE ~ NA_character_
  ))
```


```{r}
# visual


table_2a <- df_all %>% 
  
pivot_wider(id_cols = schltype, names_from = "race_ethnicity",  values_from = c(weighted_count, total_weighted_count, percentage)) %>% 
  select(schltype,   weighted_count_Mexican,  percentage_Mexican, 
    'weighted_count_Other Latinos', 'percentage_Other Latinos',
    'weighted_count_White (non-Hispanic or Latino)',  'percentage_White (non-Hispanic or Latino)',
   'weighted_count_Black (non-Hispanic or Latino)',   'percentage_Black (non-Hispanic or Latino)',
    'weighted_count_Other (non-Hispanic or Latino)', 'percentage_Other (non-Hispanic or Latino)') %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("", "Number", "Percent" , "Number", "Percent", "Number", "Percent", "Number", "Percent", "Number", "Percent"),
      align = c("l",rep("c",10)),
      caption = "Number and percentages in public and private schools by race/ethnicity in Chicago, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:11, width = "2.3em")   %>%
  add_header_above( align = c("l", rep("c",2)), c("School Type", "Mexican" = 2, "Other Latinos" = 2, "White(non-Hispanic or Latino)" = 2, "Black(non-Hispanic or Latino)" = 2, "Other (non-Hispanic or Latino)" = 2),
                    # background = "#cbc9e2", 
                    bold = T, font_size =8) %>% 

  footnote(general = "Source: IPUMS-USA database (2018-2022 American Community Survey 5-Year Estimates). Tabulations by Great Cities Institute",
           general_title = "")   

table_2a 
```

\elandscape


## 2.B: Performance of Schools in Mexican Community Areas compared to City-Wide Mean


```{r}
# analysis
df_top_mex_schools <- chicago_ca_pop %>% arrange(desc(prc_mxc)) %>% top_n(4, prc_mxc) %>% left_join(school_indicator, by = c("commnty" = "commnty")) %>% select(school_name, chronic_absenteeism_hispanic_or_latino, ends_with("proficiency_hispanic_or_latino"))


# Calculate the mean for the specified columns, ignoring NA values
Mean_values <- colMeans(df_top_mex_schools[, c("chronic_absenteeism_hispanic_or_latino",
                                                  "percent_ela_proficiency_hispanic_or_latino",
                                                  "percent_math_proficiency_hispanic_or_latino",
                                                  "percent_science_proficiency_hispanic_or_latino")], na.rm = TRUE)

# Round the Mean to the nearest decimal digit
Mean_values_rounded <- round(Mean_values, 1)

# Create a new row with these Mean values
# Adding % sign to the appropriate columns
# Create a new row with these rounded Mean values and add the % sign
new_row <- c(
    "Mean Metrics for Hispanic or Latino Students in Top 4 Mexican Community Areas", 
    paste0(format(Mean_values_rounded[1], nsmall = 1), "%"), 
    paste0(format(Mean_values_rounded[2], nsmall = 1), "%"), 
    paste0(format(Mean_values_rounded[3], nsmall = 1), "%"), 
    paste0(format(Mean_values_rounded[4], nsmall = 1), "%"), 
    NA
)

# Set the column names of the new row to match the original data frame
names(new_row) <- colnames(df_top_mex_schools)

# Convert the new row to a data frame
df_Mean <- as.data.frame(t(new_row), stringsAsFactors = FALSE)

# Rename columns by removing "_hispanic_or_latino" suffix
names(df_Mean) <- gsub("_hispanic_or_latino", "", names(df_Mean))

# Mean schools 
df_Mean_mex <- df_Mean %>% select(school_name, 
chronic_absenteeism,
percent_ela_proficiency,
percent_math_proficiency,
percent_science_proficiency)
# Data Source: Hispanic/Latino District Total, 
#https://www.illinoisreportcard.com/District.aspx?source=trends&source2=proficiency&Districtid=15016299025 #https://www.illinoisreportcard.com/District.aspx?source=studentcharacteristics&source2=chronicabsenteeism&Districtid=15016299025

# Create a data frame
df_latino_state <- data.frame(
  school_name = "Total CPS Hispanic or Latino Students",
  chronic_absenteeism = 40.3,
  percent_ela_proficiency = 21.2,
  percent_math_proficiency = 13.6,
  percent_science_proficiency = 35.6
)

df_white_state <- data.frame(
  school_name = "Total CPS White Students",
  chronic_absenteeism = 27.1,
  percent_ela_proficiency = 54.3,
  percent_math_proficiency = 48.4,
  percent_science_proficiency = 65.0
)

df_black_state <- data.frame(
  school_name = "Total CPS Black Students",
  chronic_absenteeism = 45.8,
  percent_ela_proficiency = 16.5,
  percent_math_proficiency = 8.1,
  percent_science_proficiency = 24.4
)
# for Asian, AIAN, NHPI, Two or more
df_other_state <- data.frame(
  school_name = "Total CPS Other (non-Hispanic or Latino) Students",
  chronic_absenteeism = as.numeric(format((21.2 + 41 + 35.4 + 30.1) / 4, nsmall = 1)),
  percent_ela_proficiency = as.numeric(format((54.7 + 31.2 + 51.1 + 53.9) / 4, nsmall = 1)),
  percent_math_proficiency = as.numeric(format((53.5 + 23.9 + 40.7 + 45.7) / 4, nsmall = 1)),
  percent_science_proficiency = as.numeric(format((68.8 + 37.6 + 60 + 61.7) / 4, nsmall = 1))
)


df_state_avgs <- rbind(df_latino_state, df_white_state, df_black_state, df_other_state)  %>%
 mutate(
    chronic_absenteeism = paste0(format(round(chronic_absenteeism, 1), nsmall = 1), "%"),
    percent_ela_proficiency = paste0(format(round(percent_ela_proficiency, 1), nsmall = 1), "%"),
    percent_math_proficiency = paste0(format(round(percent_math_proficiency, 1), nsmall = 1), "%"),
    percent_science_proficiency = paste0(format(round(percent_science_proficiency, 1), nsmall = 1), "%")
)


df_final <- rbind(df_Mean_mex, df_state_avgs)
```


```{r}
# visuals
table_2b <-df_final  %>% select(school_name, percent_ela_proficiency, percent_math_proficiency, percent_science_proficiency) %>% 


 
   # using kable 
  
  kbl(
  , booktabs = TRUE,
  col.names = c("", "Percent", "Percent", "Percent"),
  align = c("l", rep("c", 3)),
  caption = "Hispanic or Latino Performance in CPS Elementary Schools: Top 4 Mexican Communities vs. City-Wide Mean (2023)",
  format.args = list(big.mark = ","),
  linesep = ""
) %>%
  kable_classic(
    full_width = FALSE,
    font_size = 8,
    html_font = "Arial",
    position = "center",
    latex_options = "HOLD_position"
  ) %>%
  column_spec(1, width = "14.8em") %>%
  column_spec(2:4, width = "8.4em") %>%
  add_header_above(
    align = c("l", rep("c", 3)),
    c(
      "Aggregation", 
      "Mean ELA Proficiency" = 1, 
      "Mean Math Proficiency" = 1, 
      "Mean Science Proficiency" = 1),
    bold = TRUE, 
    font_size = 8
  ) %>%
  
  add_footnote(c("Sample size: 31 Chicago Public Schools Elementary Schools in Gage Park, East Side, West Lawn, and South Lawndale.", "State proficiency assessments in English Language Arts, Math, and Science.",     "Source: Illinois Report Card (2023). Tabulations by Great Cities Institute"))

table_2b

```


## 2.C: Chronic Absenteeism of Schools in Mexican Community Areas compared to City-Wide Mean

```{r}
# visuals
table_2c <-df_final  %>% select(school_name, chronic_absenteeism) %>% 


 
   # using kable 
  
  kbl(
  , booktabs = TRUE,
  col.names = c("", "Percent"),
  align = c("l", rep("c", 3)),
  caption = "Hispanic or Latino Chronic Absenteeism in CPS Elementary Schools: Top 4 Mexican Communities vs. City Mean (2023)",
  format.args = list(big.mark = ","),
  linesep = ""
) %>%
  kable_classic(
    full_width = FALSE,
    font_size = 8,
    html_font = "Arial",
    position = "center",
    latex_options = "HOLD_position"
  ) %>%
  column_spec(1, width = "14.8em") %>%
  column_spec(2, width = "25.2em") %>%
  add_header_above(
    align = c("l", rep("c", 2)),
    c(
      "Aggregation", 
      "Mean Chronic Absenteeism" = 1),
    bold = TRUE, 
    font_size = 8
  ) %>%
  
   add_footnote(c("Sample size: 31 CPS Elementary Schools in Gage Park, East Side, West Lawn, and South Lawndale.", "Chronic Absenteeism is defined as students who miss 10% or more of school days per year.",   "Source: Illinois Report Card (2023). Tabulations by Great Cities Institute"))

table_2c

```







## 2.D: Percentage of Limited English Proficient


```{r}

# analysis

data_chi_2018_22 <- usa_data %>%  filter(year == 2022) %>% select(year:gqtyped, perwt, hispan, race, race_ethnicity, school, speakeng)

# Percentage of Limited English Proficient. 

# Step 1: Define Survey Design
survey_design <- data_chi_2018_22 %>%
  as_survey_design(weights = perwt)

# Step 2: Group by race_ethnicity and calculate weighted counts and totals
lep_rate_by_ethnicity <- survey_design %>%
  group_by(race_ethnicity) %>%
  summarise(
    lep_count = survey_total(speakeng %in% c(1, 6)),
    total_count = survey_total(),
    lep_percentage = 100 * survey_mean(speakeng %in% c(1, 6), vartype = "se")
  ) %>%
  mutate(lep_percentage = paste0(format(round(lep_percentage, 1), nsmall = 1), "%"))



```


```{r}
# visual



table_2d <- lep_rate_by_ethnicity %>% select(race_ethnicity, lep_count, lep_percentage) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Number", "Percent"),
      align = c("l",rep("c",2)),
      caption = "Number and percentages of Mexican population with limited English proficiency, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "12.9em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%
   add_footnote(c("English Proficiency is defined as respondents who does not speak English or speaks English poorly.
                  ",   "Source: IPUMS-USA database (2018-2022 American Community Survey 5-Year Estimates). Tabulations by Great Cities Institute"))


table_2d

```

## 2.E: Number and Percentages of Mexican non-citizens enrolled in public schools

```{r}
# analysis


# Step 1: Filter for individuals enrolled in school
enrolled_in_school <- usa_data  %>%  filter(year == 2022) %>%
  filter(school == 2)


# Step 2: Filter for non-citizen individuals enrolled in public schools
enrolled_in_public_schools <- enrolled_in_school %>%
  filter(schltype == 2 & citizen == 3)
  
# Step 3: Create survey design
  
survey_design_school <- enrolled_in_school %>%
  as_survey_design(weights = perwt)
  
survey_design_public_schools <- enrolled_in_public_schools %>%
  as_survey_design(weights = perwt)


# Step 4: Calculate denominator (total count enrolled in school) for each subgroup
denominator_counts <- survey_design_school %>%
  group_by(race_ethnicity) %>%
  summarise(num_enrolled_all_school = survey_total()) 
  
  
  
# Step 5: Calculate numerator (count of public school enrollment) for each subgroup
numerator_counts <- survey_design_public_schools %>%
  group_by(race_ethnicity) %>%
  summarise(num_enrolled_public = survey_total())
  
  
# Step 6: Calculate percentages and estimate SEs

percentages <- numerator_counts %>%
  left_join(denominator_counts, by = "race_ethnicity") %>%
  mutate(percentage = 100 * num_enrolled_public / num_enrolled_all_school) %>%
  mutate(percentage = paste0(format(round(percentage, 1), nsmall = 1), "%"))


  


```


```{r}
# visual

table_2e <- percentages %>% select(race_ethnicity, num_enrolled_public, percentage) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Number", "Percent"),
      align = c("l",rep("c",2)),
      caption = "Number and percentages of Mexican non-citizens enrolled in public schools, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "12.9em") %>%  
row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%
  footnote(general = "Source: IPUMS-USA database (2018-2022 American Community Survey 5-Year Estimates). Tabulations by Great Cities Institute",
           general_title = "")   

table_2e

```


## 2.F: Number and Percentages of Mexican 21-24 years old without a high school diploma


```{r}


df <- usa_data  %>%  filter(year == 2022) %>% select(race_ethnicity, schltype, school, gradeatt, perwt, educ, age) 


# Create a survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)


# method: Look at 21-24 year olds without a high school diploma out of all 21-24 year olds


# Calculate numerator: weighted count of students aged 21-24 not in school and without a high school diploma
numerator_not_in_school <- survey_design %>%
  filter(age >= 21, age <= 24, school == 1, educ %in% c("0", "1", "2", "3", "4", "5")) %>%
  group_by(race_ethnicity) %>%
  summarise(not_in_school = survey_total(vartype = "se"))

# Calculate denominator: weighted count of total students aged 21-24
denominator_total_students <- survey_design %>%
  filter(age >= 21, age <= 24) %>%
  group_by(race_ethnicity) %>%
  summarise(total_students = survey_total(vartype = "se"))

  
# Calculate dropout rate by joining numerator and denominator
dropout_data <- numerator_not_in_school %>%
  inner_join(denominator_total_students, by = "race_ethnicity") %>%
  mutate(dropout_rate = (not_in_school / total_students) * 100) %>%
  mutate(dropout_rate = paste0(format(round(dropout_rate, 1), nsmall = 1), "%"))


```


```{r}
# visual


table_2f <- dropout_data %>% select(race_ethnicity, not_in_school, dropout_rate) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Number", "Percent"),
      align = c("l",rep("c",2)),
      caption = "Number and percentages of Mexican people aged 21-24 years old without a high school diploma, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "12.9em") %>%  
  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022 American Community Survey 5-Year Estimates). Tabulations by Great Cities Institute",
           general_title = "")   

table_2f

```


## 2.G: Number and Percentage of Mexican students attending undergraduate/graduate colleges or professional schools

```{r}

## select variables
df <- usa_data  %>%  filter(year == 2022) %>% select(race_ethnicity, school, gradeatt, perwt, educ, age)


# Create survey design object
survey_design <-df %>%
  as_survey_design(weights = perwt)

# Number and percentage of Mexican students attending area colleges

# 18-24 year olds


# Group by race_ethnicity, filter for enrolled in college/grad school and ages 18-24
numerator_18_24 <- survey_design %>%  filter(school == 2, gradeatt %in% c(6, 7), age >= 18, age <= 24) %>% 
  group_by(race_ethnicity) %>%
  summarise(college_attendees = survey_total(vartype = "se"))


# denominator calculate total number of 18-24 year olds
denominator_18_24 <- survey_design %>% filter(age >= 18, age <= 24) %>%
  group_by(race_ethnicity) %>%
  summarise(total_students = survey_total(vartype = "se"))


# Calculate percentage of students attending college within each racial and ethnic group
college_attendance_18_24 <- left_join(numerator_18_24, denominator_18_24, by = "race_ethnicity") %>%
  mutate(percentage_college_students = (college_attendees / total_students) * 100) %>% mutate(age = "18_24", percentage_college_students = paste0(format(round(percentage_college_students, 1), nsmall = 1), "%"))




# 25-34 year olds

# Group by race_ethnicity, filter for enrolled in college/grad school and ages 18-24
numerator_25_34 <- survey_design %>%  filter(school == 2, gradeatt %in% c(6, 7), age >= 25, age <= 34) %>% 
  group_by(race_ethnicity) %>%
  summarise(college_attendees = survey_total(vartype = "se"))


# denominator calculate total number of 18-24 year olds
denominator_25_34 <- survey_design %>% filter(age >= 25, age <= 34) %>%
  group_by(race_ethnicity) %>%
  summarise(total_students = survey_total(vartype = "se"))


# Calculate percentage of students attending college within each racial and ethnic group
college_attendance_25_34 <- left_join(numerator_25_34, denominator_25_34, by = "race_ethnicity") %>%
  mutate(percentage_college_students = (college_attendees / total_students) * 100) %>% mutate(age = "25_34", percentage_college_students = paste0(format(round(percentage_college_students, 1), nsmall = 1), "%"))


# combine

df_college <- rbind(college_attendance_18_24, college_attendance_25_34)

```



```{r}
table_2g <- df_college %>% pivot_wider(id_cols =  c(race_ethnicity), names_from = "age", values_from = c(college_attendees, percentage_college_students)) %>% select(race_ethnicity,  college_attendees_18_24,  percentage_college_students_18_24,  college_attendees_25_34,  percentage_college_students_25_34) %>%
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("", "Number", "Percent" , "Number", "Percent"),
      align = c("l",rep("c",4)),
      caption = "Number and Percentage of Mexican students attending undergraduate/graduate colleges or professional schools, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em")  %>%
  column_spec(2:5, width = "6.45em")  %>%
  add_header_above( align = c("l", "c", "c", "c", "c"), c("Race/Ethnicity", "Ages 18-24" = 2, "Ages 25-34" = 2),
                    # background = "#cbc9e2", 
                    bold = T, font_size =8) %>% 

  footnote(general = "Source: IPUMS-USA database (2018-2022 American Community Survey 5-Year Estimates). Tabulations by Great Cities Institute",
           general_title = "")   


table_2g

```




\blandscape

## 2.H: Educational Attainment of Mexicans 25 and Older

```{r}
df <- usa_data  %>%  filter(year == 2022) %>% select(race_ethnicity, educd, age, perwt)

# collapse educdational categories
df <- df %>%
  mutate(educd = as.character(educd)) %>%
  mutate(education_level = case_when(
    educd %in% c("1") ~ "NA",
    educd %in% c("2") ~ "No Schooling Completed",
    educd %in% c("11", "12", "14", "15", "16", "17", "22", "23", "25", "26", "30", "40", "50", "61") ~ "Less than High School",
    educd %in% c("63", "64") ~ "Regular High School Diploma, GED or Alternative Credential",
    educd %in% c("65", "71") ~ "Some College, No Degree", 
    educd %in% c("81") ~ "Associate's Degree",
    educd %in% c("101") ~ "Bachelor's Degree",
    educd %in% c("114", "115") ~ "Master's Degree or Professional Degree Beyond Bachelor's",
    TRUE ~ "Other"  # Default case if educd is not in the specified categories
  ))


# Create survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)

# Calculate numerator: weighted count of individuals by education level and race_ethnicity
numerator <- survey_design %>%
  filter(age >= 25) %>%
  group_by(race_ethnicity, education_level) %>%
  summarise(weighted_n = survey_total(vartype = "se"))

# Calculate denominator: total population by race_ethnicity
denominator <- survey_design %>%
  filter(age >= 25) %>%
  group_by(race_ethnicity) %>%
  summarise(total_pop = survey_total(vartype = "se"))

# Merge numerator and denominator by race_ethnicity
education_levels <- c("No Schooling Completed", "Less than High School", "Regular High School Diploma, GED or Alternative Credential","Some College, No Degree", "Associate's Degree", "Bachelor's Degree", "Master's Degree or Professional Degree Beyond Bachelor's")

education_rates <- numerator %>%
  left_join(denominator, by = "race_ethnicity") %>%
  mutate(educational_rate = (weighted_n / total_pop) * 100,
  education_level = factor(education_level, levels = education_levels))    %>%  arrange(race_ethnicity, education_level)  %>% mutate(educational_rate = paste0(format(round(educational_rate, 1), nsmall = 1), "%")) %>% filter(!is.na(education_level))
  
```



```{r}
table_2h <- education_rates %>% select(race_ethnicity, education_level, weighted_n, educational_rate)  %>% pivot_wider(id_cols =  c(education_level), names_from = "race_ethnicity", values_from = c(weighted_n, educational_rate))   %>% select(
    education_level, 
     "weighted_n_Mexican", "educational_rate_Mexican",
    'weighted_n_Other Latinos', 'educational_rate_Other Latinos', 
      'weighted_n_White (non-Hispanic or Latino)', 'educational_rate_White (non-Hispanic or Latino)',
      'weighted_n_Black (non-Hispanic or Latino)', 'educational_rate_Black (non-Hispanic or Latino)',
       'weighted_n_Other (non-Hispanic or Latino)',  'educational_rate_Other (non-Hispanic or Latino)'   
  ) %>%


 
   # using kable 
  
  kbl(
  , booktabs = TRUE,
  col.names = c("", "Number", "Percent", "Number", "Percent", "Number", "Percent", "Number", "Percent", "Number", "Percent"),
  align = c("l", rep("c", 10)),
  caption = "Educational Attainment of Mexicans 25 and Older, 2018-2022",
  format.args = list(big.mark = ","),
  linesep = ""
) %>%
  kable_classic(
    full_width = FALSE,
    font_size = 8,
    html_font = "Arial",
    position = "center",
    latex_options = "HOLD_position"
  ) %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:11, width = "2.58em") %>%
  add_header_above(
    align = c("l", rep("c", 2)),
    c(
      "Educational Level", 
      "Mexican" = 2, 
      "Other Latinos" = 2, 
      "White (non-Hispanic or Latino)" = 2, 
      "Black (non-Hispanic or Latino)" = 2, 
      "Other (non-Hispanic or Latino)" = 2
    ),
    bold = TRUE, 
    font_size = 8
  ) %>%
  footnote(
    general = "Source: IPUMS-USA database (2018-2022 American Community Survey 5-Year Estimates). Tabulations by Great Cities Institute",
    general_title = ""
  ) 
table_2h

```


\elandscape


\blandscape

## 2.I: Educational Attainment of Mexicans by nativity

```{r}
df <- usa_data  %>%  filter(year == 2022) %>% select(mex_foreign_born, educd, age, perwt) %>% filter(!is.na(mex_foreign_born))

# collapse educdational categories
df <- df %>%
  mutate(educd = as.character(educd)) %>%
  mutate(education_level = case_when(
    educd %in% c("1") ~ "NA",
    educd %in% c("2") ~ "No Schooling Completed",
    educd %in% c("11", "12", "14", "15", "16", "17", "22", "23", "25", "26", "30", "40", "50", "61") ~ "Less than High School",
    educd %in% c("63", "64") ~ "Regular High School Diploma, GED or Alternative Credential",
    educd %in% c("65", "71") ~ "Some College, No Degree", 
    educd %in% c("81") ~ "Associate's Degree",
    educd %in% c("101") ~ "Bachelor's Degree",
    educd %in% c("114", "115") ~ "Master's Degree or Professional Degree Beyond Bachelor's",
    TRUE ~ "Other"  # Default case if educd is not in the specified categories
  ))


# Create survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)

# Calculate numerator: weighted count of individuals by education level and mex_foreign_born
numerator <- survey_design %>%
  filter(age >= 25) %>%
  group_by(mex_foreign_born, education_level) %>%
  summarise(weighted_n = survey_total(vartype = "se"))

# Calculate denominator: total population by mex_foreign_born
denominator <- survey_design %>%
  filter(age >= 25) %>%
  group_by(mex_foreign_born) %>%
  summarise(total_pop = survey_total(vartype = "se"))

# Merge numerator and denominator by mex_foreign_born
education_levels <- c("No Schooling Completed", "Less than High School", "Regular High School Diploma, GED or Alternative Credential","Some College, No Degree", "Associate's Degree", "Bachelor's Degree", "Master's Degree or Professional Degree Beyond Bachelor's")

education_rates <- numerator %>%
  left_join(denominator, by = "mex_foreign_born") %>%
  mutate(educational_rate = (weighted_n / total_pop) * 100,
  education_level = factor(education_level, levels = education_levels))    %>%  arrange(mex_foreign_born, education_level)  %>% mutate(educational_rate = paste0(format(round(educational_rate, 1), nsmall = 1), "%")) %>% filter(!is.na(education_level))
  
```



```{r}
table_2i <- education_rates %>% select(mex_foreign_born, education_level, weighted_n, educational_rate)  %>% pivot_wider(id_cols =  c(education_level), names_from = "mex_foreign_born", values_from = c(weighted_n, educational_rate))   %>% select(
    education_level, 
    "weighted_n_Mexico Born",    "educational_rate_Mexico Born",
    "weighted_n_U.S. Born",   "educational_rate_U.S. Born"
  ) %>%


 
   # using kable 
  
  kbl(
  , booktabs = TRUE,
  col.names = c("", "Number", "Percent", "Number", "Percent"),
  align = c("l", rep("c", 4)),
  caption = "Educational Attainment of Mexicans 25 and Older by Nativity, 2018-2022",
  format.args = list(big.mark = ","),
  linesep = ""
) %>%
  kable_classic(
    full_width = FALSE,
    font_size = 8,
    html_font = "Arial",
    position = "center",
    latex_options = "HOLD_position"
  ) %>%
  column_spec(1, width = "14.8em") %>%
  column_spec(2:5, width = "6.3em") %>%
   add_header_above(
    align = c("l", rep("c", 2)),
    c(
      "Educational Level", 
      "Mexicans Born in Mexico" = 2, 
      "Mexicans born in the U.S." = 2
    ),
    bold = TRUE, 
    font_size = 8
  ) %>%
  footnote(
    general = "Source: IPUMS-USA database (2018-2022 American Community Survey 5-Year Estimates). Tabulations by Great Cities Institute",
    general_title = ""
  ) 
table_2i

```


\elandscape






