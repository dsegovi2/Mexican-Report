---
title: "Mexican Report"
author: "Demographic"
date: "Great Cities Institute"
output: 
  pdf_document:
    latex_engine: xelatex
    toc: true
    highlight: pygments
    extra_dependencies: ["float"]
    fig_caption: true
mainfont: "Arial"
header-includes: 
  - \usepackage{caption} 
  - \usepackage{booktabs} 
  - \usepackage{longtable}
  - \usepackage{threeparttablex} 
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
editor_options: 
  chunk_output_type: console
---




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, fig.pos="H")


```


\renewcommand{\arraystretch}{1.4}
\clearpage

```{r}

library(ipumsr)
library(tidyverse)
library(purrr)
library(sf)
library(tidycensus)
library(tidyr)
library(readxl)
library(sf)
library(htmltools)
library(leaflet)
library(janitor)
library(data.table)
library(tinytex)
library(survey) # for survey analysis
library(srvyr)  # for tidy survey analysis
library(tmap)
library("kableExtra") 
library(tmaptools)
library("RColorBrewer") 
# library(OpenStreetMap)
# remotes::install_github('yihui/knitr')
# install.packages("knitr")
# library(knitr)
# options(tinytex.verbose = TRUE)
# tinytex::reinstall_tinytex()
# install.packages('tinytex')

# update.packages(ask = FALSE, checkBuilt = TRUE)
# tinytex::tlmgr_update()
# tinytex::latexmk("demographic_visual.tex")
options(knitr.kable.NA = '-')
 
##### Chicago boarder
Chicago_boundary_shp <- read_sf("C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/Boundaries_Chicago/geo_export_8881adc5-2460-457b-892f-04f4d6028b72.shp") %>% 
  st_transform(crs = 4326)
# mapview(community_shp)
color_race_ethnicity <- c("Mexican" = "#CE1126", "Other Hispanics or Latinos" = "#F9AA51",
                               "White (non-Hispanic or Latino)" = "#9CA168",
                               "Black (non-Hispanic or Latino)" = "#8CBEC0",
                               "Other (non-Hispanic or Latino)" = "#0B8489")
color_hispan_breakdown <- c(
  "Mexican" = "#CE1126", 
  "Puerto Rican" = "#32C2DC", 
  "Ecuadorian" =  "#A9AD72",
  "Cuban" = "#AB6E29", 
  "Guatemalan" =  "#D3A668",
  "Colombian" = "#F9C93C"
)

theme_plots <-
  theme_minimal() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_line(color="#969696", linewidth = 1),
        plot.title = element_text(face ="bold", size = 10, hjust = 0.5),
      plot.subtitle = element_text(face ="italic", size = 8, color = "#636363"),
      axis.text = element_text(size = 9),
      axis.title = element_text(face ="bold", size = 9),
      plot.caption = element_text(hjust = 0, size = 8, color = "black"),
      legend.text = element_text(size = 8, color = "#636363"),
      legend.title = element_text(face = "bold", size = 8, color = "#636363"))
```


\renewcommand{\arraystretch}{1.4}
\clearpage


```{r}

# Read Data

usa_data <- read.csv("C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/final_Mexican_IL_2000_22.csv") %>% 
  mutate(race_ethnicity = case_when(hispan ==0 & race == 1 ~ "White (non-Hispanic or Latino)",
                                    hispan ==0 & race == 2 ~ "Black (non-Hispanic or Latino)",
                                    hispan %in% c(2,3,4) ~ "Other Hispanics or Latinos",
                                    hispan ==1 ~ "Mexican", 
                                    hispan ==0 & race %in%c(3:9) ~ "Other (non-Hispanic or Latino)",
                                    TRUE ~ NA_character_),
         
  race_ethnicity = factor(race_ethnicity, level = c("Mexican", "Other Hispanics or Latinos","White (non-Hispanic or Latino)", "Black (non-Hispanic or Latino)",  "Other (non-Hispanic or Latino)")),
  
  hispan_breakdown = case_when(
  hispand == 0 ~ "Not Hispanic",
  hispand == 100 ~ "Mexican", 
  hispand == 200 ~ "Puerto Rican",
  hispand == 300 ~ "Cuban",
  hispand == 411 ~ "Costa Rican",
  hispand == 412 ~ "Guatemalan",
  hispand == 413 ~ "Honduran",
  hispand == 414 ~ "Nicaraguan",
  hispand == 415 ~ "Panamanian",
  hispand == 416 ~ "Salvadoran",
  hispand == 417 ~ "Central American, not specified",
  hispand == 420 ~ "Argentinean",
  hispand == 421 ~ "Bolivian",
  hispand == 422 ~ "Chilean",
  hispand == 423 ~ "Colombian",
  hispand == 424 ~ "Ecuadorian",
  hispand == 425 ~ "Paraguayan",
  hispand == 426 ~ "Peruvian",
  hispand == 427 ~ "Uruguayan",
  hispand == 428 ~ "Venezuelan",
  hispand == 431 ~ "South American, not specified",
  hispand == 450 ~ "Spaniard",
  hispand == 460 ~ "Dominican",
  hispand == 498 ~ "Other, not specified",
  TRUE ~ "Other"
),
mex_foreign_born = case_when(
    race_ethnicity == "Mexican" & bpl %in% as.character(1:56) ~ "U.S. Born",
    race_ethnicity == "Mexican" & bpl == "200" ~ "Mexico Born",
    TRUE ~ NA_character_  # Optional: default case for other values or groups
  )) %>% ## filter for hispanic groups here ##
 mutate(hispan_breakdown = factor(hispan_breakdown, level = c("Mexican", "Puerto Rican","Ecuadorian", "Cuban", "Guatemalan", "Colombian"))
  )

# Chicago ca populationd data
chicago_ca_pop <- read_sf("Data Tables/shp/comm_pop_chi_2022.shp") %>% as.data.frame()


theme_plots <-
  theme_minimal() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_line(color="#969696", linewidth = 1),
        plot.title = element_text(face ="bold", size = 10, hjust = 0.5),
      plot.subtitle = element_text(face ="italic", size = 8, color = "#636363"),
      axis.text = element_text(size = 9),
      axis.title = element_text(face ="bold", size = 9),
      plot.caption = element_text(hjust = 0, size = 8, color = "black"),
      legend.text = element_text(size = 8, color = "#636363"),
      legend.title = element_text(face = "bold", size = 8, color = "#636363"))



```


 

# Demographic



## 1B(1): Population by Age for Mexicans and Other Racial/Ethnic Groups in Chicago, 2018-2022 (ACS 5-year Estimates) 

```{r}
# analysis

# filter for year 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)

# 1B: Population pyramid of the percentage of Mexican population by age group compared to the rest of the population in Chicago and median age in Chicago (Data source: 2018-2022 ACS data)

df <-  data_chi_2018_22 %>%
  mutate(
    age_group = case_when(
      age < 20 ~ "Young (0-19)",
      age >= 20 & age < 40 ~ "Adults (20-39)",
      age >= 40 & age < 60 ~ "Middle-aged (40-59)",
      age >= 60 & age < 80 ~ "Older Adults (60-79)",
      age >= 80 ~ "Elderly (80+)"
    )
  )
# Create survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)


# Calculate weighted population counts by age group and ethnicity

# Calculate weighted population by ethnicity and age group
pop_pyramid <- df %>%
  as_survey_design(weights = perwt) %>% 
  survey_count(race_ethnicity, age_group, name="total_weighted_count")  %>%
  group_by(race_ethnicity) %>%
  mutate(total_weighted_percentage = total_weighted_count / sum(total_weighted_count) * 100,
         total_weighted_percentage  = paste0(format(round(total_weighted_percentage, 1), nsmall = 1), "%"))



# get median age

weighted_age  <- df %>%
  group_by(race_ethnicity) %>%
  summarize(
    weighted_age = matrixStats::weightedMedian(age, perwt)
  ) 



# combined

df_final  <- pop_pyramid %>% left_join(weighted_age)

```




```{r}
# visual

table_1b.1 <- df_final %>% 
  mutate(age_group = factor(age_group, levels = c("Young (0-19)", "Adults (20-39)", "Middle-aged (40-59)", "Older Adults (60-79)", "Elderly (80+)"))) %>% 
  arrange(age_group) %>%  # Explicitly arrange by factor levels
  pivot_wider(id_cols = c("age_group"), names_from = race_ethnicity, values_from = c("total_weighted_count", "total_weighted_percentage"))  %>% 
  select(age_group, 
         total_weighted_count_Mexican, total_weighted_percentage_Mexican,
         'total_weighted_count_Other Hispanics or Latinos', 'total_weighted_percentage_Other Hispanics or Latinos',
         'total_weighted_count_White (non-Hispanic or Latino)', 'total_weighted_percentage_White (non-Hispanic or Latino)',
         'total_weighted_count_Black (non-Hispanic or Latino)', 'total_weighted_percentage_Black (non-Hispanic or Latino)',
         'total_weighted_count_Other (non-Hispanic or Latino)', 'total_weighted_percentage_Other (non-Hispanic or Latino)') %>%
  
  # using kable 
  kbl(booktabs = T,
      col.names = c("", "Number", "Percent", "Number", "Percent", "Number", "Percent", "Number", "Percent", "Number", "Percent"),
      align = c("l", rep("r", 10)),  # Align headers and columns
      caption = "Population by Age for Mexicans and Other Racial/Ethnic Groups in Chicago, 2018-2022 (ACS 5-year Estimates)",
      format.args = list(big.mark = ","),
      linesep = "") %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "10em") %>%
  column_spec(2:11, width = "3em") %>%  # Align all columns with numbers and percentages to the right
  row_spec(0, align = "C") %>%  # Center column headers
 add_header_above(
  align = c("l", rep("c", 5)),  # Assuming 1 for Age Group and 10 divided into 5 groups
  c("Age Group", "Mexican" = 2, "Other Hispanics\n or Latinos" = 2, "White\n (non-Hispanic\n or Latino)" = 2, "Black\n (non-Hispanic\n or Latino)" = 2, "Other\n (non-Hispanic\n or Latino)" = 2),
  bold = TRUE, font_size = 8
) %>% 
  add_footnote(
    c("\\footnotesize{Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2018-2022 American Community Survey 5-year Estimates). Tabulations by Great Cities Institute.}"),
    notation = "none",
    threeparttable = TRUE,
    escape = FALSE
  )
table_1b.1 
```




```{r fig.width=5, fig.height=4.5 ,fig.align='center'}
# visual

# Pivot data to long format and clean age_group names
df_long <- df_final %>%
  pivot_wider(id_cols = c("race_ethnicity"), 
              names_from = age_group, 
              values_from = c("total_weighted_count", "total_weighted_percentage")) %>% 
  select(race_ethnicity, 
         'total_weighted_percentage_Young (0-19)',
         'total_weighted_percentage_Adults (20-39)',
         'total_weighted_percentage_Middle-aged (40-59)',
         'total_weighted_percentage_Older Adults (60-79)',
         'total_weighted_percentage_Elderly (80+)') %>%
  pivot_longer(cols = starts_with("total_weighted_percentage_"), 
               names_to = "age_group", 
               values_to = "percentage") %>%
  mutate(age_group = gsub("total_weighted_percentage_", "", age_group),
         percentage = as.numeric(gsub("%", "", percentage))) # Convert percentage to numeric

# Reverse the order of age groups
df_long <- df_long %>%
  mutate(age_group = factor(age_group, 
                            levels = c("Young (0-19)", "Adults (20-39)", "Middle-aged (40-59)", "Older Adults (60-79)", "Elderly (80+)")))

# Define the custom colors for race_ethnicity
color_race_ethnicity <- c("Mexican" = "#CE1126", "Other Hispanics or Latinos" = "#F9AA51",
                               "White (non-Hispanic or Latino)" = "#9CA168",
                               "Black (non-Hispanic or Latino)" = "#8CBEC0",
                               "Other (non-Hispanic or Latino)" = "#0B8489")

# Create the bar chart with percentage labels
# Create the bar chart with percentage labels
ggplot(df_long, aes(x = age_group, y = percentage, fill = race_ethnicity)) +
  geom_bar(stat = "identity", position = "dodge") +
    geom_text(aes(label = sprintf("%.1f%%", percentage)), 
            position = position_dodge(width = 0.9), 
            vjust = -1, 
            size = 2.2, 
            fontface = "bold") +
  labs(title = "Population by Age for Mexicans and Other\nRacial/Ethnic Groups in Chicago, 2018-2022 (ACS 5-year Estimates) ", 
       caption = "Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2018-2022 American\nCommunity Survey 5-year Estimates). Tabulations by Great Cities Institute.", fill = ''
) + 
  scale_y_continuous(limits = c(0, 50),breaks = seq(0, 50, by = 50)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12))+
  theme_minimal() +
  scale_fill_manual(values = color_race_ethnicity, name = "") +
  theme_plots +
 theme(axis.text.x = element_text(angle = 45, hjust = 1)) + theme_plots +   theme(axis.text.x = element_text(size = 8),
        panel.background = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
         axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        legend.key.size = unit(0.5, "lines"),
        legend.position = "bottom",
        legend.text = element_text(size = 7, color = "#636363"), # Increase margins to fit legend
        plot.caption = element_text(size = 8))  + 
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) # Distribute legend items across 2 rows

```





## 1B(2) Population by Age for Hispanic or Latino Groups in Chicago, 2018-2022 (ACS 5-year Estimates)

```{r}
# analysis

# filter for year 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)

# 1B: Population pyramid of the percentage of Mexican population by age group compared to the rest of the population in Chicago and median age in Chicago (Data source: 2018-2022 ACS data)

df <-  data_chi_2018_22 %>%
  mutate(
    age_group = case_when(
      age < 20 ~ "Young (0-19)",
      age >= 20 & age < 40 ~ "Adults (20-39)",
      age >= 40 & age < 60 ~ "Middle-aged (40-59)",
      age >= 60 & age < 80 ~ "Older Adults (60-79)",
      age >= 80 ~ "Elderly (80+)"
    )
  )
# Create survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)


# Calculate weighted population counts by age group and ethnicity

# Calculate weighted population by ethnicity and age group
pop_pyramid <- df %>%
  as_survey_design(weights = perwt) %>% 
  survey_count(hispan_breakdown, age_group, name="total_weighted_count")  %>%
  group_by(hispan_breakdown) %>%
  mutate(total_weighted_percentage = total_weighted_count / sum(total_weighted_count) * 100,
         total_weighted_percentage  = paste0(format(round(total_weighted_percentage, 1), nsmall = 1), "%"))




# get median age

weighted_age  <- df %>%
  group_by(hispan_breakdown) %>%
  summarize(
    weighted_age = matrixStats::weightedMedian(age, perwt)
  ) 



# combined

df_final  <- pop_pyramid %>% left_join(weighted_age) %>%   mutate(across(where(is.numeric), ~replace(., is.na(.), 0))) %>%
  mutate(across(where(~ !is.numeric(.)), ~replace(., is.na(.), "Missing Data"))) %>%
  filter(!is.na(hispan_breakdown))
```

```{r}
# visual

table_1b.2 <-  df_final %>%
  mutate(age_group = factor(age_group, levels = c("Young (0-19)", "Adults (20-39)", "Middle-aged (40-59)", "Older Adults (60-79)", "Elderly (80+)"))) %>%
  arrange(age_group) %>%  # Explicitly arrange by factor levels
  pivot_wider(id_cols = c("age_group"), names_from = hispan_breakdown, values_from = c("total_weighted_count", "total_weighted_percentage")) %>%
  select(age_group,
         total_weighted_count_Mexican, total_weighted_percentage_Mexican,
         'total_weighted_count_Puerto Rican', 'total_weighted_percentage_Puerto Rican',
         total_weighted_count_Ecuadorian, total_weighted_percentage_Ecuadorian,
         total_weighted_count_Cuban, total_weighted_percentage_Cuban,
         total_weighted_count_Guatemalan, total_weighted_percentage_Guatemalan,
         total_weighted_count_Colombian, total_weighted_percentage_Colombian) %>%

  # using kable
  kbl(, booktabs = T,
      col.names = c("", "Number", "Percent" , "Number", "Percent", "Number", "Percent", "Number", "Percent", "Number", "Percent", "Number", "Percent"),
      align = c("l", rep("r", 12)),
      caption = "Population by Age for Hispanic or Latino Groups in Chicago, 2018-2022 (ACS 5-year Estimates)",
     format.args = list(big.mark = ","),
      linesep = "") %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "10em") %>%
  column_spec(2:13, width = "2.5em") %>%
   row_spec(0, align = "C", font_size = 7.5) %>%  # Center column headers
  add_header_above(align = c("l", rep("c", 6)),
                   c("Age Group", "Mexican" = 2, "Puerto Rican" = 2, "Ecuadorian" = 2, "Cuban" = 2, "Guatemalan" = 2, "Colombian" = 2),
                   bold = T, font_size = 7.5) %>%
  add_footnote(
  c("\\footnotesize{Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2018-2022 American Community Survey 5-year Estimates). Tabulations by Great Cities Institute.}"),
  notation = "none",
  threeparttable = TRUE,
  escape = FALSE
)

table_1b.2
```


```{r fig.width=5, fig.height=4.5 ,fig.align='center'}
# visual

# Pivot data to long format and clean age_group names
df_long <- df_final %>%
  pivot_wider(id_cols = c("hispan_breakdown"), 
              names_from = age_group, 
              values_from = c("total_weighted_count", "total_weighted_percentage")) %>% 
  select(hispan_breakdown, 
         'total_weighted_percentage_Young (0-19)',
         'total_weighted_percentage_Adults (20-39)',
         'total_weighted_percentage_Middle-aged (40-59)',
         'total_weighted_percentage_Older Adults (60-79)',
         'total_weighted_percentage_Elderly (80+)') %>%
  pivot_longer(cols = starts_with("total_weighted_percentage_"), 
               names_to = "age_group", 
               values_to = "percentage") %>%
  mutate(age_group = gsub("total_weighted_percentage_", "", age_group),
         percentage = as.numeric(gsub("%", "", percentage))) # Convert percentage to numeric

# Reverse the order of age groups
df_long <- df_long %>%
  mutate(age_group = factor(age_group, 
                            levels = c("Young (0-19)", "Adults (20-39)", "Middle-aged (40-59)", "Older Adults (60-79)", "Elderly (80+)")))

# Define the custom colors for race_ethnicity
color_hispan_breakdown <- c(
  "Mexican" = "#CE1126", 
  "Puerto Rican" = "#32C2DC", 
  "Ecuadorian" =  "#A9AD72",
  "Cuban" = "#AB6E29", 
  "Guatemalan" =  "#D3A668",
  "Colombian" = "#F9C93C"
)

# Create the bar chart with percentage labels
ggplot(df_long, aes(x = age_group, y = percentage, fill = hispan_breakdown)) +
  geom_bar(stat = "identity", position = "dodge") +
   geom_text(aes(label = sprintf("%.1f%%", percentage)), 
            position = position_dodge(width = 0.9), 
            vjust = -1, 
            size = 2.2, 
            fontface = "bold") +
  labs(title = "Population by Age for Hispanic or Latino Groups in Chicago,\n2018-2022 (ACS 5-year Estimates)", 
      caption = "Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2018-2022 American Community Survey 5-year\n Estimates). Tabulations by Great Cities Institute.", fill = ''
)  +
  scale_y_continuous(limits = c(0, 50),breaks = seq(0, 50, by = 50)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12))+
  theme_minimal() +
  scale_fill_manual(values = color_hispan_breakdown) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + theme_plots +   theme(axis.text.x = element_text(size = 8),
        panel.background = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
         axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        legend.key.size = unit(0.5, "lines"),
        legend.position = "bottom",
          legend.text = element_text(size = 7, color = "#636363"), # Increase margins to fit legend
        plot.caption = element_text(size = 8))  + 
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) # Distribute legend items across 2 rows
```



## 1B(3): Median Age for Mexicans and Other Racial/Ethnic Groups in Chicago, 2018-2022 (ACS 5-year Estimates)

```{r}
# analysis

# filter for year 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)

# 1B: Population pyramid of the percentage of Mexican population by age group compared to the rest of the population in Chicago and median age in Chicago (Data source: 2018-2022 ACS data)

df <-  data_chi_2018_22 %>%
  mutate(
    age_group = case_when(
      age < 20 ~ "Young (0-19)",
      age >= 20 & age < 40 ~ "Young Adults (20-39)",
      age >= 40 & age < 60 ~ "Middle-aged (40-59)",
      age >= 60 & age < 80 ~ "Older Adults (60-79)",
      age >= 80 ~ "Elderly (80+)"
    )
  )
# Create survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)


# Calculate weighted population counts by age group and ethnicity

# Calculate weighted population by ethnicity and age group
pop_pyramid <- df %>%
  as_survey_design(weights = perwt) %>% 
  survey_count(race_ethnicity, age_group, name="total_weighted_count")  %>%
  group_by(race_ethnicity) %>%
  mutate(total_weighted_percentage = total_weighted_count / sum(total_weighted_count) * 100,
         total_weighted_percentage  = paste0(format(round(total_weighted_percentage, 1), nsmall = 1), "%"))




# get median age

weighted_age  <- df %>%
  group_by(race_ethnicity) %>%
  summarize(
    weighted_age = matrixStats::weightedMedian(age, perwt)
  ) 



# combined

df_final  <- pop_pyramid %>% left_join(weighted_age)
```


```{r}
# visuals
# visuals

table_1b.3 <- weighted_age  %>% select(race_ethnicity, weighted_age) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
       col.names = c("Race/Ethnicity", "Median Age"),
      align = c("l",rep("r",1)),
      caption = "Median Age for Mexicans and Other Racial/Ethnic Groups in Chicago, 2018-2022 (ACS 5-year Estimates)",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2, width = "15.8em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%
add_footnote(
  c("\\footnotesize{Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2018-2022 American Community Survey 5-year Estimates). Tabulations by Great Cities Institute.}"),
  notation = "none",
  threeparttable = TRUE,
  escape = FALSE
)

table_1b.3


```



## 1B(4): Median Age for Hispanic or Latino Groups in Chicago, 2018-2022 (ACS 5-year Estimates)

```{r}
# analysis

# filter for year 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)

# 1B: Population pyramid of the percentage of Mexican population by age group compared to the rest of Latino Population and median age in Chicago (Data source: 2018-2022 ACS data)

df <-  data_chi_2018_22 %>%
  mutate(
    age_group = case_when(
      age < 20 ~ "Young (0-19)",
      age >= 20 & age < 40 ~ "Young Adults (20-39)",
      age >= 40 & age < 60 ~ "Middle-aged (40-59)",
      age >= 60 & age < 80 ~ "Older Adults (60-79)",
      age >= 80 ~ "Elderly (80+)"
    )
  )
# Create survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)


# Calculate weighted population counts by age group and ethnicity

# Calculate weighted population by ethnicity and age group
pop_pyramid <- df %>%
  as_survey_design(weights = perwt) %>% 
  survey_count(hispan_breakdown, age_group, name="total_weighted_count")  %>%
  group_by(hispan_breakdown) %>%
  mutate(total_weighted_percentage = total_weighted_count / sum(total_weighted_count) * 100,
         total_weighted_percentage  = paste0(format(round(total_weighted_percentage, 1), nsmall = 1), "%"))




# get median age

weighted_age  <- df %>%
  group_by(hispan_breakdown) %>%
  summarize(
    weighted_age = matrixStats::weightedMedian(age, perwt)
  ) %>% mutate(
    weighted_age = format(round(weighted_age, 1), nsmall = 1)
  )  %>% filter(!is.na(hispan_breakdown))


# combined

df_final  <- pop_pyramid %>% left_join(weighted_age) %>% filter(!is.na(hispan_breakdown))
```



```{r}
# visuals
# visuals

table_1b.4 <- weighted_age  %>% select(hispan_breakdown, weighted_age) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
       col.names = c("Race/Ethnicity", "Median Age"),
      align = c("l",rep("r",1)),
      caption = "Median Age for Hispanic or Latino Groups in Chicago, 2018-2022 (ACS 5-year Estimates)",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2, width = "15.8em") %>%  

  row_spec(0, bold = T,
           # align = 'c',
             #background = "#f2f0f7",
            font_size = 8) %>%

 add_footnote(
  c("\\footnotesize{Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2018-2022 American Community Survey 5-year Estimates). Tabulations by Great Cities Institute.}"),
  notation = "none",
  threeparttable = TRUE,
  escape = FALSE
)
  

table_1b.4


```


## 1C: Mean Household Size for Mexicans and Other Racial/Ethnic Groups in Chicago, 2018-2022 (ACS 5-year Estimates)

```{r}

# Step 1: Filter data for the year 2022
data_chi_2018_22 <- usa_data %>% filter(year == 2022)

# Step 2: Calculate household size for each household
household_size <- data_chi_2018_22 %>%
   group_by(serial) %>%
   summarize(household_size = n()) %>%
   ungroup()

# Step 3: Merge household size back to the original dataset
data_with_household_size <- data_chi_2018_22 %>%
   left_join(household_size, by = "serial")

# Step 4: Define the survey design using srvyr with household weights
survey_design <- data_with_household_size %>%
   as_survey_design(weights = hhwt)

# Step 5: Calculate the weighted mean household size by race/ethnicity group
mean_household_size <- survey_design %>%
   group_by(race_ethnicity) %>%
   summarize(
     mean_household_size = survey_mean(household_size, na.rm = TRUE)
   ) %>%
   mutate(
     mean_household_size = format(round(mean_household_size, 1), nsmall = 1)
   )



```

```{r}
# visuals

table_1c <- mean_household_size %>% select(race_ethnicity, mean_household_size) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
       col.names = c("Race/Ethnicity", "Mean Household Size"),
      align = c("l",rep("r",1)),
      caption = "Mean Household Size for Mexicans and Other Racial/Ethnic Groups in Chicago, 2018-2022 (ACS 5-year Estimates)",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2, width = "15.8em") %>%  

  row_spec(0, bold = T, 
           # align = "C",
             #background = "#f2f0f7",
            font_size = 8) %>%
 add_footnote(
  c("\\footnotesize{Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2018-2022 American Community Survey 5-year Estimates). Tabulations by Great Cities Institute.}"),
  notation = "none",
  threeparttable = TRUE,
  escape = FALSE
)

table_1c


```




```{r fig.width=5, fig.height=4.5 ,fig.align='center'}

# Plot
ggplot(mean_household_size, aes(x = race_ethnicity, y = mean_household_size, fill = race_ethnicity)) +
  
  geom_bar(position=position_dodge(width=0.5), stat = "identity",
           color = "white",
           width=0.7) +
  
  scale_fill_manual(values = color_race_ethnicity) +
  
  labs(x = "", y = "", fill = "") +
  geom_text(aes(label = mean_household_size), 
position = position_dodge(width = 0.9), 
vjust = -0.5,
            hjust = 0.5,
            size = 2.5,
fontface = "bold") + 
  labs(title = "Figure 3: Mean Household Size for Mexicans and Other Racial/Ethnic Groups in Chicago, 2018-2022 (ACS 5-year Estimates)", 
       caption = "Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2018-2022 American\nCommunity Survey 5-year Estimates). Tabulations by Great Cities Institute.", fill = ''
)  +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 12)) +
  # scale_y_continuous(labels = function(x) paste0(x, "%"), limits = c(0,100), breaks = seq(0, 100, by = 100)) +

  theme_plots +
  theme(
        # axis.text.y = element_text(size = 8),
        panel.background = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 7, color = "#636363"),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y= element_blank()) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))  # Distribute legend items across 2 rows
  

```




## 1D(1): Mean and Median Household Income for Mexicans and Other Racial/Ethnic Groups in Chicago, 2018-2022 (ACS 5-year Estimates)

```{r}
# analysis
# filter for 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)

# 1D Income Levels and poverty rates for Mexicans, other Latinos, Black and White Populations in Chicago.

# Filter the data to remove negative and extreme values
filtered_data <- data_chi_2018_22 %>%
  filter(hhincome >= 0 & hhincome < 9999999, pernum == 1)
  
# Define the survey design using srvyr with only weights
survey_design <- filtered_data  %>%
  as_survey_design(weights = hhwt)

# Calculate the weighted Mean household income by group
weighted_avg_income <- survey_design %>% filter(pernum == 1) %>%
  group_by(race_ethnicity) %>%
  summarize(
    avg_hhincome = survey_mean(hhincome, vartype = "se", na.rm = TRUE)
  )   %>% mutate(avg_hhincome = round(avg_hhincome))



# weighted median: 

weighted_median_income <- data_chi_2018_22 %>%  filter(pernum == 1) %>%
  group_by(race_ethnicity) %>%
  summarize(
    weighted_median_hhincome = matrixStats::weightedMedian(hhincome, hhwt)
  ) %>%  
  ungroup() %>% mutate(weighted_median_hhincome = round(weighted_median_hhincome))



# final df with income levels
income_levels <- weighted_avg_income %>% left_join(weighted_median_income)  %>%
  mutate(
    avg_hhincome = paste0("$", format(avg_hhincome, big.mark = ",", scientific = FALSE)),
    weighted_median_hhincome = paste0("$", format(weighted_median_hhincome, big.mark = ",", scientific = FALSE))
  )


```


```{r}
# visuals



table_1d.1 <- income_levels %>% select(race_ethnicity, avg_hhincome, weighted_median_hhincome) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Mean Household Income", "Median Household Income"),
      align = c("l",rep("r",2)),
      caption = "Mean and Median Household Income for Mexicans and Other Racial/Ethnic Groups in Chicago, 2018-2022 (ACS 5-year Estimates)",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "7.9em") %>%  

  row_spec(0, bold = T,align = "c",
             #background = "#f2f0f7",
            font_size = 8) %>%

 add_footnote(
  c("\\footnotesize{Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2018-2022 American Community Survey 5-year Estimates). Tabulations by Great Cities Institute.}"),
  notation = "none",
  threeparttable = TRUE,
  escape = FALSE
)

table_1d.1
```


## 1D(2.1): Mean and Median Income of Full-time Workers for Mexicans and Other Racial/Ethnic Groups in Chicago, 2018-2022 (ACS 5-year Estimates)
```{r}
# analysis
# filter for 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)


# 1D Income Levels and poverty rates for Mexicans, other Latinos, Black and White Populations in Chicago.

# Filter the data to remove negative and extreme values
filtered_data <- data_chi_2018_22 %>%
  filter(incwage  > 0 & incwage  < 999999, empstat == 1, uhrswork >= 35, wkswork1 >= 48)



# Define the survey design using srvyr with only weights
survey_design <- filtered_data  %>%
  as_survey_design(weights = perwt)

# Calculate the weighted Mean household income by group
weighted_avg_income <- survey_design %>%
  group_by(race_ethnicity) %>%
  summarize(
    avg_incwage  = survey_mean(incwage , vartype = "se", na.rm = TRUE)
  ) %>% mutate(avg_incwage = round(avg_incwage))




# weighted median: 

weighted_median_income <- filtered_data %>% 
  group_by(race_ethnicity) %>%
  summarize(
    weighted_median_incwage  = matrixStats::weightedMedian(incwage , perwt)
  ) %>%
  ungroup() %>% mutate(weighted_median_incwage = round(weighted_median_incwage))



# final df with income levels
income_levels <- weighted_avg_income %>% left_join(weighted_median_income)  %>%
  mutate(
    avg_incwage  = paste0("$", format(avg_incwage , big.mark = ",", scientific = FALSE)),
    weighted_median_incwage  = paste0("$", format(weighted_median_incwage , big.mark = ",", scientific = FALSE))
  )

```


```{r}
# visuals



table_1d.2.1 <- income_levels %>% select(race_ethnicity, avg_incwage , weighted_median_incwage) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Mean Income", "Median Income"),
      align = c("l",rep("r",2)),
      caption = "Mean and Median Income of Full-time Workers for Mexicans and Other Racial/Ethnic Groups in Chicago, 2018-2022 (ACS 5-year Estimates)",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "7.9em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%
  
   add_footnote(
  c("\\footnotesize{Note: Data covers full-time employees working a minimum of 35 hours per week for at least 48 weeks each year.}",
    "\\footnotesize{Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2018-2022 American Community Survey 5-year Estimates). Tabulations by Great Cities Institute.}" ),
  notation = "none",
  threeparttable = TRUE,
  escape = FALSE
)



table_1d.2.1
```


## 1D(2.2): Mean and Median Income for Mexicans and Other Racial/Ethnic Groups in Chicago, 2018-2022 (ACS 5-year Estimates)

```{r}
# analysis
# filter for 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)


# 1D Income Levels and poverty rates for Mexicans, other Latinos, Black and White Populations in Chicago.

# Filter the data to remove negative and extreme values
filtered_data <- data_chi_2018_22 %>%
  filter(incwage  > 0 & incwage  < 999999,  empstat == 1)



# Define the survey design using srvyr with only weights
survey_design <- filtered_data  %>%
  as_survey_design(weights = perwt)

# Calculate the weighted Mean household income by group
weighted_avg_income <- survey_design %>%
  group_by(race_ethnicity) %>%
  summarize(
    avg_incwage  = survey_mean(incwage , vartype = "se", na.rm = TRUE)
  ) %>% mutate(avg_incwage = round(avg_incwage))


# weighted median: 

weighted_median_income <- filtered_data %>% 
  group_by(race_ethnicity) %>%
  summarize(
    weighted_median_incwage  = matrixStats::weightedMedian(incwage , perwt)
  ) %>%
  ungroup() %>% mutate(weighted_median_incwage = round(weighted_median_incwage))


# final df with income levels
income_levels <- weighted_avg_income %>% left_join(weighted_median_income)  %>%
  mutate(
    avg_incwage  = paste0("$", format(avg_incwage , big.mark = ",", scientific = FALSE)),
    weighted_median_incwage  = paste0("$", format(weighted_median_incwage , big.mark = ",", scientific = FALSE))
  )

```


```{r}
# visuals



table_1d.2.2 <- income_levels %>% select(race_ethnicity, avg_incwage , weighted_median_incwage) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Mean Income", "Median Income"),
      align = c("l",rep("r",2)),
      caption = "Mean and Median Income for Mexicans and Other Racial/Ethnic Groups in Chicago, 2018-2022 (ACS 5-year Estimates)",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "7.9em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%
  
     add_footnote(
  c("\\footnotesize{Note: The data includes all employed individuals, regardless of whether they work full-time or part-time.}", 
    "\\footnotesize{Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2018-2022 American Community Survey 5-year Estimates). Tabulations by Great Cities Institute.}"),
  notation = "none",
  threeparttable = TRUE,
  escape = FALSE
)

table_1d.2.2
```



## 1D(3.1): Mean and Median Income of Full-time Workers for Hispanic or Latino Groups in Chicago, 2018-2022 (ACS 5-year Estimates)

```{r}
# analysis
# filter for 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)

# 1D Income Levels and poverty rates for Mexicans, other Latinos, Black and White Populations in Chicago.

# Filter the data to remove negative and extreme values
filtered_data <- data_chi_2018_22 %>%
  filter(incwage  > 0 & incwage  < 999999, empstat == 1, uhrswork >= 35, wkswork1 >= 48)

  
# Define the survey design using srvyr with only weights
survey_design <- filtered_data  %>%
  as_survey_design(weights = perwt)

# Calculate the weighted Mean household income by group
weighted_avg_income <- survey_design %>% 
  group_by(hispan_breakdown) %>%
  summarize(
    avg_incwage  = survey_mean(incwage , vartype = "se", na.rm = TRUE)
  ) %>% mutate(avg_incwage = round(avg_incwage))


# weighted median: 

weighted_median_income <- filtered_data %>% 
  group_by(hispan_breakdown) %>%
  summarize(
    weighted_median_incwage  = matrixStats::weightedMedian(incwage , perwt)
  ) %>%
  ungroup() %>% mutate(weighted_median_incwage = round(weighted_median_incwage))


# final df with income levels
income_levels <- weighted_avg_income %>% left_join(weighted_median_income)  %>%
  mutate(
    avg_incwage  = paste0("$", format(avg_incwage , big.mark = ",", scientific = FALSE)),
    weighted_median_incwage  = paste0("$", format(weighted_median_incwage , big.mark = ",", scientific = FALSE))
  ) %>% filter(!is.na( hispan_breakdown))


```


```{r}
# visuals


table_1d.3.1 <- income_levels %>% select(hispan_breakdown, avg_incwage , weighted_median_incwage ) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Mean Income", "Median Income"),
      align = c("l",rep("r",2)),
      caption = "Mean and Median Income of Full-time Workers for Hispanic or Latino Groups in Chicago, 2018-2022 (ACS 5-year Estimates)",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "7.9em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

   add_footnote(
  c("\\footnotesize{Note: Data covers full-time employees working a minimum of 35 hours per week for at least 48 weeks each year.}", 
    "\\footnotesize{Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2018-2022 American Community Survey 5-year Estimates). Tabulations by Great Cities Institute.}"),
  notation = "none",
  threeparttable = TRUE,
  escape = FALSE
)


table_1d.3.1
```


## 1D(3.2): Mean and Median Income for Hispanic or Latino Groups in Chicago, 2018-2022 (ACS 5-year Estimates)

```{r}
# analysis
# filter for 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)

# 1D Income Levels and poverty rates for Mexicans, other Latinos, Black and White Populations in Chicago.

# Filter the data to remove negative and extreme values
filtered_data <- data_chi_2018_22 %>%
  filter(incwage  > 0 & incwage  < 999999, empstat == 1)

  
# Define the survey design using srvyr with only weights
survey_design <- filtered_data  %>%
  as_survey_design(weights = perwt)

# Calculate the weighted Mean household income by group
weighted_avg_income <- survey_design %>% 
  group_by(hispan_breakdown) %>%
  summarize(
    avg_incwage  = survey_mean(incwage , vartype = "se", na.rm = TRUE)
  ) %>% mutate(avg_incwage = round(avg_incwage))


# weighted median: 

weighted_median_income <- filtered_data %>% 
  group_by(hispan_breakdown) %>%
  summarize(
    weighted_median_incwage  = matrixStats::weightedMedian(incwage , perwt)
  ) %>%
  ungroup() %>% mutate(weighted_median_incwage = round(weighted_median_incwage))


# final df with income levels
income_levels <- weighted_avg_income %>% left_join(weighted_median_income)  %>%
  mutate(
    avg_incwage  = paste0("$", format(avg_incwage , big.mark = ",", scientific = FALSE)),
    weighted_median_incwage  = paste0("$", format(weighted_median_incwage , big.mark = ",", scientific = FALSE))
  ) %>% filter(!is.na( hispan_breakdown))


```


```{r}
# visuals


table_1d.3.2 <- income_levels %>% select(hispan_breakdown, avg_incwage , weighted_median_incwage) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Mean Income", "Median Income"),
      align = c("l",rep("r",2)),
      caption = "Mean and Median Income for Hispanic or Latino Groups in Chicago, 2018-2022 (ACS 5-year Estimates)",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "7.9em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%
  
     add_footnote(
  c("\\footnotesize{Note: The data includes all employed individuals, regardless of whether they work full-time or part-time.}",
    "\\footnotesize{Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2018-2022 American Community Survey 5-year Estimates). Tabulations by Great Cities Institute.}"),
  notation = "none",
  threeparttable = TRUE,
  escape = FALSE
)

      

table_1d.3.2
```


## 1D(4.1): Mean and Median Income of Full-time Workers for Mexico Born and U.S. Born Mexicans in Chicago, 2018-2022 (ACS 5-year Estimates)

```{r}
# analysis
# filter for 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022) %>% filter(!is.na(mex_foreign_born))

# 1D Income Levels and poverty rates for Mexicans born in Mexico vs. United States
# Filter the data to remove negative and extreme values
filtered_data <- data_chi_2018_22 %>%
  filter(incwage  > 0 & incwage  < 999999, empstat == 1, uhrswork >= 35, wkswork1 >= 48)

  
# Define the survey design using srvyr with only weights
survey_design <- filtered_data  %>%
  as_survey_design(weights = perwt)

# Calculate the weighted Mean household income by group
weighted_avg_income <- survey_design %>%
  group_by(mex_foreign_born) %>%
  summarize(
    avg_incwage  = survey_mean(incwage , vartype = "se", na.rm = TRUE)
  ) %>% mutate(avg_incwage = round(avg_incwage))


# weighted median: 

weighted_median_income <- filtered_data %>% 
  group_by(mex_foreign_born) %>%
  summarize(
    weighted_median_incwage  = matrixStats::weightedMedian(incwage ,perwt)
  ) %>%
  ungroup() %>% mutate(weighted_median_incwage = round(weighted_median_incwage))


# final df with income levels
income_levels <- weighted_avg_income %>% left_join(weighted_median_income)  %>%
  mutate(
    avg_incwage  = paste0("$", format(avg_incwage , big.mark = ",", scientific = FALSE)),
    weighted_median_incwage  = paste0("$", format(weighted_median_incwage , big.mark = ",", scientific = FALSE))
  ) 

```

```{r}

# visuals



table_1d.4.1 <- income_levels %>% select(mex_foreign_born, avg_incwage , weighted_median_incwage ) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Mexican Nativity", "Mean Income", "Median Income"),
      align = c("l",rep("r",2)),
      caption = "Mean and Median Income of Full-time Workers for Mexico Born and U.S. Born Mexicans in Chicago, 2018-2022 (ACS 5-year Estimates)",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "7.9em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

       add_footnote(
  c( "\\footnotesize{Note: Data covers full-time employees working a minimum of 35 hours per week for at least 48 weeks each year.}",
    "\\footnotesize{Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2018-2022 American Community Survey 5-year Estimates). Tabulations by Great Cities Institute.}"),
  notation = "none",
  threeparttable = TRUE,
  escape = FALSE
)

           
table_1d.4.1
```


## 1D(4.2): Mean and Median Income for Mexico Born and U.S. Born Mexicans in Chicago, 2018-2022 (ACS 5-year Estimates)

```{r}
# analysis
# filter for 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022) %>% filter(!is.na(mex_foreign_born))

# 1D Income Levels and poverty rates for Mexicans born in Mexico vs. United States
# Filter the data to remove negative and extreme values
filtered_data <- data_chi_2018_22 %>%
  filter(incwage  > 0 & incwage  < 999999, empstat == 1)

  
# Define the survey design using srvyr with only weights
survey_design <- filtered_data  %>%
  as_survey_design(weights = perwt)

# Calculate the weighted Mean household income by group
weighted_avg_income <- survey_design %>%
  group_by(mex_foreign_born) %>%
  summarize(
    avg_incwage  = survey_mean(incwage , vartype = "se", na.rm = TRUE)
  ) %>% mutate(avg_incwage = round(avg_incwage))


# weighted median: 

weighted_median_income <- filtered_data %>% 
  group_by(mex_foreign_born) %>%
  summarize(
    weighted_median_incwage  = matrixStats::weightedMedian(incwage ,perwt)
  ) %>%
  ungroup() %>% mutate(weighted_median_incwage = round(weighted_median_incwage))


# final df with income levels
income_levels <- weighted_avg_income %>% left_join(weighted_median_income)  %>%
  mutate(
    avg_incwage  = paste0("$", format(avg_incwage , big.mark = ",", scientific = FALSE)),
    weighted_median_incwage  = paste0("$", format(weighted_median_incwage , big.mark = ",", scientific = FALSE))
  ) 

```

```{r}

# visuals



table_1d.4.2 <- income_levels %>% select(mex_foreign_born, avg_incwage , weighted_median_incwage ) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Mexican Nativity", "Mean Income", "Median Income"),
      align = c("l",rep("r",2)),
      caption = "Mean and Median Income for Mexico Born and U.S. Born Mexicans in Chicago, 2018-2022 (ACS 5-year Estimates)",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "7.9em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%
  
         add_footnote(
  c("\\footnotesize{Note: Data covers full-time employees working a minimum of 35 hours per week for at least 48 weeks each year.}",
    "\\footnotesize{Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2018-2022 American Community Survey 5-year Estimates). Tabulations by Great Cities Institute.}"),
  notation = "none",
  threeparttable = TRUE,
  escape = FALSE
)


table_1d.4.2
```





## 1D(5): Population in Poverty and Poverty Rate for Mexicans and Other Racial/Ethnic Groups in Chicago, 2000 (Decennial Census), 2008-2012, and 2018-2022 (ACS 5-year Estimates)

```{r}
# analysis

# poverty
# filter for 2022

data_chi_2018_22 <- usa_data 

# Define the survey design using srvyr with only weights
survey_design2 <- data_chi_2018_22  %>%
  as_survey_design(weights = perwt)
  

  
# Calculate poverty rates by group

# Calculate total weighted count by race_category and ethnicity
total_weighted_pop_count <- survey_design2 %>%
  group_by(race_ethnicity, year) %>%
  summarise(total_weighted_pop_count = survey_total())

# Calculate total weighted count in poverty by race_category and ethnicity
total_weighted_poverty_count <- survey_design2 %>%
  filter(poverty <= 100) %>%
  group_by(race_ethnicity, year) %>%
  summarise(total_weighted_poverty_count = survey_total())

# Combine total counts and poverty counts
combined <- left_join(total_weighted_pop_count, total_weighted_poverty_count)


poverty_rate_trends <- combined %>% mutate(poverty_rate = (total_weighted_poverty_count/total_weighted_pop_count)*100)

poverty_rate_trends_wide <- poverty_rate_trends %>%  pivot_wider(
  id_cols = race_ethnicity,
    names_from = year,
    values_from = c(
      total_weighted_poverty_count,
      poverty_rate
    ),
    names_sep = "_"
  ) %>% select(race_ethnicity, total_weighted_poverty_count_2000, poverty_rate_2000,  total_weighted_poverty_count_2012, poverty_rate_2012,  total_weighted_poverty_count_2022, poverty_rate_2022) %>% mutate(diff_2022_2000 = poverty_rate_2022-poverty_rate_2000) %>%  mutate(across(starts_with("poverty_rate") | starts_with("diff"), ~ paste0(format(round(.x, 1), nsmall = 1), "%")))


```


```{r}
# visuals


table_1d.5 <- poverty_rate_trends_wide  %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("", "Number", "Percent", "Number", "Percent", "Number", "Percent", "Difference"),
      align = c("l",rep("r",8)),
      caption = "Population in Poverty and Poverty Rate for Mexicans and Other Racial/Ethnic Groups in Chicago, 2000 (Decennial Census), 2008-2012, and 2018-2022 (ACS 5-year Estimates)",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:8, width = "3.68em") %>%  
 add_header_above(
    align = c("l",  rep("c", 4)),
    c(
      "Race/Ethnicity", 
      "Poverty\nin 2000 " = 2, 
      "Poverty\nin 2008-2012 " = 2, 
      "Poverty\nin 2018-2022" = 2,
     "Changes\nfrom 2000\nto 2018-2022" = 1),
    bold = TRUE, 
    font_size = 8) %>%
  row_spec(0, 
           # bold = T,
             #background = "#f2f0f7",
            font_size = 8, align = "c") %>%
  
   add_footnote(
  c("\\footnotesize{Data Source: IPUMS USA, University of Minnesota, www.ipums.org (2000 Decennial Census, 2018-2012, and 2018-2022 American Community Survey 5-year Estimates). Tabulations by Great Cities Institute.}"),
  notation = "none",
  threeparttable = TRUE,
  escape = FALSE
)



table_1d.5
```

## 1E: Total, Hispanic or Latino, and Mexican Population by 10 Community Areas with the Largest Share of Mexican Population, 2018-2022 (ACS 5-year Estimates)

```{r}
# analysis
top_10 <- chicago_ca_pop %>% as.data.frame() %>% select(commnty, totl_pp, ttl_hs_,ttl_mxc, prc_mx_, prc_mxc) %>%   mutate(commnty = str_to_title(commnty)) %>% arrange(desc(prc_mxc)) %>%  slice_max(order_by = prc_mxc, n = 10)


# top 10 row
totals <- top_10 %>%
  summarise(
    commnty = "10 Community Areas with the Largest Share of Mexican Population",
    totl_pp = sum(totl_pp, na.rm = TRUE),
    ttl_hs_ = sum(ttl_hs_, na.rm = TRUE),
    ttl_mxc = sum(ttl_mxc, na.rm = TRUE),
    prc_mx_ = (ttl_mxc/ttl_hs_) * 100,
    prc_mxc = (ttl_mxc/totl_pp) * 100
  )



# rest of community areas
min_67 <- chicago_ca_pop %>% as.data.frame() %>% select(commnty, totl_pp, ttl_hs_,ttl_mxc, prc_mx_, prc_mxc) %>%   mutate(commnty = str_to_title(commnty)) %>% slice_min(order_by = prc_mxc, n = 67)


# the rest
totals_min <- min_67 %>%
  summarise(
    commnty = "Other Community Areas",
    totl_pp = sum(totl_pp, na.rm = TRUE),
    ttl_hs_ = sum(ttl_hs_, na.rm = TRUE),
    ttl_mxc = sum(ttl_mxc, na.rm = TRUE),
    prc_mx_ = (ttl_mxc/ttl_hs_) * 100,
    prc_mxc = (ttl_mxc/totl_pp) * 100
  )



# all of chicago
df_all <- chicago_ca_pop %>% as.data.frame() %>% select(commnty, totl_pp, ttl_hs_,ttl_mxc, prc_mx_, prc_mxc) %>%   mutate(commnty = str_to_title(commnty)) %>% 
  summarise(
    commnty = "Chicago",
    totl_pp = sum(totl_pp, na.rm = TRUE),
    ttl_hs_ = sum(ttl_hs_, na.rm = TRUE),
    ttl_mxc = sum(ttl_mxc, na.rm = TRUE),
    prc_mx_ = (ttl_mxc/ttl_hs_) * 100,
    prc_mxc = (ttl_mxc/totl_pp) * 100
  )





df_final <- rbind(top_10, totals, totals_min, df_all) %>% mutate(
    prc_mx_ = paste0(format(round(prc_mx_, 1), nsmall = 1), "%"),
    prc_mxc = paste0(format(round(prc_mxc, 1), nsmall = 1), "%")
)


```


```{r}
# visuals


table_1e <- df_final   %>% select(commnty, totl_pp, ttl_hs_, ttl_mxc, prc_mx_ , prc_mxc) %>%

   # using kable

  kbl(, booktabs = T,
      col.names = c("Total of 10 Community Areas", "Total Population", "Hispanic or Latino Population", "Mexican Population", "% Mexicans of Hispanic or Latino", "% Mexicans of Total Pop"),
      align = c("l",rep("r",5)),
      caption = "Total, Hispanic or Latino, and Mexican Population by 10 Community Areas with the Largest Share of Mexican Population, 2018-2022 (ACS 5-year Estimates)",
      format.args = list(big.mark = ","),
      linesep = "")  %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center", 
                latex_options = "HOLD_position"
                ) %>%
  column_spec(1, width = "10em") %>%
  column_spec(2:6, width = "6em") %>%
  row_spec(0, align = "c",font_size = 8, bold = TRUE ) %>%  # Center column headers
  # add_header_above(
  #   align = c("l", rep("c", 5)),
  #   c(
  #     "10 Community Areas\nwith the Largest Share\nof Mexican Population",
  #     "Total\nPopulation" = 1,
  #     "Hispanic or\nLatino Population " = 1,
  #     "Mexican\nPopulation" = 1,
  #    "% Mexicans of\nHispanic or Latino" = 1,
  #    "% Mexicans\nof Total Pop" = 1),
  #   bold = TRUE,
  #   font_size = 8) %>%
  # row_spec(0, bold = T,
  #            #background = "#f2f0f7",
  #           font_size = 8) %>%
 row_spec(c(10), hline_after = T) %>%
  row_spec(11:13, bold = T,
             background = "#f2f0f7",
            font_size = 8) %>%

     add_footnote(
  c("\\footnotesize{Data Source: IPUMS NHGIS, University of Minnesota, www.nhgis.org (2018-2022 American Community Survey 5-year Estimates). Tabulations by Great Cities Institute.}"),
  notation = "none",
  threeparttable = TRUE,
  escape = FALSE
)


table_1e
```


