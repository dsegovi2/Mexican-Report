---
title: "Mexicans in Chicago Report Committee"
author: ""
date: "Great Cities Institute"
output: 
  pdf_document:
    latex_engine: xelatex
    toc: true
    highlight: pygments
    extra_dependencies: ["float"]
    fig_caption: true
mainfont: "Arial"
header-includes:
  - \usepackage{titling}
  - \pretitle{\begin{flushleft}}
  - \posttitle{\end{flushleft}}
  - \usepackage{pdflscape}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, fig.pos="H")


```


```{r echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}

library(ipumsr)
library(tidyverse)
library(purrr)
library(sf)
library(tidycensus)
library(tidyr)
library(readxl)
library(sf)
library(htmltools)
library(leaflet)
library(janitor)
library(data.table)
library(tinytex)
library(survey) # for survey analysis
library(srvyr)  # for tidy survey analysis
library(tmap)
library("kableExtra") 
library(tmaptools)
library("RColorBrewer") 
# library(OpenStreetMap)
# remotes::install_github('yihui/knitr')
# install.packages("knitr")
# library(knitr)
# options(tinytex.verbose = TRUE)
# tinytex::reinstall_tinytex()
# install.packages('tinytex')

# update.packages(ask = FALSE, checkBuilt = TRUE)
# tinytex::tlmgr_update()
# tinytex::latexmk("Housing_Visual.tex")


##### Chicago boarder
Chicago_boundary_shp <- read_sf("C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/Boundaries_Chicago/geo_export_8881adc5-2460-457b-892f-04f4d6028b72.shp") %>% 
  st_transform(crs = 4326)
# mapview(community_shp)


# Get the current bounding box of the data
bbox_data <- st_bbox(Chicago_boundary_shp)

# Calculate the range of x and y values in degrees
xrange <- bbox_data$xmax - bbox_data$xmin
yrange <- bbox_data$ymax - bbox_data$ymin

# Calculate the center of the bounding box
center_x <- (bbox_data$xmin + bbox_data$xmax) / 2
center_y <- (bbox_data$ymin + bbox_data$ymax) / 2
# Modify the bounding box to fit the desired width while keeping the height the same
bbox_new <- c(center_x - 0.24,
              center_y - 0.23,
              center_x + 0.23,
              center_y + 0.23)

# osm_chicago <- read_osm(bbox_new, 
#                         type = "bing")


theme_plots <-
  theme_minimal() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_line(color="#969696", linewidth = 1),
        plot.title = element_text(face ="bold", size = 10, hjust = 0.5),
      plot.subtitle = element_text(face ="italic", size = 8, color = "#636363"),
      axis.text = element_text(size = 9),
      axis.title = element_text(face ="bold", size = 9),
      plot.caption = element_text(hjust = 0, size = 8, color = "black"),
      legend.text = element_text(size = 8, color = "#636363"),
      legend.title = element_text(face = "bold", size = 8, color = "#636363")) 

```

\renewcommand{\arraystretch}{1.4}
\clearpage

```{r}

# Read Data

usa_data <- read.csv("C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/final_Mexican_IL_2000_22.csv") %>% 
  mutate(race_ethnicity = case_when(hispan ==0 & race == 1 ~ "White (non-Hispanic or Latino)",
                                    hispan ==0 & race == 2 ~ "Black (non-Hispanic or Latino)",
                                    hispan %in% c(2,3,4) ~ "Other Latinos",
                                    hispan ==1 ~ "Mexican", 
                                    hispan ==0 & race %in%c(3:9) ~ "Other (non-Hispanic or Latino)",
                                    TRUE ~ NA_character_),
  hispan_breakdown = case_when(
  hispand == 0 ~ "Not Hispanic",
  hispand == 100 ~ "Mexican", 
  hispand == 200 ~ "Puerto Rican",
  hispand == 300 ~ "Cuban",
  hispand == 411 ~ "Costa Rican",
  hispand == 412 ~ "Guatemalan",
  hispand == 413 ~ "Honduran",
  hispand == 414 ~ "Nicaraguan",
  hispand == 415 ~ "Panamanian",
  hispand == 416 ~ "Salvadoran",
  hispand == 417 ~ "Central American, not specified",
  hispand == 420 ~ "Argentinean",
  hispand == 421 ~ "Bolivian",
  hispand == 422 ~ "Chilean",
  hispand == 423 ~ "Colombian",
  hispand == 424 ~ "Ecuadorian",
  hispand == 425 ~ "Paraguayan",
  hispand == 426 ~ "Peruvian",
  hispand == 427 ~ "Uruguayan",
  hispand == 428 ~ "Venezuelan",
  hispand == 431 ~ "South American, not specified",
  hispand == 450 ~ "Spaniard",
  hispand == 460 ~ "Dominican",
  hispand == 498 ~ "Other, not specified",
  TRUE ~ "Other"
),
mex_foreign_born = case_when(
    race_ethnicity == "Mexican" & bpl %in% as.character(1:56) ~ "U.S. Born",
    race_ethnicity == "Mexican" & bpl == "200" ~ "Mexico Born",
    TRUE ~ NA_character_  # Optional: default case for other values or groups
  )) %>% ## filter for hispanic groups here ##
  mutate(hispan_breakdown = factor(hispan_breakdown, level = c("Mexican", "Puerto Rican","Ecuadorian", "Cuban", "Guatemalan", "Venezuelan", "Other, not specified", "Colombian", "Salvadoran", "Peruvian", "Honduran", "Spaniard", "Dominican", "Argentinean", "Chilean", "Nicaraguan", "Panamanian", "Costa Rican", "Bolivian", "Uruguayan", "Paraguayan"))
  )

cps_ddi <- read_ipums_micro(read_ipums_ddi("C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/cps_00170.xml")) %>% 
  clean_names() 


# read health data
chicago_ca_pop <- read_sf("Data Tables/shp/comm_pop_chi_2022.shp") %>% as.data.frame()

chicago_health <- read_csv("Health Data/Chicago Health Atlas Data Download - Community areas.csv") %>% clean_names() %>% rename(
  obesity_rate = hcsobp_2022_2023,
  diabetes_rate = hcsdiap_2022_2023,
  asthma_rate = hcsathp_2022_2023,
  lbw_rate = vrbwp_2017_2021,
  drinking_rate = hcsbdp_2022_2023,
  smoking_rate = hcssmkp_2022_2023,
  fruit_veg_rate = hcsfvp_2022_2023, 
  sexual_assault_crimes =  czs_2023, 
  unmet_mental_health_rate = hcsumhap_2022_2023
)

# merge chicago ca with health atlas
df_health <- chicago_ca_pop %>% select(commnty, prc_mxc, prc_nh_w, prc_nh_b) %>% mutate(commnty = str_to_title(tolower(commnty))) %>% left_join(chicago_health, by = c("commnty" = "name")) %>% select(-layer) %>%
 mutate(across(matches("rate$|crimes$"), ~ round(as.numeric(.), 1)))

```


# Demographic

## 1.A: Mexican population in Chicago:

## 1. Mexican population in Chicago, 2018-2022:

```{r, include=FALSE}
####### 2018-2022 ##################
comm_2022 <- st_read("Data Tables/shp/comm_pop_chi_2022.shp") %>% 
  mutate(lable_prc = paste0(lable, ": ", prc),
         prc2 = paste0( prc, "%")) %>% 
  mutate(ttl_mxc2 = scales::comma(ttl_mxc))

tract_2022 <- st_read("Data Tables/shp/tract_pop_chi_2022.shp") 

pop_dots_2022_origin_50 <- read_sf("Data Tables/shp/pop_dots_2022_origin_50.shp") 


Mexican_18_22 <- pop_dots_2022_origin_50 %>% 
  filter(Origin == 'Mexican')
####################################
```


```{r fig.height=11, fig.width=8}

### Dot Density
# st_write(Mexican, "data/2020/origin_Mexican_2020_50.shp")
Mexican_map_2020 <-

  # tm_shape(community_shp) +
  # tm_polygons(col = "white",
  #            alpha = 0.3)+
  
  tm_shape(Mexican_18_22,  bbox = bbox_new) +
  tm_dots(col = "Origin",
          palette = "#1565c0",
          size = 0.025,
          legend.show = FALSE,
          alpha = 0.3) +
  
  tm_shape(comm_2022) +
  tm_borders(col = "#6c757d",
             alpha = 1,
             lwd = 1)+
  tm_text("lable" , size = 0.6, alpha = 0.9, fontface="bold", fontfamily = "sans")+

  tm_shape(Chicago_boundary_shp) +
  tm_borders(col = "#343a40",
             alpha = 0.7,
             lwd = 2.5) +

  tm_layout( frame = TRUE,
             # main.title.position = c("left", "top"),
             # main.title = "Density of Hispanic or Latino Population by their Origins in Chicago, 2010",
             # main.title.size = 1.2,
            legend.outside = FALSE,
            # legend.width = 1.5,
            legend.title.size = .9,
            legend.text.size = 0.8,
            legend.title.fontface = "bold",
            # legend.position = c("left", "bottom"),
            legend.position = c(0.03, 0.12),
            legend.bg.color = "white",
            legend.bg.alpha = .3) +       # manually position legend) +
  tm_credits("Data source:\nIPUMS NHGIS (2018-2022)\nMap Generated by:\nThe Great Cities Institute",
             fontface = "bold",
             position = c("left","bottom"), size = 0.8)+
  
  tm_credits("Distribution of Mexican Population in Chicago, 2018-2022",
             fontface = "bold",
             position = c("left","top"), size = 1.25)+

  
  tm_add_legend("symbol", 
                labels = "Mexican", 
                col = "#1565c0",
                size = 0.6,
                title = "1 dot = 50 People") +
  
  tm_add_legend("line",
                labels = c("Chicago Border", "Community Area Border"),
                col = c("#343a40", "#6c757d"),
                lwd = c(2.5, 2),
                title = "Border Types",
                size = 0.8) +

  # tm_credits("1 dot = 20 People",
  #            position = c(0.03, 0.32), size = 0.8, fontface = "bold") +
  tm_compass(position = c("right", "bottom"), size = 1) +
  tm_scale_bar(position = c("right", "bottom"), width = 0.15)

Mexican_map_2020

```







```{r fig.height=11, fig.width=8}
### Percentage of the Mexican Population by Community Areas in Chicago, 2018-2022
comm_mexican_map_2022 <-

  tm_shape(comm_2022, bbox = bbox_new) +
  tm_polygons(
    col = "prc",
              style = "jenks",
              border.col = "#ced4da",
              palette="Blues",
              alpha = 0.7,
              n = 5,
              title = "Percentage of the Mexican Population",
              lwd = 0.3) +
  tm_shape(comm_2022) +
  tm_borders(col = "#6c757d",
             alpha = 1,
             lwd = 1)+
  
  # tm_shape(comm_2022 %>% filter(prc>=50)) +
  # tm_borders(col = "#9b2226",
  #            alpha = 1,
  #            lwd = 2)+
  tm_text("lable" , size = 0.6, alpha = 0.7, fontface="bold", fontfamily = "sans")+

  tm_shape(Chicago_boundary_shp) +
  tm_borders(col = "#343a40",
             alpha = 1,
             lwd = 2.5) +

  tm_layout( frame = TRUE,
             # main.title.position = c("left", "top"),
             # main.title = "Density of Hispanic or Latino Population by their Origins in Chicago, 2010",
             # main.title.size = 1.2,
            legend.outside = FALSE,
            legend.width = 1.5,
            legend.title.size = .9,
            legend.text.size = 0.8,
            legend.title.fontface = "bold",
            # legend.position = c("left", "bottom"),
            legend.position = c(0.03, 0.12),
            legend.bg.color = "white",
            legend.bg.alpha = .3) +      # manually position legend) +
  
  tm_credits("Data source:\nIPUMS NHGIS (2018-2022)\nMap Generated by:The Great Cities Institute",
             fontface = "bold",
             position = c("left","bottom"), size = 0.8)+


  tm_credits("Percentage of the Mexican Population by Community Areas\nin Chicago, 2018-2022",
             fontface = "bold",
             position = c("left","top"), size = 1.25)+


  tm_add_legend("line",
                labels = c("Chicago Border", "Community Area Border"),
                col = c("#343a40","#6c757d"),
                lwd = c(2.5, 2),
                title = "Border Types",
                size = 0.8) +

  # tm_credits("1 dot = 20 People",
  #            position = c(0.03, 0.32), size = 0.8, fontface = "bold") +
  tm_compass(position = c("right", "bottom"), size = 1) +
  tm_scale_bar(position = c("right", "bottom"), width = 0.15)

comm_mexican_map_2022


```


```{r fig.height=11, fig.width=8}
### Mexican Population by Community Areas in Chicago, 2018-2022
comm_mexican_pop_map_2022 <-

  tm_shape(comm_2022, bbox = bbox_new) +
  tm_polygons(
    col = "ttl_mxc",
              style = "jenks",
              border.col = "#ced4da",
              palette="Blues",
              alpha = 0.7,
              n = 5,
              title = "Mexican Population",
              lwd = 0.3) +
  tm_shape(comm_2022) +
  tm_borders(col = "#6c757d",
             alpha = 1,
             lwd = 1)+
  
  # tm_shape(comm_2022 %>% filter(prc>=50)) +
  # tm_borders(col = "#9b2226",
  #            alpha = 1,
  #            lwd = 2)+
  tm_text("ttl_mxc2" , size = 0.7, alpha = 0.7, fontface="bold", fontfamily = "sans")+

  tm_shape(Chicago_boundary_shp) +
  tm_borders(col = "#343a40",
             alpha = 1,
             lwd = 2.5) +

  tm_layout( frame = TRUE,
             # main.title.position = c("left", "top"),
             # main.title = "Density of Hispanic or Latino Population by their Origins in Chicago, 2010",
             # main.title.size = 1.2,
            legend.outside = FALSE,
            legend.width = 1.5,
            legend.title.size = .9,
            legend.text.size = 0.8,
            legend.title.fontface = "bold",
            # legend.position = c("left", "bottom"),
            legend.position = c(0.03, 0.12),
            legend.bg.color = "white",
            legend.bg.alpha = .3) +      # manually position legend) +
  
  tm_credits("Data source:\nIPUMS NHGIS (2018-2022)\nMap Generated by:The Great Cities Institute",
             fontface = "bold",
             position = c("left","bottom"), size = 0.8)+


  tm_credits("Mexican Population by Community Areas in Chicago, 2018-2022",
             fontface = "bold",
             position = c("left","top"), size = 1.25)+


  tm_add_legend("line",
                labels = c("Chicago Border", "Community Area Border"),
                col = c("#343a40","#6c757d"),
                lwd = c(2.5, 2),
                title = "Border Types",
                size = 0.8) +

  # tm_credits("1 dot = 20 People",
  #            position = c(0.03, 0.32), size = 0.8, fontface = "bold") +
  tm_compass(position = c("right", "bottom"), size = 1) +
  tm_scale_bar(position = c("right", "bottom"), width = 0.15)

comm_mexican_pop_map_2022

```


## 2. Mexican population in Chicago, 2008-2012:

```{r, include=FALSE}

####### 2010 ######################
comm_2012 <- st_read("Data Tables/shp/comm_pop_chi_2012.shp") %>%
  mutate(lable_prc = paste0(lable, ": ", prc)) %>% 
  mutate(ttl_mxc2 = scales::comma(ttl_mxc))

tract_2012 <- st_read("Data Tables/shp/tract_pop_chi_2012.shp")

pop_dots_2010_origin_50 <- read_sf("Data Tables/shp/pop_dots_2010_origin_50.shp") 

Mexican_2010 <- pop_dots_2010_origin_50 %>% 
  filter(Origin == 'Mexican')
#######################################
```



```{r fig.height=11, fig.width=8}

### Dot Density
Mexican_map_2010 <-
  tm_shape(Mexican_2010,  bbox = bbox_new) +
  tm_dots(col = "Origin",
          palette = "#1565c0",
          size = 0.025,
          legend.show = FALSE,
          alpha = 0.3) +
  
  tm_shape(comm_2012) +
  tm_borders(col = "#6c757d",
             alpha = 1,
             lwd = 1)+
  tm_text("lable" , size = 0.6, alpha = 0.9, fontface="bold", fontfamily = "sans")+

  tm_shape(Chicago_boundary_shp) +
  tm_borders(col = "#343a40",
             alpha = 0.7,
             lwd = 2.5) +

  tm_layout( frame = TRUE,
             # main.title.position = c("left", "top"),
             # main.title = "Density of Hispanic or Latino Population by their Origins in Chicago, 2010",
             # main.title.size = 1.2,
            legend.outside = FALSE,
            # legend.width = 1.5,
            legend.title.size = .9,
            legend.text.size = 0.8,
            legend.title.fontface = "bold",
            # legend.position = c("left", "bottom"),
            legend.position = c(0.03, 0.12),
            legend.bg.color = "white",
            legend.bg.alpha = .3) +       # manually position legend) +
  tm_credits("Data source:\nIPUMS NHGIS (2010)\nMap Generated by:\nThe Great Cities Institute",
             fontface = "bold",
             position = c("left","bottom"), size = 0.8)+
  
  tm_credits("Distribution of Mexican Population in Chicago, 2010",
             fontface = "bold",
             position = c("left","top"), size = 1.25)+

  
  tm_add_legend("symbol", 
                labels = "Mexican", 
                col = "#1565c0",
                size = 0.6,
                title = "1 dot = 50 People") +
  
  tm_add_legend("line",
                labels = c("Chicago Border", "Community Area Border"),
                col = c("#343a40", "#6c757d"),
                lwd = c(2.5, 2),
                title = "Border Types",
                size = 0.8) +

  # tm_credits("1 dot = 20 People",
  #            position = c(0.03, 0.32), size = 0.8, fontface = "bold") +
  tm_compass(position = c("right", "bottom"), size = 1) +
  tm_scale_bar(position = c("right", "bottom"), width = 0.15)

Mexican_map_2010

```







```{r fig.height=11, fig.width=8}
### Percentage of the Mexican Population by Community Areas in Chicago, 2008-2012
comm_mexican_map_2012 <-

  tm_shape(comm_2012, bbox = bbox_new) +
  tm_polygons(
    col = "prc",
              style = "jenks",
              border.col = "#ced4da",
              palette="Blues",
              alpha = 0.7,
              n = 5,
              title = "Percentage of the Mexican Population",
              lwd = 0.3) +
  tm_shape(comm_2012) +
  tm_borders(col = "#6c757d",
             alpha = 1,
             lwd = 1)+
  
  # tm_shape(comm_2022 %>% filter(prc>=50)) +
  # tm_borders(col = "#9b2226",
  #            alpha = 1,
  #            lwd = 2)+
  tm_text("lable" , size = 0.6, alpha = 0.7, fontface="bold", fontfamily = "sans")+

  tm_shape(Chicago_boundary_shp) +
  tm_borders(col = "#343a40",
             alpha = 1,
             lwd = 2.5) +

  tm_layout( frame = TRUE,
             # main.title.position = c("left", "top"),
             # main.title = "Density of Hispanic or Latino Population by their Origins in Chicago, 2010",
             # main.title.size = 1.2,
            legend.outside = FALSE,
            legend.width = 1.5,
            legend.title.size = .9,
            legend.text.size = 0.8,
            legend.title.fontface = "bold",
            # legend.position = c("left", "bottom"),
            legend.position = c(0.03, 0.12),
            legend.bg.color = "white",
            legend.bg.alpha = .3) +      # manually position legend) +
  
  tm_credits("Data source:\nIPUMS NHGIS (2018-2022)\nMap Generated by:The Great Cities Institute",
             fontface = "bold",
             position = c("left","bottom"), size = 0.8)+


  tm_credits("Percentage of the Mexican Population by Community Areas\nin Chicago, 2008-2012",
             fontface = "bold",
             position = c("left","top"), size = 1.25)+


  tm_add_legend("line",
                labels = c("Chicago Border", "Community Area Border"),
                col = c("#343a40","#6c757d"),
                lwd = c(2.5, 2),
                title = "Border Types",
                size = 0.8) +

  # tm_credits("1 dot = 20 People",
  #            position = c(0.03, 0.32), size = 0.8, fontface = "bold") +
  tm_compass(position = c("right", "bottom"), size = 1) +
  tm_scale_bar(position = c("right", "bottom"), width = 0.15)

comm_mexican_map_2012


```





```{r fig.height=11, fig.width=8}
### Mexican Population by Community Areas in Chicago, 2008-2012
comm_mexican_pop_map_2012 <-

  tm_shape(comm_2012, bbox = bbox_new) +
  tm_polygons(
    col = "ttl_mxc",
              style = "jenks",
              border.col = "#ced4da",
              palette="Blues",
              alpha = 0.7,
              n = 5,
              title = "Mexican Population",
              lwd = 0.3) +
  tm_shape(comm_2012) +
  tm_borders(col = "#6c757d",
             alpha = 1,
             lwd = 1) +
  
  tm_text("ttl_mxc2" , size = 0.7, alpha = 0.7, fontface="bold", fontfamily = "sans") +

  tm_shape(Chicago_boundary_shp) +
  tm_borders(col = "#343a40",
             alpha = 1,
             lwd = 2.5) +

  tm_layout( frame = TRUE,
             # main.title.position = c("left", "top"),
             # main.title = "Density of Hispanic or Latino Population by their Origins in Chicago, 2010",
             # main.title.size = 1.2,
            legend.outside = FALSE,
            legend.width = 1.5,
            legend.title.size = .9,
            legend.text.size = 0.8,
            legend.title.fontface = "bold",
            # legend.position = c("left", "bottom"),
            legend.position = c(0.03, 0.12),
            legend.bg.color = "white",
            legend.bg.alpha = .3) +      # manually position legend) +
  
  tm_credits("Data source:\nIPUMS NHGIS (2008-2012)\nMap Generated by:The Great Cities Institute",
             fontface = "bold",
             position = c("left","bottom"), size = 0.8)+


  tm_credits("Mexican Population by Community Areas in Chicago, 2008-2012",
             fontface = "bold",
             position = c("left","top"), size = 1.25)+


  tm_add_legend("line",
                labels = c("Chicago Border", "Community Area Border"),
                col = c("#343a40","#6c757d"),
                lwd = c(2.5, 2),
                title = "Border Types",
                size = 0.8) +

  # tm_credits("1 dot = 20 People",
  #            position = c(0.03, 0.32), size = 0.8, fontface = "bold") +
  tm_compass(position = c("right", "bottom"), size = 1) +
  tm_scale_bar(position = c("right", "bottom"), width = 0.15)

comm_mexican_pop_map_2012

```


## 3. Mexican population in Chicago, 2000:

```{r, include=FALSE}


####### 2000 ######################
comm_2000 <- st_read("Data Tables/shp/comm_pop_chi_2000.shp") %>%
  mutate(lable_prc = paste0(lable, ": ", prc)) %>% 
  mutate(ttl_mxc2 = scales::comma(ttl_mxc))

tract_2000 <- st_read("Data Tables/shp/tract_pop_chi_2000.shp")

pop_dots_2000_origin_50 <- read_sf("Data Tables/shp/pop_dots_2000_origin_50.shp")
Mexican_2000 <- pop_dots_2000_origin_50 %>% 
  filter(Origin == 'Mexican')
###################################

```



```{r fig.height=11, fig.width=8}
### Dot Density
Mexican_map_2000 <-
  tm_shape(Mexican_2000,  bbox = bbox_new) +
  tm_dots(col = "Origin",
          palette = "#1565c0",
          size = 0.025,
          legend.show = FALSE,
          alpha = 0.3) +
  
  tm_shape(comm_2000) +
  tm_borders(col = "#6c757d",
             alpha = 1,
             lwd = 1)+
  tm_text("lable" , size = 0.6, alpha = 0.9, fontface="bold", fontfamily = "sans")+

  tm_shape(Chicago_boundary_shp) +
  tm_borders(col = "#343a40",
             alpha = 0.7,
             lwd = 2.5) +

  tm_layout( frame = TRUE,
             # main.title.position = c("left", "top"),
             # main.title = "Density of Hispanic or Latino Population by their Origins in Chicago, 2010",
             # main.title.size = 1.2,
            legend.outside = FALSE,
            # legend.width = 1.5,
            legend.title.size = .9,
            legend.text.size = 0.8,
            legend.title.fontface = "bold",
            # legend.position = c("left", "bottom"),
            legend.position = c(0.03, 0.12),
            legend.bg.color = "white",
            legend.bg.alpha = .3) +       # manually position legend) +
  tm_credits("Data source:\nIPUMS NHGIS (2000)\nMap Generated by:\nThe Great Cities Institute",
             fontface = "bold",
             position = c("left","bottom"), size = 0.8)+
  
  tm_credits("Distribution of Mexican Population in Chicago, 2000",
             fontface = "bold",
             position = c("left","top"), size = 1.25)+

  
  tm_add_legend("symbol", 
                labels = "Mexican", 
                col = "#1565c0",
                size = 0.6,
                title = "1 dot = 50 People") +
  
  tm_add_legend("line",
                labels = c("Chicago Border", "Community Area Border"),
                col = c("#343a40", "#6c757d"),
                lwd = c(2.5, 2),
                title = "Border Types",
                size = 0.8) +

  # tm_credits("1 dot = 20 People",
  #            position = c(0.03, 0.32), size = 0.8, fontface = "bold") +
  tm_compass(position = c("right", "bottom"), size = 1) +
  tm_scale_bar(position = c("right", "bottom"), width = 0.15)

Mexican_map_2000

```




```{r fig.height=11, fig.width=8}
## Percentage of the Mexican Population by Community Areas in Chicago, 2000
comm_mexican_map_2000 <-

  tm_shape(comm_2000, bbox = bbox_new) +
  tm_polygons(
    col = "prc",
              style = "jenks",
              border.col = "#ced4da",
              palette="Blues",
              alpha = 0.7,
              n = 5,
              title = "Percentage of the Mexican Population",
              lwd = 0.3) +
  tm_shape(comm_2000) +
  tm_borders(col = "#6c757d",
             alpha = 1,
             lwd = 1)+
  
  # tm_shape(comm_2022 %>% filter(prc>=50)) +
  # tm_borders(col = "#9b2226",
  #            alpha = 1,
  #            lwd = 2)+
  tm_text("lable" , size = 0.6, alpha = 0.7, fontface="bold", fontfamily = "sans")+

  tm_shape(Chicago_boundary_shp) +
  tm_borders(col = "#343a40",
             alpha = 1,
             lwd = 2.5) +

  tm_layout( frame = TRUE,
             # main.title.position = c("left", "top"),
             # main.title = "Density of Hispanic or Latino Population by their Origins in Chicago, 2010",
             # main.title.size = 1.2,
            legend.outside = FALSE,
            legend.width = 1.5,
            legend.title.size = .9,
            legend.text.size = 0.8,
            legend.title.fontface = "bold",
            # legend.position = c("left", "bottom"),
            legend.position = c(0.03, 0.12),
            legend.bg.color = "white",
            legend.bg.alpha = .3) +      # manually position legend) +
  
  tm_credits("Data source:\nIPUMS NHGIS (2000)\nMap Generated by:The Great Cities Institute",
             fontface = "bold",
             position = c("left","bottom"), size = 0.8)+


  tm_credits("Percentage of the Mexican Population by Community Areas\nin Chicago, 2000",
             fontface = "bold",
             position = c("left","top"), size = 1.25)+


  tm_add_legend("line",
                labels = c("Chicago Border", "Community Area Border"),
                col = c("#343a40","#6c757d"),
                lwd = c(2.5, 2),
                title = "Border Types",
                size = 0.8) +

  # tm_credits("1 dot = 20 People",
  #            position = c(0.03, 0.32), size = 0.8, fontface = "bold") +
  tm_compass(position = c("right", "bottom"), size = 1) +
  tm_scale_bar(position = c("right", "bottom"), width = 0.15)

comm_mexican_map_2000


```





```{r fig.height=11, fig.width=8}

### Mexican Population by Community Areas in Chicago, 2000
comm_mexican_pop_map_2000 <-

  tm_shape(comm_2000, bbox = bbox_new) +
  tm_polygons(
    col = "ttl_mxc",
              style = "jenks",
              border.col = "#ced4da",
              palette="Blues",
              alpha = 0.7,
              n = 5,
              title = "Mexican Population",
              lwd = 0.3) +
  tm_shape(comm_2000) +
  tm_borders(col = "#6c757d",
             alpha = 1,
             lwd = 1) +
  
  tm_text("ttl_mxc2" , size = 0.7, alpha = 0.7, fontface="bold", fontfamily = "sans") +

  tm_shape(Chicago_boundary_shp) +
  tm_borders(col = "#343a40",
             alpha = 1,
             lwd = 2.5) +

  tm_layout( frame = TRUE,
             # main.title.position = c("left", "top"),
             # main.title = "Density of Hispanic or Latino Population by their Origins in Chicago, 2010",
             # main.title.size = 1.2,
            legend.outside = FALSE,
            legend.width = 1.5,
            legend.title.size = .9,
            legend.text.size = 0.8,
            legend.title.fontface = "bold",
            # legend.position = c("left", "bottom"),
            legend.position = c(0.03, 0.12),
            legend.bg.color = "white",
            legend.bg.alpha = .3) +      # manually position legend) +
  
  tm_credits("Data source:\nIPUMS NHGIS (2000)\nMap Generated by:The Great Cities Institute",
             fontface = "bold",
             position = c("left","bottom"), size = 0.8)+


  tm_credits("Mexican Population by Community Areas in Chicago, 2000",
             fontface = "bold",
             position = c("left","top"), size = 1.25)+


  tm_add_legend("line",
                labels = c("Chicago Border", "Community Area Border"),
                col = c("#343a40","#6c757d"),
                lwd = c(2.5, 2),
                title = "Border Types",
                size = 0.8) +

  # tm_credits("1 dot = 20 People",
  #            position = c(0.03, 0.32), size = 0.8, fontface = "bold") +
  tm_compass(position = c("right", "bottom"), size = 1) +
  tm_scale_bar(position = c("right", "bottom"), width = 0.15)

comm_mexican_pop_map_2000

```


```{r}

homeownership = usa_data %>% 
  filter( city == 1190, pernum == 1) %>%  
  
  
  as_survey_design(weights = hhwt) %>% 
  
  survey_count(year, race_ethnicity, ownershp_f, name="count") %>% 
  
  filter(!is.na(race_ethnicity)) %>% 
  
  group_by(year, race_ethnicity) %>% 
  mutate(total = sum(count),
         per = 100*round(count/total, 4),
         per2 = paste0(per,"%"))
  
 # #### Export 
#  
  
  
```


## 1.B: Population Pyramid and Age

### 1. Population Pyramid and Percentage of Mexican population, 2018-2022:

```{r}
# analysis

# filter for year 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)

# 1B: Population pyramid of the percentage of Mexican population by age group compared to the rest of the population in Chicago and median age in Chicago (Data source: 2018-2022 ACS data)

df <-  data_chi_2018_22 %>%
  mutate(
    age_group = case_when(
      age < 20 ~ "Young (0-19)",
      age >= 20 & age < 40 ~ "Adults (20-39)",
      age >= 40 & age < 60 ~ "Middle-aged (40-59)",
      age >= 60 & age < 80 ~ "Older Adults (60-79)",
      age >= 80 ~ "Elderly (80+)"
    )
  )
# Create survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)


# Calculate weighted population counts by age group and ethnicity

# Calculate weighted population by ethnicity and age group
pop_pyramid <- df %>%
  as_survey_design(weights = perwt) %>% 
  survey_count(race_ethnicity, age_group, name="total_weighted_count")  %>%
  group_by(race_ethnicity) %>%
  mutate(total_weighted_percentage = total_weighted_count / sum(total_weighted_count) * 100,
         total_weighted_percentage  = paste0(round(total_weighted_percentage, 1), "%")) 



# get median age

weighted_age  <- df %>%
  group_by(race_ethnicity) %>%
  summarize(
    weighted_age = matrixStats::weightedMedian(age, perwt)
  ) 



# combined

df_final  <- pop_pyramid %>% left_join(weighted_age)

```








```{r}
# visual

table_1b.1 <- df_final  %>% pivot_wider(id_cols = c("race_ethnicity"), names_from = age_group, values_from = c("total_weighted_count", "total_weighted_percentage")) %>% select(race_ethnicity, 
                                                                                                                                                'total_weighted_count_Young (0-19)', 'total_weighted_percentage_Young (0-19)',
                                                                                                                                                 'total_weighted_count_Adults (20-39)', 'total_weighted_percentage_Adults (20-39)',
                                                                                                                                                 'total_weighted_count_Middle-aged (40-59)', 'total_weighted_percentage_Middle-aged (40-59)',
                                                                                                                                                 'total_weighted_count_Older Adults (60-79)', 'total_weighted_percentage_Older Adults (60-79)',
                                                                                                                                                 'total_weighted_count_Elderly (80+)', 'total_weighted_percentage_Elderly (80+)')   %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("", "Number", "Percent" , "Number", "Percent", "Number", "Percent", "Number", "Percent", "Number", "Percent"),
      align = c("l",rep("c",10)),
      caption = "Population Pyramid of the Mexican Population, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:11, width = "2.58em") %>%  

 add_header_above( align = c("l", rep("c",2)), c("Race/Ethnicity", "Young(0-19)" = 2, "Adults(0-19)" = 2, "Middle Aged (40-59)" = 2, "Older Adults (60-79)" = 2, "Elderly(80+)" = 2),
                    # background = "#cbc9e2", 
                    bold = T, font_size =8) %>% 

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")   


table_1b.1
```



### 2. Population Pyramid and Percentage of Hispanic/Latino breakdown, 2018-2022:

```{r}
# analysis
# analysis

# filter for year 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)

# 1B: Population pyramid of the percentage of Mexican population by age group compared to the rest of the population in Chicago and median age in Chicago (Data source: 2018-2022 ACS data)

df <-  data_chi_2018_22 %>%
  mutate(
    age_group = case_when(
      age < 20 ~ "Young (0-19)",
      age >= 20 & age < 40 ~ "Adults (20-39)",
      age >= 40 & age < 60 ~ "Middle-aged (40-59)",
      age >= 60 & age < 80 ~ "Older Adults (60-79)",
      age >= 80 ~ "Elderly (80+)"
    )
  )
# Create survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)


# Calculate weighted population counts by age group and ethnicity

# Calculate weighted population by ethnicity and age group
pop_pyramid <- df %>%
  as_survey_design(weights = perwt) %>% 
  survey_count(hispan_breakdown, age_group, name="total_weighted_count")  %>%
  group_by(hispan_breakdown) %>%
  mutate(total_weighted_percentage = total_weighted_count / sum(total_weighted_count) * 100,
         total_weighted_percentage  = paste0(round(total_weighted_percentage, 1), "%")) 



# get median age

weighted_age  <- df %>%
  group_by(hispan_breakdown) %>%
  summarize(
    weighted_age = matrixStats::weightedMedian(age, perwt)
  ) 



# combined

df_final  <- pop_pyramid %>% left_join(weighted_age) %>% mutate(across(everything(), ~replace(., is.na(.), "Missing Data")))

```

```{r}
# visual

table_1b.2 <- df_final  %>% pivot_wider(id_cols = c("hispan_breakdown"), names_from = age_group, values_from = c("total_weighted_count", "total_weighted_percentage")) %>% select(hispan_breakdown, 
                                                                                                                                                'total_weighted_count_Young (0-19)', 'total_weighted_percentage_Young (0-19)',
                                                                                                                                                 'total_weighted_count_Adults (20-39)', 'total_weighted_percentage_Adults (20-39)',
                                                                                                                                                 'total_weighted_count_Middle-aged (40-59)', 'total_weighted_percentage_Middle-aged (40-59)',
                                                                                                                                                 'total_weighted_count_Older Adults (60-79)', 'total_weighted_percentage_Older Adults (60-79)',
                                                                                                                                                 'total_weighted_count_Elderly (80+)', 'total_weighted_percentage_Elderly (80+)')   %>% 
  mutate(across(everything(), ~replace(., is.na(.), "Missing Data"))) %>% 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("", "Number", "Percent" , "Number", "Percent", "Number", "Percent", "Number", "Percent", "Number", "Percent"),
      align = c("l",rep("c",10)),
      caption = "Population Pyramid of Hispanic/Latino Breakdown, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:11, width = "2.58em") %>%  

 add_header_above( align = c("l", rep("c",2)), c("Race/Ethnicity", "Young(0-19)" = 2, "Adults(0-19)" = 2, "Middle Aged (40-59)" = 2, "Older Adults (60-79)" = 2, "Elderly(80+)" = 2),
                    # background = "#cbc9e2", 
                    bold = T, font_size =8) %>% 

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")   


table_1b.2
```



### 3. Median Age of Mexican population, 2018-2022:

```{r}
# analysis

# filter for year 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)

# 1B: Population pyramid of the percentage of Mexican population by age group compared to the rest of the population in Chicago and median age in Chicago (Data source: 2018-2022 ACS data)

df <-  data_chi_2018_22 %>%
  mutate(
    age_group = case_when(
      age < 20 ~ "Young (0-19)",
      age >= 20 & age < 40 ~ "Young Adults (20-39)",
      age >= 40 & age < 60 ~ "Middle-aged (40-59)",
      age >= 60 & age < 80 ~ "Older Adults (60-79)",
      age >= 80 ~ "Elderly (80+)"
    )
  )
# Create survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)


# Calculate weighted population counts by age group and ethnicity

# Calculate weighted population by ethnicity and age group
pop_pyramid <- df %>%
  as_survey_design(weights = perwt) %>% 
  survey_count(race_ethnicity, age_group, name="total_weighted_count")  %>%
  group_by(race_ethnicity) %>%
  mutate(total_weighted_percentage = total_weighted_count / sum(total_weighted_count) * 100,
         total_weighted_percentage  = paste0(round(total_weighted_percentage, 1), "%")) 



# get median age

weighted_age  <- df %>%
  group_by(race_ethnicity) %>%
  summarize(
    weighted_age = matrixStats::weightedMedian(age, perwt)
  ) 



# combined

df_final  <- pop_pyramid %>% left_join(weighted_age)
```


```{r}
# visuals
# visuals

table_1b.2 <- weighted_age  %>% select(race_ethnicity, weighted_age) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
       col.names = c("Race/Ethnicity", "Number"),
      align = c("l",rep("c",1)),
      caption = "Median Age of the Mexican Population, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2, width = "25.8em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")   

table_1b.2


```


### 4. Median Age of Hispanic/Latino breakdown, 2018-2022:

```{r}
# analysis
# analysis

# filter for year 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)

# 1B: Population pyramid of the percentage of Mexican population by age group compared to the rest of Latino Population and median age in Chicago (Data source: 2018-2022 ACS data)

df <-  data_chi_2018_22 %>%
  mutate(
    age_group = case_when(
      age < 20 ~ "Young (0-19)",
      age >= 20 & age < 40 ~ "Young Adults (20-39)",
      age >= 40 & age < 60 ~ "Middle-aged (40-59)",
      age >= 60 & age < 80 ~ "Older Adults (60-79)",
      age >= 80 ~ "Elderly (80+)"
    )
  )
# Create survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)


# Calculate weighted population counts by age group and ethnicity

# Calculate weighted population by ethnicity and age group
pop_pyramid <- df %>%
  as_survey_design(weights = perwt) %>% 
  survey_count(hispan_breakdown, age_group, name="total_weighted_count")  %>%
  group_by(hispan_breakdown) %>%
  mutate(total_weighted_percentage = total_weighted_count / sum(total_weighted_count) * 100,
         total_weighted_percentage  = paste0(round(total_weighted_percentage, 1), "%")) 



# get median age

weighted_age  <- df %>%
  group_by(hispan_breakdown) %>%
  summarize(
    weighted_age = matrixStats::weightedMedian(age, perwt)
  ) %>% mutate(
    weighted_age = round(weighted_age, 1)
  )


# combined

df_final  <- pop_pyramid %>% left_join(weighted_age)
```

```{r}
# visuals

# visuals

table_1b.4 <- weighted_age  %>% select(hispan_breakdown, weighted_age) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
       col.names = c("Race/Ethnicity", "Number"),
      align = c("l",rep("c",1)),
      caption = "Median Age of Hispanic/Latino breakdown, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2, width = "25.8em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")   

table_1b.4
```


## 1.C: Average Family Size of the Mexican Population, 2018-2022:

```{r}
# analysis

# filter for year 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)


# Filter for the head of household 
data_head_of_household <- data_chi_2018_22 %>%
  filter(pernum == 1)

# 1C Average family size of the Mexican population compared to, other Latinos, Black and White populations in Chicago

# Calculate average family size

# Define the survey design using srvyr with only weights
survey_design <- data_head_of_household %>%
  as_survey_design(weights = hhwt)

# Calculate the weighted average family size by group
avg_family_size <- survey_design %>%
  group_by(race_ethnicity) %>%
  summarize(
        avg_family_size = survey_mean(famsize, vartype = "se", na.rm = TRUE)
  ) %>%  mutate(
    avg_family_size = round(avg_family_size, 1)
  )



```

```{r}
# visuals

table_1c <- avg_family_size %>% select(race_ethnicity, avg_family_size) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
       col.names = c("Race/Ethnicity", "Number"),
      align = c("l",rep("c",1)),
      caption = "Average Family Size of the Mexican Population, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2, width = "25.8em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")   

table_1c




```

## 1.D: Income Levels and Poverty

### 1. Income Levels, 2018-2022:

```{r}
# analysis
# filter for 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)

# 1D Income Levels and poverty rates for Mexicans, other Latinos, Black and White Populations in Chicago.

# Filter the data to remove negative and extreme values
filtered_data <- data_chi_2018_22 %>%
  filter(hhincome >= 0 & hhincome < 9999999, pernum == 1)
  
# Define the survey design using srvyr with only weights
survey_design <- filtered_data  %>%
  as_survey_design(weights = hhwt)

# Calculate the weighted average household income by group
weighted_avg_income <- survey_design %>% filter(pernum == 1) %>%
  group_by(race_ethnicity) %>%
  summarize(
    avg_hhincome = survey_mean(hhincome, vartype = "se", na.rm = TRUE)
  )


# weighted median: 

weighted_median_income <- data_chi_2018_22 %>%  filter(pernum == 1) %>%
  group_by(race_ethnicity) %>%
  summarize(
    weighted_median_hhincome = matrixStats::weightedMedian(hhincome,  weights = hhwt)
  ) %>%
  ungroup()


# final df with income levels
income_levels <- weighted_avg_income %>% left_join(weighted_median_income)  %>%
  mutate(
    avg_hhincome = paste0("$", format(avg_hhincome, big.mark = ",", scientific = FALSE)),
    weighted_median_hhincome = paste0("$", format(weighted_median_hhincome, big.mark = ",", scientific = FALSE))
  )
```


```{r}
# visuals



table_1d.1 <- income_levels %>% select(race_ethnicity, avg_hhincome, weighted_median_hhincome) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Average Household Income", "Median Household Income"),
      align = c("l",rep("c",2)),
      caption = "Average and Median Income of Mexican Population, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "12.9em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")   

table_1d.1
```


### 2. Income Levels by Hispanic/Latino breakdown, 2018-2022:

```{r}
# analysis
# filter for 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)

# 1D Income Levels and poverty rates for Mexicans, other Latinos, Black and White Populations in Chicago.

# Filter the data to remove negative and extreme values
filtered_data <- data_chi_2018_22 %>%
  filter(hhincome >= 0 & hhincome < 9999999, pernum == 1)
  
# Define the survey design using srvyr with only weights
survey_design <- filtered_data  %>%
  as_survey_design(weights = hhwt)

# Calculate the weighted average household income by group
weighted_avg_income <- survey_design %>% filter(pernum == 1) %>%
  group_by(hispan_breakdown) %>%
  summarize(
    avg_hhincome = survey_mean(hhincome, vartype = "se", na.rm = TRUE)
  )


# weighted median: 

weighted_median_income <- data_chi_2018_22 %>%  filter(pernum == 1) %>%
  group_by(hispan_breakdown) %>%
  summarize(
    weighted_median_hhincome = matrixStats::weightedMedian(hhincome,  weights = hhwt)
  ) %>%
  ungroup()


# final df with income levels
income_levels <- weighted_avg_income %>% left_join(weighted_median_income)  %>%
  mutate(
    avg_hhincome = paste0("$", format(avg_hhincome, big.mark = ",", scientific = FALSE)),
    weighted_median_hhincome = paste0("$", format(weighted_median_hhincome, big.mark = ",", scientific = FALSE))
  ) %>% mutate(across(everything(), ~replace(., is.na(.), "Missing Data")))

```

```{r}
# visuals


table_1d.2 <- income_levels %>% select(hispan_breakdown, avg_hhincome, weighted_median_hhincome) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Average Household Income", "Median Household Income"),
      align = c("l",rep("c",2)),
      caption = "Average and Median Income of Hispanic/Latino breakdown, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "12.9em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")   

table_1d.2
```


### 3. Poverty Rates, 2018-2022: Mexican Population at or Below Poverty Threshold, 2018-2022

```{r}
# analysis

# poverty
# filter for 2022

data_chi_2018_22 <- usa_data %>% filter(year == 2022)

# Define the survey design using srvyr with only weights
survey_design2 <- data_chi_2018_22  %>%
  as_survey_design(weights = perwt)
  

  
# Calculate poverty rates by group

# Calculate total weighted count by race_category and ethnicity
total_weighted_pop_count <- survey_design2 %>%
  group_by(race_ethnicity) %>%
  summarise(total_weighted_pop_count = survey_total())

# Calculate total weighted count in poverty by race_category and ethnicity
total_weighted_poverty_count <- survey_design2 %>%
  filter(poverty <= 100) %>%
  group_by(race_ethnicity) %>%
  summarise(total_weighted_poverty_count = survey_total())

# Combine total counts and poverty counts
combined <- left_join(total_weighted_pop_count, total_weighted_poverty_count)


poverty_rate <- combined %>% mutate(poverty_rate = (total_weighted_poverty_count/total_weighted_pop_count)*100,
                                    poverty_rate   = paste0(round(poverty_rate, 1), "%")) 

```


```{r}
# visuals


table_1d.4 <- poverty_rate  %>% select(race_ethnicity, total_weighted_poverty_count, poverty_rate) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Number", "Percent"),
      align = c("l",rep("c",2)),
      caption = "Mexican Population at or Below Poverty Threshold, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "12.9em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")   

table_1d.4

```


## 1E: Top 10 Mexican Community Areas

```{r}
# analysis
top_10 <- chicago_ca_pop %>% as.data.frame() %>% select(commnty, totl_pp, ttl_hs_,ttl_mxc, prc_mx_, prc_mxc) %>%   mutate(commnty = str_to_title(commnty)) %>% arrange(desc(prc_mxc)) %>%  slice_max(order_by = prc_mxc, n = 10)


# top 10 row
totals <- top_10 %>%
  summarise(
    commnty = "Top 10 Community Areas",
    totl_pp = sum(totl_pp, na.rm = TRUE),
    ttl_hs_ = sum(ttl_hs_, na.rm = TRUE),
    ttl_mxc = sum(ttl_mxc, na.rm = TRUE),
    prc_mx_ = (ttl_mxc/ttl_hs_) * 100,
    prc_mxc = (ttl_mxc/totl_pp) * 100
  )



# rest of community areas
min_67 <- chicago_ca_pop %>% as.data.frame() %>% select(commnty, totl_pp, ttl_hs_,ttl_mxc, prc_mx_, prc_mxc) %>%   mutate(commnty = str_to_title(commnty)) %>% slice_min(order_by = prc_mxc, n = 67)


# the rest
totals_min <- min_67 %>%
  summarise(
    commnty = "Rest of Community Areas",
    totl_pp = sum(totl_pp, na.rm = TRUE),
    ttl_hs_ = sum(ttl_hs_, na.rm = TRUE),
    ttl_mxc = sum(ttl_mxc, na.rm = TRUE),
    prc_mx_ = (ttl_mxc/ttl_hs_) * 100,
    prc_mxc = (ttl_mxc/totl_pp) * 100
  )



# all of chicago
df_all <- chicago_ca_pop %>% as.data.frame() %>% select(commnty, totl_pp, ttl_hs_,ttl_mxc, prc_mx_, prc_mxc) %>%   mutate(commnty = str_to_title(commnty)) %>% 
  summarise(
    commnty = "Total Population of Chicago",
    totl_pp = sum(totl_pp, na.rm = TRUE),
    ttl_hs_ = sum(ttl_hs_, na.rm = TRUE),
    ttl_mxc = sum(ttl_mxc, na.rm = TRUE),
    prc_mx_ = (ttl_mxc/ttl_hs_) * 100,
    prc_mxc = (ttl_mxc/totl_pp) * 100
  )





df_final <- rbind(top_10, totals, totals_min, df_all) %>% mutate(
                                    prc_mx_   = paste0(round(prc_mx_, 1), "%"),
                                     prc_mxc   = paste0(round(prc_mxc, 1), "%")) 

```


```{r}
# visuals


table_1e <- df_final   %>% select(commnty, totl_pp, ttl_hs_, ttl_mxc, prc_mx_ , prc_mxc) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Top 10 Mexican Communities", "Total Pop", "Hispanic/Latino Pop", "Mexican Pop", "% Mexicans of Hispanic/Latino", "% Mexicans of Total Pop"),
      align = c("l",rep("c",5)),
      caption = "Mexican Population , 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:6, width = "5.16em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")   

table_1e
```




# Education

## 2.A: Number and percentages of Mexican population in public and private schools.

```{r}
# analysis
# select variables
data_chi_2018_22 <- usa_data  %>% filter(year == 2022) %>% select(year:gqtyped, perwt, hispan, race, race_ethnicity, school, schltype)



# Number and Percentage of Mexican population in public and private schools compared to other groups

# Step 1: Filter for individuals enrolled in school
enrolled_in_school <- data_chi_2018_22 %>%
  filter(school == 2)


# Define the survey design
survey_design <- enrolled_in_school %>%
  as_survey_design(weights = perwt)

# Step 3: Calculate the total weighted count for each race/ethnicity group (denominator)
total_counts <- survey_design %>%
  group_by(race_ethnicity) %>%
  summarize(total_weighted_count = survey_total(vartype = "se"))

# Step 4: Calculate the weighted count of race/ethnicity in public and private schools (numerator)
school_counts <- survey_design %>%
  group_by(schltype, race_ethnicity) %>%
  summarize(weighted_count = survey_total(vartype = "se"))

# Step 5: Calculate the percentage of race/ethnicity groups in public and private schools
school_percentages <- school_counts %>%
  left_join(total_counts, by = "race_ethnicity") %>%
    mutate(percentage = paste0(round((weighted_count / total_weighted_count) * 100, 2), "%"))

# Step 6: Recode schltype for clarity
df_all <- school_percentages %>%
  mutate(schltype = case_when(
    schltype == 2 ~ "Public",
    schltype == 3 ~ "Private",
    TRUE ~ NA_character_
  ))
```


```{r}
# visual


table_2a <- df_all %>%

pivot_wider(id_cols =  race_ethnicity, names_from = "schltype",  values_from = c(weighted_count, total_weighted_count, percentage)) %>%
  select(race_ethnicity, weighted_count_Public, percentage_Public, weighted_count_Private, percentage_Private) %>%

   # using kable

  kbl(, booktabs = T,
      col.names = c("", "Number", "Percent" , "Number", "Percent"),
      align = c("l",rep("c",4)),
      caption = "Number and percentages of Mexican population in public and private schools in Chicago, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:5, width = "6.45em")   %>%
  add_header_above( align = c("l", rep("c",2)), c("Race/Ethnicity", "Public Schools" = 2, "Private Schools" = 2),
                    # background = "#cbc9e2",
                    bold = T, font_size =8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")

table_2a
```




## 2.C: Percentage of Limited English Proficient


```{r}

# analysis

data_chi_2018_22 <- usa_data %>%  filter(year == 2022) %>% select(year:gqtyped, perwt, hispan, race, race_ethnicity, school, speakeng)

# Percentage of Limited English Proficient.

# Step 1: Define Survey Design
survey_design <- data_chi_2018_22 %>%
  as_survey_design(weights = perwt)

# Step 2: Group by race_ethnicity and calculate weighted counts and totals
lep_rate_by_ethnicity <- survey_design %>%
  group_by(race_ethnicity) %>%
  summarise(
    lep_count = survey_total(speakeng %in% c(1, 6)),
    total_count = survey_total(),
    lep_percentage = 100 * survey_mean(speakeng %in% c(1, 6), vartype = "se")
  ) %>%
  mutate(lep_percentage = paste0(round(lep_percentage, 1), "%"))


```


```{r}
# visual



table_2c <- lep_rate_by_ethnicity %>% select(race_ethnicity, lep_count, lep_percentage) %>%

   # using kable

  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Number", "Percent"),
      align = c("l",rep("c",2)),
      caption = "Number and percentages of Mexican population with limited English proficiency, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "12.9em") %>%

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")

table_2c

```

## 2.D: Number and Percentages of Mexican non-citizens enrolled in public schools

```{r}
# analysis


# Step 1: Filter for individuals enrolled in school
enrolled_in_school <- usa_data  %>%  filter(year == 2022) %>%
  filter(school == 2)


# Step 2: Filter for non-citizen individuals enrolled in public schools
enrolled_in_public_schools <- enrolled_in_school %>%
  filter(schltype == 2 & citizen == 3)

# Step 3: Create survey design

survey_design_school <- enrolled_in_school %>%
  as_survey_design(weights = perwt)

survey_design_public_schools <- enrolled_in_public_schools %>%
  as_survey_design(weights = perwt)


# Step 4: Calculate denominator (total count enrolled in school) for each subgroup
denominator_counts <- survey_design_school %>%
  group_by(race_ethnicity) %>%
  summarise(num_enrolled_all_school = survey_total())



# Step 5: Calculate numerator (count of public school enrollment) for each subgroup
numerator_counts <- survey_design_public_schools %>%
  group_by(race_ethnicity) %>%
  summarise(num_enrolled_public = survey_total())


# Step 6: Calculate percentages and estimate SEs

percentages <- numerator_counts %>%
  left_join(denominator_counts, by = "race_ethnicity") %>%
  mutate(percentage = 100 * num_enrolled_public / num_enrolled_all_school) %>%
  mutate(percentage = paste0(round(percentage, 1), "%"))




```


```{r}
# visual

table_2d <- percentages %>% select(race_ethnicity, num_enrolled_public, percentage) %>%

   # using kable

  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Number", "Percent"),
      align = c("l",rep("c",2)),
      caption = "Number and percentages of Mexican non-citizens enrolled in public schools, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "12.9em") %>%
row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%
  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")

table_2d

```


## 2.E: Number and Percentages of Mexican 21-24 years old without a high school diploma


```{r}


df <- usa_data  %>%  filter(year == 2022) %>% select(race_ethnicity, schltype, school, gradeatt, perwt, educ, age)


# Create a survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)


# method: Look at 21-24 year olds without a high school diploma out of all 21-24 year olds


# Calculate numerator: weighted count of students aged 21-24 not in school and without a high school diploma
numerator_not_in_school <- survey_design %>%
  filter(age >= 21, age <= 24, school == 1, educ %in% c("0", "1", "2", "3", "4", "5")) %>%
  group_by(race_ethnicity) %>%
  summarise(not_in_school = survey_total(vartype = "se"))

# Calculate denominator: weighted count of total students aged 21-24
denominator_total_students <- survey_design %>%
  filter(age >= 21, age <= 24) %>%
  group_by(race_ethnicity) %>%
  summarise(total_students = survey_total(vartype = "se"))


# Calculate dropout rate by joining numerator and denominator
dropout_data <- numerator_not_in_school %>%
  inner_join(denominator_total_students, by = "race_ethnicity") %>%
  mutate(dropout_rate = (not_in_school / total_students) * 100) %>%
  mutate(dropout_rate = paste0(round(dropout_rate, 1), "%"))

```


```{r}
# visual


table_2e <- dropout_data %>% select(race_ethnicity, not_in_school, dropout_rate) %>%

   # using kable

  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Number", "Percent"),
      align = c("l",rep("c",2)),
      caption = "Number and percentages of Mexican people aged 21-24 years old without a high school diploma, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "12.9em") %>%
  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")

table_2e

```




## 2.F: Number and Percentage of Mexican students attending undergraduate/graduate colleges or professional schools



```{r}

## select variables
df <- usa_data  %>%  filter(year == 2022) %>% select(race_ethnicity, school, gradeatt, perwt, educ, age)


# Create survey design object
survey_design <-df %>%
  as_survey_design(weights = perwt)

# Number and percentage of Mexican students attending area colleges

# 18-24 year olds


# Group by race_ethnicity, filter for enrolled in college/grad school and ages 18-24
numerator_18_24 <- survey_design %>%  filter(school == 2, gradeatt %in% c(6, 7), age >= 18, age <= 24) %>%
  group_by(race_ethnicity) %>%
  summarise(college_attendees = survey_total(vartype = "se"))


# denominator calculate total number of 18-24 year olds
denominator_18_24 <- survey_design %>% filter(age >= 18, age <= 24) %>%
  group_by(race_ethnicity) %>%
  summarise(total_students = survey_total(vartype = "se"))


# Calculate percentage of students attending college within each racial and ethnic group
college_attendance_18_24 <- left_join(numerator_18_24, denominator_18_24, by = "race_ethnicity") %>%
  mutate(percentage_college_students = (college_attendees / total_students) * 100) %>% mutate(age = "18_24", percentage_college_students = paste0(round(percentage_college_students, 1), "%"))



# 25-34 year olds

# Group by race_ethnicity, filter for enrolled in college/grad school and ages 18-24
numerator_25_34 <- survey_design %>%  filter(school == 2, gradeatt %in% c(6, 7), age >= 25, age <= 34) %>%
  group_by(race_ethnicity) %>%
  summarise(college_attendees = survey_total(vartype = "se"))


# denominator calculate total number of 18-24 year olds
denominator_25_34 <- survey_design %>% filter(age >= 25, age <= 34) %>%
  group_by(race_ethnicity) %>%
  summarise(total_students = survey_total(vartype = "se"))


# Calculate percentage of students attending college within each racial and ethnic group
college_attendance_25_34 <- left_join(numerator_25_34, denominator_25_34, by = "race_ethnicity") %>%
  mutate(percentage_college_students = (college_attendees / total_students) * 100) %>% mutate(age = "25_34", percentage_college_students = paste0(round(percentage_college_students, 1), "%"))


# combine

df_college <- rbind(college_attendance_18_24, college_attendance_25_34)

```



```{r}
table_2f <- df_college %>% pivot_wider(id_cols =  c(race_ethnicity), names_from = "age", values_from = c(college_attendees, percentage_college_students)) %>% select(race_ethnicity,  college_attendees_18_24,  percentage_college_students_18_24,  college_attendees_25_34,  percentage_college_students_25_34) %>%

   # using kable

  kbl(, booktabs = T,
      col.names = c("", "Number", "Percent" , "Number", "Percent"),
      align = c("l",rep("c",4)),
      caption = "Number and Percentage of Mexican students attending undergraduate/graduate colleges or professional schools, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em")  %>%
  column_spec(2:5, width = "6.45em")  %>%
  add_header_above( align = c("l", rep("c",2)), c("Race/Ethnicity", "Ages 18-24" = 2, "Ages 25-34" = 2),
                    # background = "#cbc9e2",
                    bold = T, font_size =8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")


table_2f

```

\blandscape

## 2.G: Educational Attainment

### 1. Of Mexicans 25 and Older



```{r}
df <- usa_data  %>%  filter(year == 2022) %>% select(race_ethnicity, educd, age, perwt)

# collapse educdational categories
df <- df %>%
  mutate(educd = as.character(educd)) %>%
  mutate(education_level = case_when(
    educd %in% c("1") ~ "NA",
    educd %in% c("2") ~ "No Schooling Completed",
    educd %in% c("11", "12", "14", "15", "16", "17", "22", "23", "25", "26", "30", "40", "50", "61") ~ "Less than High School",
    educd %in% c("63", "64") ~ "Regular High School Diploma, GED or Alternative Credential",
    educd %in% c("65", "71") ~ "Some College, No Degree", 
    educd %in% c("81") ~ "Associate's Degree",
    educd %in% c("101") ~ "Bachelor's Degree",
    educd %in% c("114", "115") ~ "Master's Degree or Professional Degree Beyond Bachelor's",
    TRUE ~ "Other"  # Default case if educd is not in the specified categories
  ))


# Create survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)

# Calculate numerator: weighted count of individuals by education level and race_ethnicity
numerator <- survey_design %>%
  filter(age >= 25) %>%
  group_by(race_ethnicity, education_level) %>%
  summarise(weighted_n = survey_total(vartype = "se"))

# Calculate denominator: total population by race_ethnicity
denominator <- survey_design %>%
  filter(age >= 25) %>%
  group_by(race_ethnicity) %>%
  summarise(total_pop = survey_total(vartype = "se"))

# Merge numerator and denominator by race_ethnicity
education_levels <- c("No Schooling Completed", "Less than High School", "Regular High School Diploma, GED or Alternative Credential","Some College, No Degree", "Associate's Degree", "Bachelor's Degree", "Master's Degree or Professional Degree Beyond Bachelor's")

education_rates <- numerator %>%
  left_join(denominator, by = "race_ethnicity") %>%
  mutate(educational_rate = (weighted_n / total_pop) * 100,
  education_level = factor(education_level, levels = education_levels))    %>%  arrange(race_ethnicity, education_level)  %>% mutate(educational_rate = paste0(round(educational_rate, 1), "%")) %>% filter(!is.na(education_level))
  

```


```{r}
table_2g <- education_rates %>% select(race_ethnicity, education_level, weighted_n, educational_rate)  %>% pivot_wider(id_cols =  c(race_ethnicity), names_from = "education_level", values_from = c(weighted_n, educational_rate))   %>% select(
    race_ethnicity,
    `weighted_n_No Schooling Completed`, `educational_rate_No Schooling Completed`,
    `weighted_n_Less than High School`, `educational_rate_Less than High School`,
    `weighted_n_Regular High School Diploma, GED or Alternative Credential`, `educational_rate_Regular High School Diploma, GED or Alternative Credential`,
    `weighted_n_Some College, No Degree`, `educational_rate_Some College, No Degree`,
    `weighted_n_Associate's Degree`, `educational_rate_Associate's Degree`,
    `weighted_n_Bachelor's Degree`, `educational_rate_Bachelor's Degree`,
    `weighted_n_Master's Degree or Professional Degree Beyond Bachelor's`, `educational_rate_Master's Degree or Professional Degree Beyond Bachelor's`
  ) %>%


 
   # using kable 
  
  kbl(
  , booktabs = TRUE,
  col.names = c("", "Number", "Percent", "Number", "Percent", "Number", "Percent", "Number", "Percent", "Number", "Percent", "Number", "Percent", "Number", "Percent"),
  align = c("l", rep("c", 14)),
  caption = "Educational Attainment of Mexicans 25 and Older, 2018-2022",
  format.args = list(big.mark = ","),
  linesep = ""
) %>%
  kable_classic(
    full_width = FALSE,
    font_size = 8,
    html_font = "Arial",
    position = "center",
    latex_options = "HOLD_position"
  ) %>%
  column_spec(1, width = "14.8em") %>%
  column_spec(2:15, width = "1.8em") %>%
  add_header_above(
    align = c("l", rep("c", 2)),
    c(
      "Race/Ethnicity", 
      "No Schooling\nCompleted" = 2, 
      "Less than\nHigh School" = 2, 
      "High School\nDiploma or GED" = 2, 
      "Some College,\nNo Degree" = 2, 
      "Associate's\nDegree" = 2, 
      "Bachelor's\nDegree" = 2, 
      "Master's Degree or\nProfessional Degree" = 2
    ),
    bold = TRUE, 
    font_size = 8
  ) %>%
  footnote(
    general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
    general_title = ""
  ) 
table_2g


```


\elandscape


\blandscape


### 2. Educational Attainment of Mexicans by nativity

```{r}
# analysis
top_10 <- chicago_ca_pop %>% as.data.frame() %>% select(commnty, totl_pp, ttl_hs_,ttl_mxc, prc_mx_, prc_mxc) %>%   mutate(commnty = str_to_title(commnty)) %>% arrange(desc(prc_mxc)) %>%  slice_max(order_by = prc_mxc, n = 10)


# top 10 row
totals <- top_10 %>%
  summarise(
    commnty = "Top 10 Community Areas",
    totl_pp = sum(totl_pp, na.rm = TRUE),
    ttl_hs_ = sum(ttl_hs_, na.rm = TRUE),
    ttl_mxc = sum(ttl_mxc, na.rm = TRUE),
    prc_mx_ = (ttl_mxc/ttl_hs_) * 100,
    prc_mxc = (ttl_mxc/totl_pp) * 100
  )



# rest of community areas
min_67 <- chicago_ca_pop %>% as.data.frame() %>% select(commnty, totl_pp, ttl_hs_,ttl_mxc, prc_mx_, prc_mxc) %>%   mutate(commnty = str_to_title(commnty)) %>% slice_min(order_by = prc_mxc, n = 67)


# the rest
totals_min <- min_67 %>%
  summarise(
    commnty = "Rest of Community Areas",
    totl_pp = sum(totl_pp, na.rm = TRUE),
    ttl_hs_ = sum(ttl_hs_, na.rm = TRUE),
    ttl_mxc = sum(ttl_mxc, na.rm = TRUE),
    prc_mx_ = (ttl_mxc/ttl_hs_) * 100,
    prc_mxc = (ttl_mxc/totl_pp) * 100
  )



# all of chicago
df_all <- chicago_ca_pop %>% as.data.frame() %>% select(commnty, totl_pp, ttl_hs_,ttl_mxc, prc_mx_, prc_mxc) %>%   mutate(commnty = str_to_title(commnty)) %>% 
  summarise(
    commnty = "Total Population of Chicago",
    totl_pp = sum(totl_pp, na.rm = TRUE),
    ttl_hs_ = sum(ttl_hs_, na.rm = TRUE),
    ttl_mxc = sum(ttl_mxc, na.rm = TRUE),
    prc_mx_ = (ttl_mxc/ttl_hs_) * 100,
    prc_mxc = (ttl_mxc/totl_pp) * 100
  )





df_final <- rbind(top_10, totals, totals_min, df_all) %>% mutate(
                                    prc_mx_   = paste0(round(prc_mx_, 1), "%"),
                                     prc_mxc   = paste0(round(prc_mxc, 1), "%")) 

```


```{r}
# visuals


table_1e <- df_final   %>% select(commnty, totl_pp, ttl_hs_, ttl_mxc, prc_mx_ , prc_mxc) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Top 10 Mexican Communities", "Total Pop", "Hispanic/Latino Pop", "Mexican Pop", "% Mexicans of Hispanic/Latino", "% Mexicans of Total Pop"),
      align = c("l",rep("c",5)),
      caption = "Mexican Population , 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:6, width = "5.16em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")   

table_1e

```

# Housing & Community Development

## 3.A: Rates of home ownership and rental housing among Mexicans with historical trends and comparisons to other groups.

```{r}
# homeownership = read.csv("Data Tables/3.A.homeownership.csv" )

table_a3 <-  homeownership %>%

  filter(ownershp_f == "Owned or being bought (loan)") %>%

  pivot_wider(id_cols =  c(race_ethnicity, ownershp_f), names_from = "year", values_from = c(count, per, per2)) %>%

  mutate(diff2000_2022 = count_2022 - count_2000,
         diff_per = round(per_2022 - per_2000, 4),
         diff_per2 = paste0(diff_per,"%")
         ) %>%
  select(race_ethnicity, count_2000, per2_2000, count_2012, per2_2012, count_2022, per2_2022, diff2000_2022, diff_per2) %>%

   # using kable

  kbl(, booktabs = T,
      col.names = c("", "Number", "Percent" , "Number", "Percent", "Number", "Percent", "Number", "Percent"),
      align = c("l",rep("c",8)),
      caption = "Homeownership by Race/Ethnicity in Chicago, 2000, 2008-2012, and 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:9, width = "3.8em") %>%
  add_header_above( align = c("l", rep("c",4)), c("Race/Ethnicity", "2000" = 2, "2008-2012" = 2, "2018-2022" = 2, "Change from\n2000 to 2018-2022" = 2),
                    # background = "#cbc9e2",
                    bold = T, font_size =8) %>%
  # row_spec(0, bold = T,
  #          # background = "#f2f0f7",
  #          font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2000, 2008-2012, 2018-2022). Tabulations by Great Cities Institute",
           general_title = "")

table_a3

```


## 3.B: Number and percentage of Mexicans who, live in crowded housing, or are rent-burdened.

```{r}


## Be careful rooms == 0 is NA but it is overcrowded
overcrowded = usa_data %>%
  filter( city == 1190, pernum == 1, year == 2022) %>%  #### dont forget to filter PUMA   ## Should I filter pernum or not?


  as_survey_design(weights = hhwt) %>%
  survey_count(year, race_ethnicity, rooms, numprec, name="count") %>%
  mutate(p_per_room = numprec/rooms,
         overcrowded = if_else(p_per_room >1, "Overcrowded", "Not Overcowded")) %>%

  group_by(year, race_ethnicity) %>%
  mutate(total = sum(count, na.rm = T)) %>%
  filter(rooms != 0 ) %>%  ## rooms == 0 is NA but it is overcrowded
  ungroup() %>%
  group_by(year, race_ethnicity, overcrowded, total) %>%

  summarise(count_sum = sum(count)) %>%
  mutate(per = 100*round(count_sum/total, 4),
         per2 = paste0(per,"%")) %>%
  ungroup()

```


### 1. Crowded Housing

```{r}

table_3.b1 <- overcrowded %>%

  filter(overcrowded == "Overcrowded" ) %>%

  select(race_ethnicity, count_sum , per2) %>%

   # using kable

  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Number", "Percent"  ),
      align = c("l",rep("c",2)),
      caption = "Number and Percentage of Households Living in Crowded Housing
      by Race/Ethnicity in Chicago, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
  kable_classic(full_width = T,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "12.9em") %>%
  # add_header_above( c("Race/Ethnicity", "2000" = 2, "2008-2012" = 2, "2018-2022" = 2, "Change from\n2000 to 2018-2022" = 2),
  #                   # background = "#cbc9e2",
  #                   bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>%

  add_footnote(c("Housing is defined as overcrowded if more than one person in the room.", "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute"),
 notation = "none")

table_3.b1

```


### 2. Rent burdened

```{r}
rent_burdened = usa_data %>%
  select(pernum, city, year, rentgrs, hhincome, ownershp_f, hhwt, race_ethnicity ) %>%
  filter( city == 1190, pernum == 1, year == 2022) %>%

  group_by(race_ethnicity, ownershp_f) %>%
  mutate(total = sum(hhwt, na.rm = T)) %>%
  ungroup() %>%
  filter(hhincome != 9999999 ) %>%
  filter(rentgrs!= 0) %>%

  mutate(monthly_income = hhincome/12,
        rent_income = rentgrs/monthly_income,
         burdened_30 = if_else(rent_income >0.3 , "More than 30%","Less than 30%"),
         burdened_50 = if_else(rent_income >0.5, "More than 50%", "Less than 50%")) %>%
  as_survey_design(weights = hhwt) %>%
  survey_count(year, race_ethnicity, total,ownershp_f, burdened_30, burdened_50 , name="count") %>%
  mutate(per = 100*round(count/total, 4),
         per2 = paste0(per,"%"))


  ####### prepare data for the table

table_3.b2 = rent_burdened %>%
  filter( burdened_30 != "Less than 30%") %>%
  group_by(race_ethnicity ) %>%

  summarise(more_30_count = sum(count[burdened_30== "More than 30%"]),
            more_50_count = sum(count[burdened_50== "More than 50%"]),
            more_30_per = 100 *round(more_30_count/total, 4),
            more_30_per2 = paste0(more_30_per, "%"),
            more_50_per = 100 *round(more_50_count/total, 4),
            more_50_per2 = paste0(more_50_per, "%")) %>%
  distinct()



table_3.b2_2 <- table_3.b2 %>%
  select(race_ethnicity, more_30_count, more_30_per2, more_50_count, more_50_per2) %>%

  # using kable

  kbl(booktabs = T,
      col.names = c("", "Number", "Percent" , "Number", "Percent" ),
      align = c("l",rep("c",4)),
      caption = "Rent Burdened households by Race/Ethnicity in Chicago, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:5, width = "6.45em") %>%
  add_header_above( align = c("l", rep("c",2)), c("Race/Ethnicity", "More than 30%" = 2, "More than 50%" = 2),
                    # background = "#cbc9e2",
                    bold = T, font_size =8) %>%
  # row_spec(0, bold = T,
  #          # background = "#f2f0f7",
  #          font_size = 8) %>%

  # footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute.Rent Burdened Households Defined as Spending 30% or More of Income on Rent",
  #          general_title = "") %>%
  add_footnote(c("Rent Burdened Households Defined as Spending 30% or More of Income on Rent", "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute"),
 notation = "none")


table_3.b2_2
```


### 3. Own Cost Burdened

```{r}

owncost_burdened = usa_data %>%
  select(pernum, city, year, owncost, hhincome, ownershp_f, hhwt, race_ethnicity ) %>%
  filter( city == 1190, pernum == 1, year == 2022) %>%  #### dont forget to filter PUMA   ## Should I filter pernum or not?

  group_by(race_ethnicity, ownershp_f) %>%
  mutate(total = sum(hhwt, na.rm = T)) %>%
  ungroup() %>%
  filter(hhincome != 9999999 ) %>%
  filter(owncost!= 99999) %>%

  mutate(monthly_income = hhincome/12,
         owncost_income = owncost/monthly_income,
         burdened_30 = if_else(owncost_income >0.3 , "More than 30%","Less than 30%"),
         burdened_50 = if_else(owncost_income >0.5, "More than 50%", "Less than 50%")) %>%

  as_survey_design(weights = hhwt) %>%
  survey_count(year, race_ethnicity, total,ownershp_f, burdened_30, burdened_50 , name="count") %>%
  mutate(per = 100*round(count/total, 4),
         per2 = paste0(per,"%"))



####### prepare data for the table

table_3.b3 = owncost_burdened %>%
  filter( burdened_30 != "Less than 30%") %>%
  group_by(race_ethnicity ) %>%

  summarise(more_30_count = sum(count[burdened_30== "More than 30%"]),
            more_50_count = sum(count[burdened_50== "More than 50%"]),
            more_30_per = 100 *round(more_30_count/total, 4),
            more_30_per2 = paste0(more_30_per, "%"),
            more_50_per = 100 *round(more_50_count/total, 4),
            more_50_per2 = paste0(more_50_per, "%")) %>%
  distinct()



table_3.b3_2 <- table_3.b3 %>%
  select(race_ethnicity, more_30_count, more_30_per2, more_50_count, more_50_per2) %>%

  # using kable

  kbl(booktabs = T,
      col.names = c("", "Number", "Percent" , "Number", "Percent" ),
      align = c("l",rep("c",4)),
      caption = "Cost-Burdened Homeowners by Race and Ethnicity in Chicago (2018-2022)",
      format.args = list(big.mark = ","),
      linesep = "", table.attr = "style='width:30%;'") %>%
 kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:5, width = "6.45em") %>%
  add_header_above(align = c("l", rep("c",2)), c("Race/Ethnicity", "More than 30%" = 2, "More than 50%" = 2),
                    # background = "#cbc9e2",
                    bold = T, font_size =8) %>%
  # row_spec(0, bold = T,
  #          # background = "#f2f0f7",
  #          font_size = 8) %>%


  add_footnote(c("Own Cost Burdened Households Defined as ?", "Source: IPUMS-USA database (2018-2022).Tabulations by Great Cities Institute"),
 notation = "none")

table_3.b3_2
```


## 3.D: House Value

```{r}

community_shp <- read_sf("C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/Boundaries - Community Areas (current)/geo_export_2081dd0e-84f5-45c8-b501-f07b67ad9491.shp") %>%
  st_transform( crs = 4326) %>%
  select(community,geometry)


chicago_shp <- read_sf("C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/shp files/selected_centroid_2020.shp") %>%
  select(GEOID, geometry) %>%
  st_transform( crs = 4326)


census_centroids_2022 <- st_centroid(chicago_shp)

# Spatial join: attach community area names to census tracts based on centroid location
census_community_2022 <- st_join(census_centroids_2022,
                                 community_shp,
                                 join = st_within) %>%
  mutate(lable = str_to_title(community)) %>%
  mutate(lable = gsub(" ", "\n", lable))

# write_sf(census_community_2022, "C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/shp files/census_community_2022.shp")

# search_variables <- load_variables(2022,
#                          dataset = "acs5",
#                          cache = TRUE)
#
# view(search_variables)

# options(tigris_use_cache = TRUE)

house_value_data <-  get_acs(
  cache_table = TRUE,
  geography = "tract",
  variables = c("Not Hispanic or Latino"="B03001_002",
                "Hispanic or Latino"="B03001_003",
                "Mexican" = "B03001_004",
                "total_pop"= "B03001_001"),

  summary_var =  "B25077_001",
  state = 17,
  year = 2022) %>%
  rename("Mvalue" = "summary_est") %>%

  filter(GEOID %in% c(chicago_shp$GEOID)) %>%
  left_join(census_community_2022 %>% st_drop_geometry(), by = "GEOID") %>%
  pivot_wider(id_cols = c(GEOID , NAME, Mvalue, community ), names_from = variable, values_from = estimate) %>%

  group_by(community) %>%
  summarise(total_his = sum(`Hispanic or Latino`, na.rm = T),
         total_mexican = sum(Mexican, na.rm = T),
         total_pop = sum(total_pop, na.rm = T),
         prc_mexican = total_mexican/total_pop,
         Mvalue = median(Mvalue, na.rm = T))

comunity_house_value_shp <- left_join(community_shp, house_value_data,  by = join_by(community == community)) %>%
  mutate(lable = str_to_title(community)) %>%
  mutate(lable = gsub(" ", "\n", lable))


```



```{r fig.height=11, fig.width=8}
value_map_2020 <-

  tm_shape(comunity_house_value_shp, bbox = bbox_new) +
  tm_polygons(col = "Mvalue",
              style = "quantile",
              border.col = "white",
              palette="Blues",
              alpha = 0.7,
              n = 5,
              title = "Median House Values",
              lwd = 1) +

  tm_shape(comunity_house_value_shp %>% filter(prc_mexican>=0.5)) +
  tm_borders(col = "#9b2226",
             alpha = 1,
             lwd = 2)+
  tm_text("lable" , size = 0.7, alpha = 0.7, fontface="bold", fontfamily = "sans") +

  tm_shape(Chicago_boundary_shp) +
  tm_borders(col = "#343a40",
             alpha = 1,
             lwd = 2.5) +

  tm_layout( frame = TRUE,
             # main.title.position = c("left", "top"),
             # main.title = "Density of Hispanic or Latino Population by their Origins in Chicago, 2010",
             # main.title.size = 1.2,
            legend.outside = FALSE,
            legend.width = 1.5,
            legend.title.size = .9,
            legend.text.size = 0.8,
            legend.title.fontface = "bold",
            # legend.position = c("left", "bottom"),
            legend.position = c(0.03, 0.12),
            legend.bg.color = "white",
            legend.bg.alpha = .3) +       # manually position legend) +

  tm_credits("Data source:\n5-year ACS (2018-2022)\nMap Generated by:The Great Cities Institute",
             fontface = "bold",
             position = c("left","bottom"), size = 0.8)+


  tm_credits("Median House Value in Chicago, 2018-2022",
             fontface = "bold",
             position = c("left","top"), size = 1.25)+


  tm_add_legend("line",
                labels = c("Chicago Border","" ,"Community Areas with More Than\n50% Share of Mexican Population", ""),
                col = c("#343a40","white" ,"#9b2226", "white"),
                lwd = c(2.5, 2),
                title = "Border Types",
                size = 0.8) +

  # tm_credits("1 dot = 20 People",
  #            position = c(0.03, 0.32), size = 0.8, fontface = "bold") +
  tm_compass(position = c("right", "bottom"), size = 1) +
  tm_scale_bar(position = c("right", "bottom"), width = 0.15)

value_map_2020

```



```{r fig.width=6, fig.height=5 ,fig.align='center'}
####### Barchart: "op Ten Counties in Illinois with the Highest Population in Labor Force
Mhouse_value_plot <- comunity_house_value_shp %>%
  filter(prc_mexican>=0.5) %>%
  arrange(desc(Mvalue)) %>%
  mutate(community2 = str_to_title(community)) %>%
  mutate(community2 = factor(community2),
         community2 = fct_reorder(community2, Mvalue)) %>%
  ggplot(aes(y = community2, x = Mvalue) ) +
  geom_bar( stat = "identity",
            fill = "#6baed6",
            color = "#9b2226",
           width=0.7,
           linewidth = 1) +
  labs(y="", x = "",
       title="Median House Value in Chicago Community Areas with More Than\n50% Share of Mexican Population(2018-2022)",
       caption = "Source: American Community Survey 5-year Estimate (2018-2022) \nTabulations by Great Cities Institute",
       fill="") +
  geom_text(aes(label = paste0(scales::comma(Mvalue))),
            position=position_dodge(width=0.9), hjust = -0.3, vjust = 0.8,
            size = 3) +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 24))+ # Modify labels of ggplot2 barplot
  scale_x_continuous(labels = function(x) paste0(x, "%"), limits = c(0,550000), breaks = seq(0, 550000, by = 550000))+
  theme_plots +
  theme(
        axis.text.y = element_text(size = 8),
        panel.background = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 7, color = "#636363"),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.line.x = element_blank())


  Mhouse_value_plot
```

# Health

## 4A: Health Outcomes in top 10 Mexican Community Areas, 2018-2022:

```{r}
# analysis
# analysis
mexican_top <- df_health %>% arrange(desc(prc_mxc)) %>% filter(prc_mxc >50) %>% select(commnty, obesity_rate, diabetes_rate, asthma_rate, lbw_rate) 

mexican_average_row <- mexican_top %>%
  summarise(
    commnty = "Average of Community Areas with 50% or more Mexican population",
    obesity_rate = round(mean(obesity_rate, na.rm = TRUE), 1),
    diabetes_rate = round(mean(diabetes_rate, na.rm = TRUE), 1),
    asthma_rate = round(mean(asthma_rate, na.rm = TRUE), 1),
    lbw_rate = round(mean(lbw_rate, na.rm = TRUE), 1)
  )

# Add the new row to the existing dataframe
mexican_top <- bind_rows(mexican_top, mexican_average_row)

## white 50% or more

white_top <- df_health %>% arrange(desc(prc_nh_w)) %>% filter(prc_nh_w >50) %>% select(commnty, obesity_rate, diabetes_rate, asthma_rate, lbw_rate) 

white_average_row <- white_top %>%
  summarise(
    commnty = "Average of Community Areas with 50% or more Non-Hispanic White population",
    obesity_rate = round(mean(obesity_rate, na.rm = TRUE), 1),
    diabetes_rate = round(mean(diabetes_rate, na.rm = TRUE), 1),
    asthma_rate = round(mean(asthma_rate, na.rm = TRUE), 1),
    lbw_rate = round(mean(lbw_rate, na.rm = TRUE), 1)
  )

# Add the new row to the existing dataframe
mexican_top <- bind_rows(mexican_top, white_average_row)




## black 50% or more


nh_black_top <- df_health %>% arrange(desc(prc_nh_b)) %>% filter(prc_nh_b >50) %>% select(commnty, obesity_rate, diabetes_rate, asthma_rate, lbw_rate) 

nh_black_average_row <- nh_black_top %>%
  summarise(
    commnty = "Average of Community Areas with 50% or more Non-Hispanic Black population",
    obesity_rate = round(mean(obesity_rate, na.rm = TRUE), 1),
    diabetes_rate = round(mean(diabetes_rate, na.rm = TRUE), 1),
    asthma_rate = round(mean(asthma_rate, na.rm = TRUE), 1),
    lbw_rate = round(mean(lbw_rate, na.rm = TRUE), 1)
  )

# Add the new row to the existing dataframe
df_final <- bind_rows(mexican_top, nh_black_average_row) %>% mutate(across(matches("rate"), ~ ifelse(is.na(.), "missing data", paste0(., "%"))))

```

```{r}
# visuals
table_4a <- df_final %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Community Areas with 50% or more Mexican Population", "Adult Obesity Rate", "Adult Diabetes Rate", "Adult Asthma Rate", "Low Birthweight Rate"),
      align = c("l",rep("c",4)),
      caption = "Health Outcomes, 2022-2023 and 2017-2021",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:5, width = "6.45em") %>%  
row_spec(0, bold = TRUE, font_size = 8) %>%
  row_spec(16:18, bold = TRUE, background = "#f2f0f7") %>%

  footnote(general = "Source: Chicago Health Atlas (2022-2023 and 2017-21). Tabulations by Great Cities Institute",
           general_title = "")   


table_4a
```


## 4.B: Health insurance

### 1. Number and Percentages of Mexicans without Health Insurance, 2018-2022:

```{r}
# analysis
## select variables, filter for year 2022
df <- usa_data %>%  filter(year == 2022) %>% select(race_ethnicity, hcovany, perwt)

# Create survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)
  
  
# Calculate numerator: weighted count of individuals without health insurance by race_ethnicity
numerator_without_insurance <- survey_design %>%
  filter(hcovany == 1) %>% 
  group_by(race_ethnicity) %>%
  summarise(weighted_n_without_insurance = survey_total(vartype = "se"))

# Calculate denominator: total population by race_ethnicity
denominator <- survey_design %>%
  group_by(race_ethnicity) %>%
  summarise(total_pop = survey_total(vartype = "se")) 
  
# calculate rate

# Join numerator and denominator
df_rates <- numerator_without_insurance %>%
  left_join(denominator, by = "race_ethnicity") %>%
  mutate(
    no_insurance_rate = (weighted_n_without_insurance / total_pop) * 100,
    no_insurance_rate = paste0(round(no_insurance_rate, 1), "%"),
      unininsured_sum = sum(weighted_n_without_insurance),
    no_insurance_rate_2 = (weighted_n_without_insurance / unininsured_sum) * 100,
    no_insurance_rate_2 = paste0(round(no_insurance_rate_2, 1), "%")
  )
  



```


```{r}
# visuals
table_4b <- df_rates  %>% select(race_ethnicity, weighted_n_without_insurance, no_insurance_rate, no_insurance_rate_2)   %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Number without health insurance", "No Insurance Rate", "No Health Insurance among Uninsured Rate"),
      align = c("l",rep("c",3)),
      caption = "No Health Insurance, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:4, width = "8.6em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")   


table_4b


```


### 2. Number and Percentages of Mexicans born in U.S. versus Mexicans born in Mexico without job provided Health Insurance, 2018-2022:

```{r}
# analysis
## select variables, filter for year 2022
df <- usa_data %>%  filter(year == 2022) %>% select(mex_foreign_born, hinsemp, perwt) %>% filter(!is.na(mex_foreign_born))

# Create survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)
  
  
# Calculate numerator: weighted count of individuals without job provided health insurance by race_ethnicity
numerator_without_insurance <- survey_design %>%
  filter(hinsemp == 1) %>% 
  group_by(mex_foreign_born) %>%
  summarise(weighted_n_without_insurance = survey_total(vartype = "se"))

# Calculate denominator: total population by race_ethnicity
denominator <- survey_design %>%
  group_by(mex_foreign_born) %>%
  summarise(total_pop = survey_total(vartype = "se")) 
  
# calculate rate

# Join numerator and denominator
df_rates <- numerator_without_insurance %>%
  left_join(denominator, by = "mex_foreign_born") %>%
  mutate(
    no_insurance_rate = (weighted_n_without_insurance / total_pop) * 100,
    no_insurance_rate = paste0(round(no_insurance_rate, 1), "%")
  )
```

```{r}
# visuals
table_4b.2 <- df_rates  %>% select(mex_foreign_born, weighted_n_without_insurance, no_insurance_rate)   %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Mexican Nativity", "Number without Job provided health insurance", "No Job provided health Insurance"),
      align = c("l",rep("c",3)),
      caption = "No Health Insurance, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "8.6em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")   


table_4b.2

```


## 4C: Health behaviors and risk factors

```{r}

# analysis
mexican_top <- df_health %>% arrange(desc(prc_mxc)) %>% filter(prc_mxc >50) %>% select(commnty, drinking_rate, smoking_rate, fruit_veg_rate)  

mexican_average_row <- mexican_top %>%
  summarise(
    commnty = "Average of Community Areas with 50% or more Mexican population",
    drinking_rate = round(mean(drinking_rate, na.rm = TRUE), 1),
    smoking_rate = round(mean(smoking_rate, na.rm = TRUE), 1),
    fruit_veg_rate = round(mean(fruit_veg_rate, na.rm = TRUE), 1)
  )

# Add the new row to the existing dataframe
mexican_top <- bind_rows(mexican_top, mexican_average_row)

## white 50% or more

white_top <- df_health %>% arrange(desc(prc_nh_w)) %>% filter(prc_nh_w >50) %>% select(commnty, drinking_rate, smoking_rate, fruit_veg_rate)  

white_average_row <- white_top %>%
  summarise(
    commnty = "Average of Community Areas with 50% or more Non-Hispanic White population",
    drinking_rate = round(mean(drinking_rate, na.rm = TRUE), 1),
    smoking_rate = round(mean(smoking_rate, na.rm = TRUE), 1),
    fruit_veg_rate = round(mean(fruit_veg_rate, na.rm = TRUE), 1)
  )
# Add the new row to the existing dataframe
mexican_top <- bind_rows(mexican_top, white_average_row)


## black 50% or more


nh_black_top <- df_health %>% arrange(desc(prc_nh_b)) %>% filter(prc_nh_b >50) %>% select(commnty, drinking_rate, smoking_rate, fruit_veg_rate)  

nh_black_average_row <- nh_black_top %>%
  summarise(
    commnty = "Average of Community Areas with 50% or more Non-Hispanic Black population",
     drinking_rate = round(mean(drinking_rate, na.rm = TRUE), 1),
    smoking_rate = round(mean(smoking_rate, na.rm = TRUE), 1),
    fruit_veg_rate = round(mean(fruit_veg_rate, na.rm = TRUE), 1)
  )
# Add the new row to the existing dataframe
df_final <- bind_rows(mexican_top, nh_black_average_row) %>% mutate(across(matches("rate"), ~ ifelse(is.na(.), "missing data", paste0(., "%"))))

```


```{r}
# visuals
table_4c <- df_final  %>%
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Community Areas with 50% or more Mexican Population", "Adult Binge Drinking Rate", "Adult Smoking Rate", "Adult Healthy Diet Rate"),
      align = c("l",rep("c",3)),
      caption = "Health behaviors and risk factors, 2022-2023",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:4, width = "8.6em") %>%  
row_spec(0, bold = TRUE, font_size = 8) %>%
  row_spec(16:18, bold = TRUE, background = "#f2f0f7") %>%

  footnote(general = "Source: Chicago Health Atlas (2022-2023 and 2017-21). Tabulations by Great Cities Institute",
           general_title = "")   


table_4c
```



## 4D: Social and Public Health 

```{r}
# analysis

# analysis
mexican_top <- df_health %>% arrange(desc(prc_mxc)) %>% filter(prc_mxc >50) %>% select(commnty, sexual_assault_crimes, unmet_mental_health_rate)  

mexican_average_row <- mexican_top %>%
  summarise(
    commnty = "Average of Community Areas with 50% or more Mexican population",
    sexual_assault_crimes = round(mean(sexual_assault_crimes, na.rm = TRUE), 1),
    unmet_mental_health_rate = round(mean(unmet_mental_health_rate, na.rm = TRUE), 1)
    )

# Add the new row to the existing dataframe
mexican_top <- bind_rows(mexican_top, mexican_average_row)

## white 50% or more

white_top <- df_health %>% arrange(desc(prc_nh_w)) %>% filter(prc_nh_w >50) %>% select(commnty, sexual_assault_crimes, unmet_mental_health_rate)  

white_average_row <- white_top %>%
  summarise(
    commnty = "Average of Community Areas with 50% or more Non-Hispanic White population",
    sexual_assault_crimes = round(mean(sexual_assault_crimes, na.rm = TRUE), 1),
    unmet_mental_health_rate = round(mean(unmet_mental_health_rate, na.rm = TRUE), 1)
    )
# Add the new row to the existing dataframe
mexican_top <- bind_rows(mexican_top, white_average_row)


## black 50% or more


nh_black_top <- df_health %>% arrange(desc(prc_nh_b)) %>% filter(prc_nh_b >50) %>% select(commnty, sexual_assault_crimes, unmet_mental_health_rate)  

nh_black_average_row <- nh_black_top %>%
  summarise(
    commnty = "Average of Community Areas with 50% or more Non-Hispanic Black population",
     sexual_assault_crimes = round(mean(sexual_assault_crimes, na.rm = TRUE), 1),
    unmet_mental_health_rate = round(mean(unmet_mental_health_rate, na.rm = TRUE), 1)
    )

# Add the new row to the existing dataframe
df_final <- bind_rows(mexican_top, nh_black_average_row) %>% mutate(across(matches("rate"), ~ ifelse(is.na(.), "missing data", paste0(., "%")))) %>% mutate(across(matches("crimes"), ~ ifelse(is.na(.), "missing data", paste0(., " crimes"))))

```


```{r}
# visuals

table_4d <- df_final  %>%
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Community Areas with 50% or more Mexican Population", "Criminal Sexual Assault", "Unmet Mental Health Need Rate"),
      align = c("l",rep("c",2)),
      caption = "Health behaviors and risk factors, 2022-2023",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "12.9em") %>%  
row_spec(0, bold = TRUE, font_size = 8) %>%
  row_spec(16:18, bold = TRUE, background = "#f2f0f7") %>%

  footnote(general = "Source: Chicago Health Atlas (2022-2023 and 2017-21). Tabulations by Great Cities Institute",
           general_title = "") 


table_4d
```




# Employment and Business

## Mexican Employment
### 1. Unemployment Rate

```{r}

unemployment = usa_data %>%
  filter( city == 1190, year == 2022) %>%

  as_survey_design(weights = perwt) %>%
  survey_count(race_ethnicity, employment=empstat_f, laborforce= labforce_f,  name="count") %>%
  filter(laborforce == "Yes, in the labor force") %>%
  group_by(race_ethnicity) %>%
  mutate(in_laborforce = sum(count)) %>%
  filter(employment == "Unemployed") %>%
  mutate(unemployment_rate = 100*round(count/in_laborforce, 4),
         prc2 = paste0(unemployment_rate, "%"))


table_5.a1 <- unemployment %>%
  select(race_ethnicity,  in_laborforce, count, prc2) %>%

  # using kable
  kbl(booktabs = T,
      col.names = c("Race/Ethnicity",  "In the Labor Force" ,"Unemployed", "Percent"),
      align = c("l",rep("c",3)),
      caption = "Unemployment Rate by Race/Ethnicity in Chicago, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
 kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:4, width = "8.6em") %>%
  # add_header_above(align = c("l", rep("c",3)), c("Race/Ethnicity", "More than 30%" = 2, "More than 50%" = 2),
  #                   # background = "#cbc9e2",
  #                   bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>%


  add_footnote(c( "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute"),
 notation = "none")

table_5.a1

```

\clearpage

### 2. Numbers and percentages of Mexicans employed, by industry


```{r}


industry = usa_data %>%
  filter( city == 1190, year == 2022) %>%  #### dont forget to filter PUMA   ## Should I filter pernum or not?



  mutate(industry = case_when(ind %in% c(0170:0490)  ~ "Agriculture, Forestry, Fishing, and Hunting, and Mining",
                              ind == 0770  ~ "Construction",
                              ind %in% c(1070:3990)  ~ "Manufacturing",
                              ind %in% c(4070:4590)  ~ "Wholesale Trade",
                              ind %in% c(4670:5790)  ~ "Retail Trade",
                              ind %in% c(6070:6390, 0570:0690) ~ "Transportation and Warehousing, and Utilities",
                              ind %in% c(6470:6780)  ~ "Information",
                              ind %in% c(6870:7190)  ~ "Finance and Insurance, and Real Estate, and Rental and Leasing",
                              ind %in% c(7270:7790)  ~ "Professional, Scientific, and Management, and Administrative, and Waste Management Services",
                              ind %in% c(7860:8470)  ~ "Educational Services, and Health Care and Social Assistance",
                              ind %in% c(8561:8690)  ~ "Arts, Entertainment, and Recreation, and Accommodation and Food Services",
                              ind %in% c(8770:9290)  ~ "Other Services, Except Public Administration",
                              ind %in% c(9370:9590)  ~ "Public Administration",
                              ind %in% c(9670:9870)  ~ "Military",
                              ind == 9920  ~ "Unemployed, last worked 5 years ago or earlier or never worked",

                                    TRUE ~ NA_character_)) %>%

  as_survey_design(weights = perwt) %>%
  survey_count(race_ethnicity, industry, employment=empstat_f, name="count") %>%
  filter(employment == "Employed") %>%
  group_by(race_ethnicity) %>%
  mutate(total_employed = sum(count, na.rm = T)) %>%
  mutate(prc = 100* round(count/total_employed, 4),
         prc2 = paste0(prc,"%")) %>%
  ungroup()




table_5a.2 <-  industry %>%
  # filter(race_ethnicity %in% c("Other Latinos")) %>%
  select(industry, count,  prc2) %>%

   # using kable
  kable(booktabs = T,
        col.names = c("Industry", "Number", "% Share of Employed"   ),
      align = c("l",rep("c",2)),
      caption = "Employment Distribution by Industry and Race/Ethnicity in Chicago, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                # latex_options = "HOLD_position",
                ) %>%
  column_spec(1, width = "40em") %>%
  column_spec(2:3, width = "7em") %>%
  # add_header_above( c("Race/Ethnicity", "2000" = 2, "2008-2012" = 2, "2018-2022" = 2, "Change from\n2000 to 2018-2022" = 2),
  #                   # background = "#cbc9e2",
  #                   bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>%

  pack_rows("Mexican", 1,14, hline_after = T  ) %>%
  pack_rows("Other Latinos", 15, 28, hline_before = T , hline_after = T) %>%
  pack_rows("White (non-Hispanic or Latino)", 29, 42,  hline_before = T , hline_after = T) %>%
  pack_rows("Black (non-Hispanic or Latino)", 43, 56,  hline_before = T, hline_after = T ) %>%
  pack_rows("Other (non-Hispanic or Latino)", 57, 70, hline_before = T, hline_after = T) %>%
  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")


table_5a.2

```

\clearpage

### 3. Numbers and percentages of Mexicans employed, by Occupation


```{r}

occupation = usa_data %>%
  filter( city == 1190, year == 2022) %>%  #### dont forget to filter PUMA   ## Should I filter pernum or not?

  mutate(occupation = case_when(occ %in% c(0010:3550)  ~ "Management, Business, and Financial Occupations",
                                occ %in% c(3601:4655)  ~ "Service Occupations",
                                occ %in% c(4700:5940)  ~ "Sales and Office Occupations",
                                occ %in% c(6005:7640)  ~ "Natural Resources, Construction, and Maintenance Occupations",
                                occ %in% c(7700:9760)  ~ "Production, Transportation, and Material Moving Occupations",
                                    TRUE ~ NA_character_)) %>%

  as_survey_design(weights = perwt) %>%
  survey_count(race_ethnicity, occupation, employment=empstat_f, name="count") %>%
  filter(employment == "Employed") %>%
  group_by(race_ethnicity) %>%
  mutate(total_employed = sum(count, na.rm = T)) %>%
  mutate(prc = 100* round(count/total_employed, 4),
         prc2 = paste0(prc,"%")) %>%
  filter(!is.na(occupation)) %>%
  ungroup()




table_5a.3 <-  occupation %>%
  # filter(race_ethnicity %in% c("Other Latinos")) %>%
  select(occupation, count,  prc2) %>%

   # using kable
  kable(booktabs = T,
        col.names = c("Occupations", "Number", "% Share of Employed"  ),
      align = c("l",rep("c",2)),
      caption = "Employment Distribution by Occupations Category and Race/Ethnicity in Chicago, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                # latex_options = "HOLD_position",
                ) %>%
  column_spec(1, width = "40em") %>%
  column_spec(2:3, width = "7em") %>%
  # add_header_above( c("Race/Ethnicity", "2000" = 2, "2008-2012" = 2, "2018-2022" = 2, "Change from\n2000 to 2018-2022" = 2),
  #                   # background = "#cbc9e2",
  #                   bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>%

  pack_rows("Mexican", 1,5, hline_after = T  ) %>%
  pack_rows("Other Latinos", 6, 10, hline_before = T , hline_after = T) %>%
  pack_rows("White (non-Hispanic or Latino)", 11, 15,  hline_before = T , hline_after = T) %>%
  pack_rows("Black (non-Hispanic or Latino)", 16, 20,  hline_before = T, hline_after = T ) %>%
  pack_rows("Other (non-Hispanic or Latino)", 21, 25, hline_before = T, hline_after = T) %>%
  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")


table_5a.3

```


## 5.B: Numbers and percentages of unionized Mexican workers

```{r}

options(knitr.kable.NA = '-')




Union <- cps_ddi %>%

  filter( year == 2022) %>%  #### dont forget to filter PUMA   ## Should I filter pernum or not?
  mutate(race_f = as_factor(race),
         hispan_f = as_factor(hispan),
         laborforce_f = as_factor(labforce),
         employment_f = as_factor(empstat),
         union_f = as_factor(union)) %>%

  mutate(race_ethnicity = case_when(hispan ==0 & race == 100 ~ "White (non-Hispanic or Latino)",
                                    hispan ==0 & race == 200 ~ "Black (non-Hispanic or Latino)",
                                    hispan %in% c(200:612) ~ "Other Latinos",
                                    hispan %in% c(100:109) ~ "Mexican",
                                    hispan ==0 & !race %in%c(100,200) ~ "Other (non-Hispanic or Latino)",
                                    TRUE ~ NA_character_)) %>%
  mutate(race_ethnicity = factor(race_ethnicity, level = c("Mexican", "Other Latinos","White (non-Hispanic or Latino)", "Black (non-Hispanic or Latino)",  "Other (non-Hispanic or Latino)"))) %>%

  mutate(employment_f = case_when(empstat %in% c(1, 10, 12) ~ "Employed",
                              TRUE ~ "other")) %>%


  filter(labforce != 0 |  empstat !=0) %>%
  filter(employment_f == "Employed") %>%
  as_survey_design(weights = asecwt) %>%

  survey_count(race_ethnicity, laborforce_f, employment_f,  union_f, name="count") %>%
  group_by(race_ethnicity) %>%
  mutate(total_employed = sum(count)) %>%
  filter(union_f %in% c("Member of labor union", "Covered by union but not a member")) %>%
  # group_by(race_ethnicity, total_employed) %>%
  mutate(prc = 100*round(count/total_employed, 4),
            prc2 = paste0(prc, "%")) %>%
  select(race_ethnicity,union_f, total_employed,  count, prc2) %>%
  pivot_wider(names_from = union_f, values_from = c(count, prc2))



table5b <- Union %>%
  select(race_ethnicity,  total_employed,  `count_Member of labor union`, `prc2_Member of labor union`, `count_Covered by union but not a member`, `prc2_Covered by union but not a member`  ) %>%


  kbl(booktabs = T,
      col.names = c("",  "" ,"Number", "Percent", "Number", "Percent"),
      align = c("l",rep("c",5)),
      caption = " Numbers and percentages of unionized Mexican workers by Race/Ethnicity in Illinois, 2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
 kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:5, width = "5.16em") %>%
  add_header_above(align = c("l", rep("c",3)), c("Race/Ethnicity",  "Total Employed","Member of labor union" =2 ,"Covered by union but not a member" = 2),
                    # background = "#cbc9e2",
                    bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>%


  add_footnote(c( "Source: IPUMS-CPS database (2022). Tabulations by Great Cities Institute"),
 notation = "none")

table5b

```

# 6.Citizenship and Civic Participation

## 6.A:Number and percentages of Mexicans by status

```{r}
# Define df at the top
df <- usa_data %>%
  select(race_ethnicity, citizen, perwt, year) %>%
  mutate(
    citizenship_status = case_when(
      citizen == 1 ~ "Citizen",
      citizen == 2 ~ "Citizen",
      citizen == 3 ~ "Not a Citizen",
      TRUE ~ "Unknown"  # This includes N/A and any other undefined categories
    )
  )


# 2022
  survey_design <- df %>%
    as_survey_design(weights = perwt)

  numerator_2022 <- survey_design %>%
    filter(year == 2022 & citizen == 3) %>%
    group_by(race_ethnicity, citizenship_status) %>%
    summarise(weighted_n = survey_total(vartype = "se"))

  denominator_2022 <- survey_design %>%
     filter(year == 2022)%>%
    group_by(race_ethnicity) %>%
    summarise(total_pop = survey_total(vartype = "se"))

  df_rates_2022 <- numerator_2022 %>%
    left_join(denominator_2022, by = "race_ethnicity") %>%
    mutate(rate = round(weighted_n / total_pop, 4)*100) %>%
    mutate(year = 2022)


# 2012

  numerator_2012 <- survey_design %>%
    filter(year == 2012 & citizen == 3) %>%
    group_by(race_ethnicity, citizenship_status) %>%
    summarise(weighted_n = survey_total(vartype = "se"))

  denominator_2012 <- survey_design %>%
     filter(year == 2012)%>%
    group_by(race_ethnicity) %>%
    summarise(total_pop = survey_total(vartype = "se"))

  df_rates_2012 <- numerator_2012 %>%
    left_join(denominator_2012, by = "race_ethnicity") %>%
    mutate(rate = round(weighted_n / total_pop, 4)*100) %>%
    mutate(year = 2012)



# 2000
   numerator_2000 <- survey_design %>%
    filter(year == 2000 & citizen == 3) %>%
    group_by(race_ethnicity, citizenship_status) %>%
    summarise(weighted_n = survey_total(vartype = "se"))

  denominator_2000 <- survey_design %>%
     filter(year == 2000)%>%
    group_by(race_ethnicity) %>%
    summarise(total_pop = survey_total(vartype = "se"))

  df_rates_2000 <- numerator_2000 %>%
    left_join(denominator_2000, by = "race_ethnicity") %>%
    mutate(rate = round(weighted_n / total_pop, 4)*100) %>%
    mutate(year = 2000)



# Combine all years
citizenship <- bind_rows(df_rates_2022, df_rates_2012, df_rates_2000)
```



```{r}
 table_6.a1  <- citizenship %>%
  ungroup() %>%
  filter(citizenship_status != "Unknown") %>%
  select(year, race_ethnicity,  citizenship_status, rate) %>%
  pivot_wider(id_cols = race_ethnicity,   names_from =c(citizenship_status, year) , values_from = rate) %>%
  mutate(change_non_citizen = round(`Not a Citizen_2022` - `Not a Citizen_2000`, 2)) %>%

    select(race_ethnicity, `Not a Citizen_2000` , `Not a Citizen_2012`,  `Not a Citizen_2022`,change_non_citizen) %>%
  mutate(across(-race_ethnicity, ~ paste0(., "%"))) %>%

  kbl(booktabs = T,
      col.names = c("", "Non citizen Rate", "Non citizen Rate", "Non citizen Rate", "Non citizen Rate"),
      align = c("l",rep("c",4)),
      caption = "Citizenship by Race/Ethnicity in Chicago, 2000-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
 kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:5, width = "6.45em") %>%
  add_header_above(align = c("l", rep("c",4)), c("Race/Ethnicity", "2000" = 1, "2008-2012" = 1, "2018-2022" = 1, "Change from\n2000 to 2018-2022" = 1),
                   bold = T, font_size =8) %>%
  # row_spec(0, bold = T,
  #          # background = "#f2f0f7",
  #          font_size = 8) %>%


  add_footnote(c( "Source: IPUMS-USA database (2000-2022). Tabulations by Great Cities Institute"),
 notation = "none")

table_6.a1
```

