---
title: "Mexicans in Chicago Report Committee"
author: ""
date: "Great Cities Institute"
output: 
  pdf_document:
    latex_engine: xelatex
    toc: true
    highlight: pygments
    extra_dependencies: ["float"]
    fig_caption: true
mainfont: "Arial"
header-includes:
  - \usepackage{titling}
  - \pretitle{\begin{flushleft}}
  - \posttitle{\end{flushleft}}
  - \usepackage{pdflscape}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, fig.pos="H")


```


```{r echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}



library(ipumsr)
library(tidyverse)
library(purrr)
library(sf)
library(tidycensus)
library(tidyr)
library(readxl)
library(sf)
library(htmltools)
library(leaflet)
library(janitor)
library(data.table)
library(tinytex)
library(survey) # for survey analysis
library(srvyr)  # for tidy survey analysis
library(tmap)
library("kableExtra") 
library(tmaptools)
library("RColorBrewer") 
# library(OpenStreetMap)
# remotes::install_github('yihui/knitr')
# install.packages("knitr")
# library(knitr)
# options(tinytex.verbose = TRUE)
# tinytex::reinstall_tinytex()
# install.packages('tinytex')

# update.packages(ask = FALSE, checkBuilt = TRUE)
# tinytex::tlmgr_update()
# tinytex::latexmk("Housing_Visual.tex")
options(knitr.kable.NA = '-') 

usa_data <- read.csv("C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/final_Mexican_IL_2000_22.csv") %>% 
  mutate(race_ethnicity = case_when(hispan ==0 & race == 1 ~ "White (non-Hispanic or Latino)",
                                    hispan ==0 & race == 2 ~ "Black (non-Hispanic or Latino)",
                                    hispan %in% c(2,3,4) ~ "Other Latinos",
                                    hispan ==1 ~ "Mexican", 
                                    hispan ==0 & race %in%c(3:9) ~ "Other (non-Hispanic or Latino)",
                                    TRUE ~ NA_character_)) %>% 
  mutate(race_ethnicity = factor(race_ethnicity, level = c("Mexican", "Other Latinos","White (non-Hispanic or Latino)", "Black (non-Hispanic or Latino)",  "Other (non-Hispanic or Latino)"))) %>% 
  mutate(hispan_breakdown = case_when(
  hispand == 0 ~ "Not Hispanic",
  hispand == 100 ~ "Mexican", 
  hispand == 200 ~ "Puerto Rican",
  hispand == 300 ~ "Cuban",
  hispand == 411 ~ "Costa Rican",
  hispand == 412 ~ "Guatemalan",
  hispand == 413 ~ "Honduran",
  hispand == 414 ~ "Nicaraguan",
  hispand == 415 ~ "Panamanian",
  hispand == 416 ~ "Salvadoran",
  hispand == 417 ~ "Central American, not specified",
  hispand == 420 ~ "Argentinean",
  hispand == 421 ~ "Bolivian",
  hispand == 422 ~ "Chilean",
  hispand == 423 ~ "Colombian",
  hispand == 424 ~ "Ecuadorian",
  hispand == 425 ~ "Paraguayan",
  hispand == 426 ~ "Peruvian",
  hispand == 427 ~ "Uruguayan",
  hispand == 428 ~ "Venezuelan",
  hispand == 431 ~ "South American, not specified",
  hispand == 450 ~ "Spaniard",
  hispand == 460 ~ "Dominican",
  hispand == 498 ~ "Other, not specified",
  TRUE ~ "Other"
),
mex_foreign_born = case_when(
    race_ethnicity == "Mexican" & bpl %in% as.character(1:56) ~ "U.S. Born",
    race_ethnicity == "Mexican" & bpl == "200" ~ "Mexico Born",
    TRUE ~ NA_character_  # Optional: default case for other values or groups
  )) %>% ## filter for hispanic groups here ##
  mutate(mex_foreign_born = factor(mex_foreign_born, level = c("Mexico Born","U.S. Born"))) %>% 
  
 mutate(hispan_breakdown = factor(hispan_breakdown, level = c("Mexican", "Puerto Rican","Ecuadorian", "Cuban", "Guatemalan", "Colombian"))
  )


# Construct the full file path
chicago_ca_pop <- read_sf("Data Tables/shp/comm_pop_chi_2022.shp") %>% as.data.frame() 

##### Chicago boarder
Chicago_boundary_shp <- read_sf("C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/Boundaries_Chicago/geo_export_8881adc5-2460-457b-892f-04f4d6028b72.shp") %>% 
  st_transform(crs = 4326)
# mapview(community_shp)

# Get the current bounding box of the data
bbox_data <- st_bbox(Chicago_boundary_shp)

# Calculate the range of x and y values in degrees
xrange <- bbox_data$xmax - bbox_data$xmin
yrange <- bbox_data$ymax - bbox_data$ymin

# Calculate the center of the bounding box
center_x <- (bbox_data$xmin + bbox_data$xmax) / 2
center_y <- (bbox_data$ymin + bbox_data$ymax) / 2
# Modify the bounding box to fit the desired width while keeping the height the same
bbox_new <- c(center_x - 0.24,
              center_y - 0.23,
              center_x + 0.23,
              center_y + 0.23)

# osm_chicago <- read_osm(bbox_new, 
#                         type = "bing")



theme_plots <-
  theme_minimal() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_line(color="#969696", linewidth = 1),
        plot.title = element_text(face ="bold", size = 10, hjust = 0.5),
      plot.subtitle = element_text(face ="italic", size = 8, color = "#636363"),
      axis.text = element_text(size = 9),
      axis.title = element_text(face ="bold", size = 9),
      plot.caption = element_text(hjust = 0, size = 8, color = "black"),
      legend.text = element_text(size = 8, color = "#636363"),
      legend.title = element_text(face = "bold", size = 8, color = "#636363")) 

color_race_ethnicity <- c("Mexican" = "#CE1126", "Other Latinos" = "#F9AA51",
                               "White (non-Hispanic or Latino)" = "#9CA168",
                               "Black (non-Hispanic or Latino)" = "#8CBEC0",
                               "Other (non-Hispanic or Latino)" = "#0B8489")

```

\renewcommand{\arraystretch}{1.4}
\clearpage

# 1.Demographic

```{r include=FALSE}

######### Demographic
comm_2000_2022 <- st_read ("Data Tables/shp/comm_pop_chi_2000_2022.shp" ) %>% 
  mutate(prc2 = paste0(prc, "%"))




```

## 1A.1: Mexican population in Chicago, 2000 to 2018-2022:


\blandscape
### Mexican Population by Community Areas in Chicago, 2018-2022


```{r fig.height=8, fig.width=11}

comm_mexican_pop_map_2000_2022 <-

  tm_shape(comm_2000_2022) +
  tm_polygons(
    col = "ttl_mxc",
    breaks = c(0, 15000, 30000, 45000, 60000, 75000),
    border.col = "#6c757d",
              palette="Blues",
              alpha = 1,
              # n = 5,
              title = "Mexican Population",
              lwd = 0.3,
    legend.show = FALSE
    ) +
  tm_facets(by = "year",
            ncol = 3) +
  
  tm_text("ttl_mxc2" , size = 0.7, alpha = 0.9, fontface="bold", fontfamily = "sans") +


  tm_shape(Chicago_boundary_shp) +
  tm_borders(col = "#343a40",
             alpha = 1,
             lwd = 2.5) +
  

   tm_layout( frame = TRUE,
            # legend.width = 1.5,
            legend.title.size = .9,
            legend.text.size = 0.8,
            legend.title.fontface = "bold",
            # legend.position = c("right", "bottom"),
            # legend.position = c(0.1, 0.12),
            legend.outside.position = "bottom",
            attr.outside = T, attr.outside.position = "bottom", attr.just = "left",

            main.title = "Mexican Population by Community Areas in Chicago, 2000 to 2018-2022"
    
            ) +
  tm_add_legend("fill", 
                labels = c("0 - 14999", "15000 - 29999", "30000 - 44999", "45000 - 59999", "60000 - 74999"), 
                col = c("#eff3ff", "#bdd7e7", "#6baed6", "#3182bd", "#08519c"),
                alpha = 1,
                lwd = .3,

                border.col = "#ced4da",
                title = "Mexican Population",
                size = 0.7) +
  
  tm_add_legend("line",
                labels = c("Chicago Border", "Community Area Border"),
                col = c("#343a40","#6c757d"),
                lwd = c(2.5, 2),
                title = "Border Types",
                size = 0.8) 

comm_mexican_pop_map_2000_2022 

```


## Percentage of the Mexican Population by Community Areas in Chicago, 2000 to 2018-2022

```{r fig.height=8, fig.width=11}
# fig.height=11, fig.width=24
map_2000_2022 <-

  tm_shape(comm_2000_2022) +
  tm_polygons(
    col = "prc",
              # style = "jenks",
              border.col = "#6c757d",
              palette="Blues",
              alpha = 1,
              # n = 5,
    breaks = c(0, 20, 40, 60, 80, 100),
    legend.show = FALSE,
              title = "Percentage",
              lwd = 0.3) +
   tm_text("prc" , size = 0.8, alpha = 1, fontface="bold", fontfamily = "sans")+

  tm_facets(by = "year",
            ncol = 3) +

  tm_shape(Chicago_boundary_shp) +
  tm_borders(col = "#343a40",
             alpha = 1,
             lwd = 2.5) +
  

   tm_layout( frame = TRUE,
            # legend.width = 1.5,
            legend.title.size = .9,
            legend.text.size = 0.8,
            legend.title.fontface = "bold",
            # legend.position = c("right", "bottom"),
            # legend.position = c(0.1, 0.12),
            legend.outside.position = "bottom",
            attr.outside = T, attr.outside.position = "bottom", attr.just = "left",

            main.title = "Percentage of the Mexican Population by Community Areas in Chicago, 2000 to 2018-2022"
    
            ) +
  
  tm_add_legend("fill", 
                labels = c("0.00% - 19.99%", "20.00% - 39.99%", "40.00% - 59.99%", "60.00% - 79.99%", "80.00% - 100%"), 
                col = c("#eff3ff", "#bdd7e7", "#6baed6", "#3182bd", "#08519c"),
                alpha = 1,
                lwd = .3,

                border.col = "#ced4da",
                title = "Mexican Population",
                size = 0.7)+
  
  tm_add_legend("line",
                labels = c("Chicago Border", "Community Area Border"),
                col = c("#343a40","#6c757d"),
                lwd = c(2.5, 2),
                title = "Border Types",
                size = 0.8) 


map_2000_2022

```

\elandscape




# 3.Housing & Community Development

## 3.A: Rates of home ownership and rental housing among Mexicans with historical trends and comparisons to other groups.

```{r}

homeownership = usa_data %>% 
  filter( city == 1190, pernum == 1) %>%  
  
  as_survey_design(weights = hhwt) %>% 
  survey_count(year, race_ethnicity, ownershp_f, name="count") %>% 
  
  filter(ownershp_f != "N/A") %>% 
  filter(!is.na(race_ethnicity)) %>% 
  
  group_by(year, race_ethnicity) %>% 
  mutate(total = sum(count),
         per = 100*round(count/total, 4),
         per2 = paste0(format(round(per, 1), nsmall = 1), "%")) %>% 
  mutate(scale = "Chicago")
  

ownership_nation <- read.csv("Data Tables/homeownership_nation.csv") %>% 
  mutate(per2 = paste0(format(round(per, 1), nsmall = 1), "%")) %>% 
  select(-X) %>% 
  mutate(scale = "USA")

ownership_join <- rbind(homeownership, ownership_nation)




ownership_join2 <-  ownership_join %>% 
  
  filter(ownershp_f == "Owned or being bought (loan)") %>% 

  pivot_wider(id_cols =  c(race_ethnicity, ownershp_f, scale), names_from = "year", values_from = c(count, per, per2)) %>% 

  mutate(diff2000_2022 = count_2022 - count_2000,
         diff_per = round(per_2022 - per_2000, 4), 
         diff_per2 = paste0(format(round(diff_per, 1), nsmall = 1), "%") 
         ) %>% 
  select(race_ethnicity, count_2000, per2_2000, count_2012, per2_2012, count_2022, per2_2022, diff2000_2022, diff_per2)
 



table_a3 <- ownership_join2 %>% 
  
  kbl(booktabs = T,
      col.names = c("", "Number", "Percent" , "Number", "Percent", "Number", "Percent", "Number", "Percent"),
      align = c("l",rep("c",8)),
      caption = "Homeownership by Race/Ethnicity in Chicago and USA, 2000, 2008-2012, and 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:9, width = "3.8em") %>%
  add_header_above( align = c("l", rep("c",4)), c("Race/Ethnicity", "2000" = 2, "2008-2012" = 2, "2018-2022" = 2, "Change from\n2000 to 2018-2022" = 2),
                    # background = "#cbc9e2", 
                    bold = T, font_size =8) %>% 
  # row_spec(0, bold = T, 
  #          # background = "#f2f0f7",
  #          font_size = 8) %>% 
  pack_rows("City of Chicago", 1,5, hline_after = T , indent=FALSE) %>%
  pack_rows("Nation", 6, 10, hline_before = T , hline_after = T, indent=FALSE) %>%
  
  footnote(general = "Source: IPUMS-USA database (2000, 2008-2012, 2018-2022). Tabulations by Great Cities Institute",
           general_title = "")   

table_a3

```


```{r}
color_race_ethnicity <- c("Mexican" = "#CE1126", "Other Latinos" = "#F9AA51",
                               "White (non-Hispanic or Latino)" = "#9CA168",
                               "Black (non-Hispanic or Latino)" = "#8CBEC0",
                               "Other (non-Hispanic or Latino)" = "#0B8489")

ownership_join %>% 
  filter(ownershp_f == "Owned or being bought (loan)") %>% 

  mutate(year = case_when(year == 2000 ~ "2000",
                          year == 2012 ~ "2008-2012",
                          year == 2022 ~ "2018-2022"),
         year = factor(year, levels = c("2000", "2008-2012", "2018-2022"))) %>%
  
  ggplot(aes(x =  year,
             y = per,
             fill = scale)) +
  geom_bar(position=position_dodge(width=0.7), stat = "identity", 
           color = "white", 
           width=0.7) +
  
  facet_wrap (~race_ethnicity) +
  labs(y="", x = "",
       title="Homeownership by Race/Ethnicity in Chicago and USA, 2000 to 2018-2022",
       caption = "Source: IPUMS-USA database (2000, 2008-2012, 2018-2022). Tabulations by Great Cities Institute",
       fill="") 
  # scale_fill_manual(values = color_race_ethnicity) + 
  # geom_text(aes(label = prc2),
  #           position=position_dodge(width=0.7), 
  #           vjust = -0.5,
  #           hjust = 0.5,
  #           size = 2.5) +
  # 
  # scale_x_discrete(labels = function(x) str_wrap(x, width = 20)) + # Modify labels of ggplot2 barplot
  # scale_y_continuous(labels = function(x) paste0(x, "%"), limits = c(0,100), breaks = seq(0, 100, by = 100)) +
  # 
  # theme_plots +
  # theme(
  #   # axis.text.x = element_text(size = 8),
  #       panel.background = element_blank(),
  #       # axis.ticks.y = element_blank(),
  #       # axis.title.y = element_blank(),
  #       axis.text.y = element_blank(),
  #       axis.line.y = element_blank(),
  #       legend.position = "bottom",
  #       legend.text = element_text(size = 7, color = "#636363"),
  #       legend.key.size = unit(0.5, "lines"))+
  # guides(fill = guide_legend(nrow = 2, byrow = TRUE)) 





```

```{r}



table_a3_2 <-  ownership_nation %>% 
  
  filter(ownershp_f == "Owned or being bought (loan)") %>% 

  pivot_wider(id_cols =  c(race_ethnicity, ownershp_f), names_from = "year", values_from = c(count, per, per2)) %>% 

  mutate(diff2000_2022 = count_2022 - count_2000,
         diff_per = round(per_2022 - per_2000, 4), 
         diff_per2 = paste0(diff_per,"%")
         ) %>% 
  select(race_ethnicity, count_2000, per2_2000, count_2012, per2_2012, count_2022, per2_2022, diff2000_2022, diff_per2) %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("", "Number", "Percent" , "Number", "Percent", "Number", "Percent", "Number", "Percent"),
      align = c("l",rep("c",8)),
      caption = "Homeownership by Race/Ethnicity in the USA, 2000, 2008-2012, and 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:9, width = "3.8em") %>%
  add_header_above( align = c("l", rep("c",4)), c("Race/Ethnicity", "2000" = 2, "2008-2012" = 2, "2018-2022" = 2, "Change from\n2000 to 2018-2022" = 2),
                    # background = "#cbc9e2", 
                    bold = T, font_size =8) %>% 
  # row_spec(0, bold = T, 
  #          # background = "#f2f0f7",
  #          font_size = 8) %>% 
  
  footnote(general = "Source: IPUMS-USA database (2000, 2008-2012, 2018-2022). Tabulations by Great Cities Institute",
           general_title = "")   

table_a3_2

```

## 3.B: Number and percentage of Mexicans who, live in crowded housing, or are rent-burdened.

```{r}


## Be careful rooms == 0 is NA but it is overcrowded
overcrowded = usa_data %>%
  filter( city == 1190, pernum == 1, year == 2022) %>%  #### dont forget to filter PUMA   ## Should I filter pernum or not?


  as_survey_design(weights = hhwt) %>%
  survey_count(year, race_ethnicity, rooms, numprec, name="count") %>%
  mutate(p_per_room = numprec/rooms,
         overcrowded = if_else(p_per_room >1, "Overcrowded", "Not Overcowded")) %>%

  group_by(year, race_ethnicity) %>%
  mutate(total = sum(count, na.rm = T)) %>%
  filter(rooms != 0 ) %>%  ## rooms == 0 is NA but it is overcrowded
  ungroup() %>%
  group_by(year, race_ethnicity, overcrowded, total) %>%

  summarise(count_sum = sum(count)) %>%
  mutate(per = 100*round(count_sum/total, 4),
         per2 = paste0(per,"%")) %>%
  ungroup()

```


### 1. Crowded Housing

```{r}

table_3.b1 <- overcrowded %>%

  filter(overcrowded == "Overcrowded" ) %>%

  select(race_ethnicity, count_sum , per2) %>%

   # using kable

  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Number", "Percent"  ),
      align = c("l",rep("c",2)),
      caption = "Number and Percentage of Households Living in Crowded Housing
      by Race/Ethnicity in Chicago, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
  kable_classic(full_width = T,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "12.9em") %>%
  # add_header_above( c("Race/Ethnicity", "2000" = 2, "2008-2012" = 2, "2018-2022" = 2, "Change from\n2000 to 2018-2022" = 2),
  #                   # background = "#cbc9e2",
  #                   bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>%

  add_footnote(c("Housing is defined as overcrowded if more than one person in the room.", "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute"),
 notation = "none")

table_3.b1

```


### 2. Rent burdened

```{r}
rent_burdened = usa_data %>%
  select(pernum, city, year, rentgrs, hhincome, ownershp_f, hhwt, race_ethnicity ) %>% 
  filter( city == 1190, pernum == 1, year == 2022) %>%  

  group_by(race_ethnicity, ownershp_f) %>%
  mutate(total = sum(hhwt, na.rm = T)) %>%
  ungroup() %>%
  filter(hhincome != 9999999 ) %>%
  filter(rentgrs!= 0) %>%

  mutate(monthly_income = hhincome/12, 
        rent_income = rentgrs/monthly_income,
         burdened_30 = if_else(rent_income >0.3 , "More than 30%","Less than 30%"),
         burdened_50 = if_else(rent_income >0.5, "More than 50%", "Less than 50%")) %>% 
  as_survey_design(weights = hhwt) %>%
  survey_count(year, race_ethnicity, total,ownershp_f, burdened_30, burdened_50 , name="count") %>%
  mutate(per = 100*round(count/total, 4),
         per2 = paste0(per,"%")) 
 

  ####### prepare data for the table

table_3.b2 = rent_burdened %>%
  filter( burdened_30 != "Less than 30%") %>%
  group_by(race_ethnicity ) %>%

  summarise(more_30_count = sum(count[burdened_30== "More than 30%"]),
            more_50_count = sum(count[burdened_50== "More than 50%"]),
            more_30_per = 100 *round(more_30_count/total, 4),
            more_30_per2 = paste0(more_30_per, "%"),
            more_50_per = 100 *round(more_50_count/total, 4),
            more_50_per2 = paste0(more_50_per, "%")) %>%
  distinct()



table_3.b2_2 <- table_3.b2 %>%
  select(race_ethnicity, more_30_count, more_30_per2, more_50_count, more_50_per2) %>%

  # using kable

  kbl(booktabs = T,
      col.names = c("", "Number", "Percent" , "Number", "Percent" ),
      align = c("l",rep("c",4)),
      caption = "Rent Burdened households by Race/Ethnicity in Chicago, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:5, width = "6.45em") %>%
  add_header_above( align = c("l", rep("c",2)), c("Race/Ethnicity", "More than 30%" = 2, "More than 50%" = 2),
                    # background = "#cbc9e2",
                    bold = T, font_size =8) %>%
  # row_spec(0, bold = T,
  #          # background = "#f2f0f7",
  #          font_size = 8) %>%

  # footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute.Rent Burdened Households Defined as Spending 30% or More of Income on Rent",
  #          general_title = "") %>% 
  add_footnote(c("Rent Burdened Households Defined as Spending 30% or More of Income on Rent", "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute"),
 notation = "none") 


table_3.b2_2
```


### 3. Own Cost Burdened

```{r}

owncost_burdened = usa_data %>%
  select(pernum, city, year, owncost, hhincome, ownershp_f, hhwt, race_ethnicity ) %>% 
  filter( city == 1190, pernum == 1, year == 2022) %>%  #### dont forget to filter PUMA   ## Should I filter pernum or not?

  group_by(race_ethnicity, ownershp_f) %>%
  mutate(total = sum(hhwt, na.rm = T)) %>%
  ungroup() %>%
  filter(hhincome != 9999999 ) %>%
  filter(owncost!= 99999) %>%

  mutate(monthly_income = hhincome/12,
         owncost_income = owncost/monthly_income,
         burdened_30 = if_else(owncost_income >0.3 , "More than 30%","Less than 30%"),
         burdened_50 = if_else(owncost_income >0.5, "More than 50%", "Less than 50%")) %>%

  as_survey_design(weights = hhwt) %>%
  survey_count(year, race_ethnicity, total,ownershp_f, burdened_30, burdened_50 , name="count") %>%
  mutate(per = 100*round(count/total, 4),
         per2 = paste0(per,"%"))



####### prepare data for the table

table_3.b3 = owncost_burdened %>%
  filter( burdened_30 != "Less than 30%") %>%
  group_by(race_ethnicity ) %>%

  summarise(more_30_count = sum(count[burdened_30== "More than 30%"]),
            more_50_count = sum(count[burdened_50== "More than 50%"]),
            more_30_per = 100 *round(more_30_count/total, 4),
            more_30_per2 = paste0(more_30_per, "%"),
            more_50_per = 100 *round(more_50_count/total, 4),
            more_50_per2 = paste0(more_50_per, "%")) %>%
  distinct()



table_3.b3_2 <- table_3.b3 %>%
  select(race_ethnicity, more_30_count, more_30_per2, more_50_count, more_50_per2) %>%

  # using kable

  kbl(booktabs = T,
      col.names = c("", "Number", "Percent" , "Number", "Percent" ),
      align = c("l",rep("c",4)),
      caption = "Cost-Burdened Homeowners by Race and Ethnicity in Chicago (2018-2022)",
      format.args = list(big.mark = ","),
      linesep = "", table.attr = "style='width:30%;'") %>%
 kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:5, width = "6.45em") %>% 
  add_header_above(align = c("l", rep("c",2)), c("Race/Ethnicity", "More than 30%" = 2, "More than 50%" = 2),
                    # background = "#cbc9e2",
                    bold = T, font_size =8) %>%
  # row_spec(0, bold = T,
  #          # background = "#f2f0f7",
  #          font_size = 8) %>%

  
  add_footnote(c("Own Cost Burdened Households Defined as ?", "Source: IPUMS-USA database (2018-2022).Tabulations by Great Cities Institute"),
 notation = "none")

table_3.b3_2
```


## 3.D: House Value

```{r}

community_shp <- read_sf("C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/Boundaries - Community Areas (current)/geo_export_2081dd0e-84f5-45c8-b501-f07b67ad9491.shp") %>% 
  st_transform( crs = 4326) %>% 
  select(community,geometry)


chicago_shp <- read_sf("Data Tables/shp/intersect_census_2020.shp") %>% 
  select(GEOID, geometry) %>% 
  st_transform( crs = 4326)


census_centroids_2022 <- st_centroid(chicago_shp)

# Spatial join: attach community area names to census tracts based on centroid location
census_community_2022 <- st_join(census_centroids_2022, 
                                 community_shp, 
                                 join = st_within) %>% 
  mutate(lable = str_to_title(community)) %>% 
  mutate(lable = gsub(" ", "\n", lable))

# write_sf(census_community_2022, "C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/shp files/census_community_2022.shp")

# search_variables <- load_variables(2022,
#                          dataset = "acs5",
#                          cache = TRUE)
# 
# view(search_variables)

# options(tigris_use_cache = TRUE)

house_value_data <-  get_acs(
  cache_table = TRUE,
  geography = "tract",
  variables = c("Not Hispanic or Latino"="B03001_002",
                "Hispanic or Latino"="B03001_003",
                "Mexican" = "B03001_004", 
                "total_pop"= "B03001_001"),
                
  summary_var =  "B25077_001",              
  state = 17,
  year = 2022) %>% 
  rename("Mvalue" = "summary_est") %>% 

  filter(GEOID %in% c(chicago_shp$GEOID)) %>% 
  left_join(census_community_2022 %>% st_drop_geometry(), by = "GEOID") %>% 
  pivot_wider(id_cols = c(GEOID , NAME, Mvalue, community ), names_from = variable, values_from = estimate) %>% 

  group_by(community) %>% 
  summarise(total_his = sum(`Hispanic or Latino`, na.rm = T),
         total_mexican = sum(Mexican, na.rm = T),
         total_pop = sum(total_pop, na.rm = T),
         prc_mexican = total_mexican/total_pop, 
         Mvalue = median(Mvalue, na.rm = T)) 

comunity_house_value_shp <- left_join(community_shp, house_value_data,  by = join_by(community == community)) %>% 
  mutate(lable = str_to_title(community)) %>% 
  mutate(lable = gsub(" ", "\n", lable))


```



```{r fig.height=11, fig.width=8}
value_map_2020 <-

  tm_shape(comunity_house_value_shp, bbox = bbox_new) +
  tm_polygons(col = "Mvalue",
              style = "quantile",
              border.col = "white",
              palette="Blues",
              alpha = 0.7,
              n = 5,
              title = "Median House Values",
              lwd = 1) +

  tm_shape(comunity_house_value_shp %>% filter(prc_mexican>=0.5)) +
  tm_borders(col = "#9b2226",
             alpha = 1,
             lwd = 2)+
  tm_text("lable" , size = 0.7, alpha = 0.7, fontface="bold", fontfamily = "sans") +

  tm_shape(Chicago_boundary_shp) +
  tm_borders(col = "#343a40",
             alpha = 1,
             lwd = 2.5) +

  tm_layout( frame = TRUE,
             # main.title.position = c("left", "top"),
             # main.title = "Density of Hispanic or Latino Population by their Origins in Chicago, 2010",
             # main.title.size = 1.2,
            legend.outside = FALSE,
            legend.width = 1.5,
            legend.title.size = .9,
            legend.text.size = 0.8,
            legend.title.fontface = "bold",
            # legend.position = c("left", "bottom"),
            legend.position = c(0.03, 0.12),
            legend.bg.color = "white",
            legend.bg.alpha = .3) +       # manually position legend) +
  
  tm_credits("Data source:\n5-year ACS (2018-2022)\nMap Generated by:The Great Cities Institute",
             fontface = "bold",
             position = c("left","bottom"), size = 0.8)+
  
  
  tm_credits("Median House Value in Chicago, 2018-2022",
             fontface = "bold",
             position = c("left","top"), size = 1.25)+

  
  tm_add_legend("line",
                labels = c("Chicago Border","" ,"Community Areas with More Than\n50% Share of Mexican Population", ""),
                col = c("#343a40","white" ,"#9b2226", "white"),
                lwd = c(2.5, 2),
                title = "Border Types",
                size = 0.8) +

  # tm_credits("1 dot = 20 People",
  #            position = c(0.03, 0.32), size = 0.8, fontface = "bold") +
  tm_compass(position = c("right", "bottom"), size = 1) +
  tm_scale_bar(position = c("right", "bottom"), width = 0.15)

value_map_2020

```

### Graph

```{r fig.width=6, fig.height=5 ,fig.align='center'}
####### Barchart: "op Ten Counties in Illinois with the Highest Population in Labor Force
Mhouse_value_plot <- comunity_house_value_shp %>% 
  filter(prc_mexican>=0.5) %>% 
  arrange(desc(Mvalue)) %>% 
  mutate(community2 = str_to_title(community)) %>% 
  mutate(community2 = factor(community2),
         community2 = fct_reorder(community2, Mvalue)) %>% 
  ggplot(aes(y = community2, x = Mvalue) ) +
  geom_bar( stat = "identity", 
            fill = "#6baed6",
            color = "#9b2226",
           width=0.7,
           linewidth = 1) +
  labs(y="", x = "",
       title="Median House Value in Chicago Community Areas with More Than\n50% Share of Mexican Population(2018-2022)",
       caption = "Source: American Community Survey 5-year Estimate (2018-2022) \nTabulations by Great Cities Institute",
       fill="") +
  geom_text(aes(label = paste0(scales::comma(Mvalue))),
            position=position_dodge(width=0.9), hjust = -0.3, vjust = 0.8,
            size = 3) +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 24))+ # Modify labels of ggplot2 barplot
  scale_x_continuous(labels = function(x) paste0(x, "%"), limits = c(0,550000), breaks = seq(0, 550000, by = 550000))+
  theme_plots +
  theme(
        axis.text.y = element_text(size = 8),
        panel.background = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 7, color = "#636363"),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.line.x = element_blank())
  
  
  Mhouse_value_plot
```



# 5.Employment and Business

\clearpage

# Employment and Business


## 5A.1: Unemployment Rate

```{r}

unemployment = usa_data %>% 
  filter( city == 1190, year == 2022) %>%  #### dont forget to filter PUMA   ## Should I filter pernum or not?
  
  as_survey_design(weights = perwt) %>% 
  survey_count(race_ethnicity, employment=empstat_f, laborforce= labforce_f,  name="count") %>% 
  filter(laborforce == "Yes, in the labor force") %>% 
  group_by(race_ethnicity) %>% 
  mutate(in_laborforce = sum(count)) %>% 
  select(-count_se) %>% 
  pivot_wider(names_from = "employment",
              values_from = "count") %>% 

  mutate(unemployment_rate = 100*round(Unemployed/in_laborforce, 4),
         prc2 = paste0(unemployment_rate, "%"))
  

table_5.a1 <- unemployment %>%
  select(race_ethnicity,  in_laborforce, Employed, Unemployed, prc2) %>%
  
  # using kable
  kbl(booktabs = T,
      col.names = c("Race/Ethnicity",  "In the Labor Force" , "Employed" ,"Unemployed", "Unemployment Rate"),
      align = c("l",rep("c",4)),
      caption = "Unemployment Rate by Race/Ethnicity in Chicago, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
 kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:5, width = "6.45em") %>% 
  # add_header_above(align = c("l", rep("c",3)), c("Race/Ethnicity", "More than 30%" = 2, "More than 50%" = 2),
  #                   # background = "#cbc9e2",
  #                   bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>%

  
  add_footnote(c( "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute"),
 notation = "none")

table_5.a1

```


## 5A.1-2: The Labor Force Participation Rate 

```{r}
LFP_rate = usa_data %>%
  as_survey_design(weights = perwt) %>%
  survey_count(year, race_ethnicity, empstatd,empstatd_f, laborforce= labforce_f,  name="count") %>% 
  filter(empstatd != 0) %>% 
  group_by(year, race_ethnicity) %>% 
  mutate(denominator = sum(count, na.rm = TRUE)) %>% 
  filter(empstatd!= 30) %>% 
  group_by(year, race_ethnicity, denominator) %>% 
  summarise(count = sum(count, na.rm = TRUE)) %>% 
  mutate(prc = 100*round(count/denominator, 4),
         prc2 = paste0(prc, "%"))



table_5.a1_2 <- LFP_rate %>% 
  select(year, race_ethnicity, prc2) %>% 
  pivot_wider(names_from = year,
              values_from = prc2) %>% 
  # using kable
  kbl(booktabs = T,
      col.names = c("Race/Ethnicity",  "2000" , "2008-2012" ,"2018-2022" ),
      align = c("l",rep("c",3)),
      caption = "Labor Force Participation Rate by Race/Ethnicity in Chicago, 2000 to 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
 kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:4, width = "8.6em") %>% 
  # add_header_above(align = c("l", rep("c",3)), c("Race/Ethnicity", "More than 30%" = 2, "More than 50%" = 2),
  #                   # background = "#cbc9e2",
  #                   bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>%

  
  add_footnote(c( "Source: IPUMS-USA database (2000, 2008-2012, 2018-2022). Tabulations by Great Cities Institute"),
 notation = "none")

table_5.a1_2
```



```{r fig.width=6, fig.height=4 ,fig.align='center'}

color_race_ethnicity <- c("Mexican" = "#CE1126", "Other Latinos" = "#F9AA51",
                               "White (non-Hispanic or Latino)" = "#9CA168",
                               "Black (non-Hispanic or Latino)" = "#8CBEC0",
                               "Other (non-Hispanic or Latino)" = "#0B8489")
 
LFP_rate %>% 
  mutate(year = case_when(year == 2000 ~ "2000",
                          year == 2012 ~ "2008-2012",
                          year == 2022 ~ "2018-2022"),
         year = factor(year, levels = c("2000", "2008-2012", "2018-2022"))) %>% 

  # group_by(occupation) %>%
  # mutate(prc_mexican = ifelse(race_ethnicity == "Mexican", prc, NA)) %>%
  # ungroup() %>%
  # arrange(prc_mexican) %>%
  # mutate(occupation = factor(occupation, levels = unique(occupation[order(prc_mexican)]))) %>% 
  
  ggplot(aes(x =  year,
             y = prc,
             fill = race_ethnicity)) +
  geom_bar(position=position_dodge(width=0.7), stat = "identity", 
           color = "white", 
           width=0.7) +
  labs(y="", x = "",
       title="Labor Force Participation Rate by Race/Ethnicity in Chicago, 2000 to 2018-2022",
       caption = "Source: IPUMS-USA database (2000, 2008-2012, 2018-2022). Tabulations by Great Cities Institute",
       fill="") +
  scale_fill_manual(values = color_race_ethnicity) + 
  geom_text(aes(label = prc2),
            position=position_dodge(width=0.7), 
            vjust = -0.5,
            hjust = 0.5,
            size = 2.5) +

  scale_x_discrete(labels = function(x) str_wrap(x, width = 20)) + # Modify labels of ggplot2 barplot
  scale_y_continuous(labels = function(x) paste0(x, "%"), limits = c(0,100), breaks = seq(0, 100, by = 100)) +
  
  theme_plots +
  theme(
    # axis.text.x = element_text(size = 8),
        panel.background = element_blank(),
        # axis.ticks.y = element_blank(),
        # axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 7, color = "#636363"),
        legend.key.size = unit(0.5, "lines"))+
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) 


```


## 5A.2: Numbers and percentages of Mexicans employed, by industry

\blandscape

```{r}

industry = usa_data %>%
  filter(year == 2022) %>%  #### dont forget to filter PUMA   ## Should I filter pernum or not?

  mutate(industry = case_when(ind %in% c(0170:0490)  ~ "Agriculture, Forestry, Fishing, and Hunting, and Mining",
                              ind == 0770  ~ "Construction",
                              ind %in% c(1070:3990)  ~ "Manufacturing",
                              ind %in% c(4070:4590)  ~ "Wholesale Trade",
                              ind %in% c(4670:5790)  ~ "Retail Trade",
                              ind %in% c(6070:6390, 0570:0690) ~ "Transportation and Warehousing, and Utilities",
                              ind %in% c(6470:6780)  ~ "Information",
                              ind %in% c(6870:7190)  ~ "Finance and Insurance, and Real Estate, and Rental and Leasing",
                              ind %in% c(7270:7790)  ~ "Professional, Scientific, and Management, and Administrative, and Waste Management Services",
                              ind %in% c(7860:8470)  ~ "Educational Services, and Health Care and Social Assistance",
                              ind %in% c(8561:8690)  ~ "Arts, Entertainment, and Recreation, and Accommodation and Food Services",
                              ind %in% c(8770:9290)  ~ "Other Services, Except Public Administration",
                              ind %in% c(9370:9590)  ~ "Public Administration",
                              ind %in% c(9670:9870)  ~ "Military",
                              ind == 9920  ~ "Unemployed, last worked 5 years ago or earlier or never worked",

                                    TRUE ~ NA_character_)) %>%
  
  as_survey_design(weights = perwt) %>%
  survey_count(race_ethnicity, industry, employment=empstat_f, name="count") %>%
  filter(employment == "Employed") %>%
  
  group_by(industry ) %>%
  mutate(total_employed = sum(count, na.rm = T)) %>%
  mutate(prc = 100* round(count/total_employed, 4),
         prc2 = paste0(prc,"%")) %>%
  ungroup()




table_5a.2 <-  industry %>%
  # filter(race_ethnicity %in% c("Other Latinos")) %>% 
  select(race_ethnicity, industry, count,  prc2) %>%
  pivot_wider(names_from = race_ethnicity,
              values_from = c(count, prc2)) %>% 
  select(industry, count_Mexican, prc2_Mexican, `count_Other Latinos`, `prc2_Other Latinos`, `count_White (non-Hispanic or Latino)`, `prc2_White (non-Hispanic or Latino)`, `count_Black (non-Hispanic or Latino)`, `prc2_Black (non-Hispanic or Latino)`, `count_Other (non-Hispanic or Latino)`, `prc2_Other (non-Hispanic or Latino)`) %>% 
  

   # using kable
  kable(booktabs = T,
        col.names = c("", "Number", "% Share of Employed", 
                      "Number", "% Share of Employed",  
                      "Number", "% Share of Employed", 
                      "Number", "% Share of Employed",
                      "Number", "% Share of Employed"),
      align = c("l",rep("c",8)),
      caption = "Employment Distribution by Industry and Race/Ethnicity in Chicago, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
  
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position",
                ) %>%
  column_spec(1, width = "12em") %>%
  column_spec(2:11, width = "4.8em") %>%
  add_header_above( c("Industry", "Mexican" = 2, "Other Latinos" = 2,"White\n(non-Hispanic or Latino)" = 2, "Black\n(non-Hispanic or Latino)" = 2,  "Other\n(non-Hispanic or Latino)" = 2),
                    # background = "#cbc9e2",
                    bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>%
  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "") 
  # kableExtra::landscape()
  

table_5a.2


```

\elandscape

\clearpage



```{r}

industry2 = usa_data %>%
  filter( city == 1190, year == 2022) %>%  #### dont forget to filter PUMA   ## Should I filter pernum or not?

  as_survey_design(weights = perwt) %>%
  survey_count(race_ethnicity, ind, employment=empstat_f, name="count") %>%
  filter(employment == "Employed") %>%
  
  group_by(ind) %>%
  mutate(total_employed = sum(count, na.rm = T)) %>%
  mutate(prc = 100* round(count/total_employed, 4),
         prc2 = paste0(prc,"%")) %>% 
  ungroup()
  # mutate(mexican_count = ifelse(race_ethnicity == "Mexican", count, NA)) %>%
  # arrange(desc(mexican_count))


top_ind_mxc <- industry2 %>%
  filter(race_ethnicity == "Mexican") %>%
  arrange(desc(count)) %>%
  slice(1:10) %>%
  pull(ind)


top_ind_latinos <- industry2 %>%
  filter(race_ethnicity == "Other Latinos") %>%
  arrange(desc(count)) %>%
  slice(1:10) %>%
  pull(ind)


industry3 <- industry2 %>% 
  filter(ind %in% top_ind_mxc & race_ethnicity == "Mexican" | ind %in% top_ind_latinos & race_ethnicity == "Other Latinos" ) %>% 
  
  mutate(sub_industry = case_when(ind == 8680 ~ "Restaurants and other food services",
                    ind == 770 ~ "The cleaning of buildings and dwellings is incidental during construction and immediately after construction",
                    ind == 7860 ~ "Elementary and secondary schools",
                    ind == 8191 ~ "General medical and surgical hospitals, and specialty (except psychiatric and substance abuse) hospitals",
                    ind == 7690 ~ "Services to buildings and dwellings (except cleaning during construction and immediately after construction)",
                    ind == 4971 ~ "Supermarkets and other grocery (except convenience) stores",
                    ind == 8770 ~ "Automotive repair and maintenance",
                    ind == 7870 ~ "Colleges, universities, and professional schools, including junior colleges",
                    ind == 7770 ~ "Landscaping services",
                    ind == 3990 ~ "Not specified manufacturing industries",
                    ind == 7380 ~ "Computer systems design and related services",
                    ind == 8470 ~ "Child day care services",
                    ind == 9470 ~ "Justice, public order, and safety activities"),
         
         group_ind = case_when(ind == 8680 ~ "Accommodation and Food Services",
                    ind == 770 ~ "Construction",
                    ind == 7860 ~ "Educational Services",
                    ind == 8191 ~ "Health Care and Social Assistance",
                    ind == 7690 ~ "Administrative and support and waste management services",
                    ind == 4971 ~ "Retail Trade",
                    ind == 8770 ~ "Other Services, Except Public Administration",
                    ind == 7870 ~ "Educational Services",
                    ind == 7770 ~ "Administrative and support and waste management services",
                    ind == 3990 ~ "Manufacturing",
                    ind == 7380 ~ "Professional, Scientific, and Technical Services",
                    ind == 8470 ~ "Health Care and Social Assistance",
                    ind == 9470 ~ "Public Administration"
                    )) %>% 
  arrange(factor(race_ethnicity, levels = levels(industry2$race_ethnicity)), desc(count)) %>%
  ungroup()



table_5a.2_2 <-  industry3 %>%

  select(group_ind, sub_industry, count,  prc2) %>%

   # using kable
  kable(booktabs = T,
        col.names = c("Group", "Sub Industry", "Number", "% Share of Employed"   ),
      align = c("l", "l", rep("c",2)),
      caption = "The Top 10 sub-industries where Mexicans and Other Latinos have the highest employment in Chicago, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                # latex_options = "HOLD_position",
                ) %>%
  column_spec(1:2, width = "20em") %>%
  column_spec(3:4, width = "7em") %>%
  # add_header_above( c("Race/Ethnicity", "2000" = 2, "2008-2012" = 2, "2018-2022" = 2, "Change from\n2000 to 2018-2022" = 2),
  #                   # background = "#cbc9e2",
  #                   bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8)  %>% 
  pack_rows("Mexican", 1,10, hline_after = T  ) %>% 
  pack_rows("Other Latinos", 11, 20, hline_before = T , hline_after = T) %>% 
    footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "") 

table_5a.2_2 



```



\blandscape


## 5A.3: Numbers and percentages of Mexicans employed, by Occupation


```{r}

occupation = usa_data %>%
  filter( city == 1190, year == 2022) %>%  
  
  mutate(occupation = case_when(occ %in% c(0010:3550)  ~ "Management, Business, and Financial Occupations",
                                occ %in% c(3601:4655)  ~ "Service Occupations",
                                occ %in% c(4700:5940)  ~ "Sales and Office Occupations",
                                occ %in% c(6005:7640)  ~ "Natural Resources, Construction, and Maintenance Occupations",
                                occ %in% c(7700:9760)  ~ "Production, Transportation, and Material Moving Occupations",
                                    TRUE ~ NA_character_)) %>%

  as_survey_design(weights = perwt) %>%
  survey_count(race_ethnicity, occupation, employment=empstat_f, name="count") %>%
  filter(employment == "Employed") %>%
  group_by(occupation) %>%
  mutate(total_employed = sum(count, na.rm = T)) %>%
  mutate(prc = 100* round(count/total_employed, 4),
         prc2 = paste0(prc,"%")) %>%
  filter(!is.na(occupation)) %>% 
  ungroup()




table_5a.3 <-  occupation %>%
  # filter(race_ethnicity %in% c("Other Latinos")) %>% 
  select(race_ethnicity, occupation, count,  prc2) %>%
  pivot_wider(names_from = race_ethnicity,
              values_from = c(count, prc2)) %>% 
  select(occupation, count_Mexican, prc2_Mexican, `count_Other Latinos`, `prc2_Other Latinos`, `count_White (non-Hispanic or Latino)`, `prc2_White (non-Hispanic or Latino)`, `count_Black (non-Hispanic or Latino)`, `prc2_Black (non-Hispanic or Latino)`, `count_Other (non-Hispanic or Latino)`, `prc2_Other (non-Hispanic or Latino)`) %>% 

   # using kable
  kable(booktabs = T,
        col.names = c("", "Number", "% Share of Employed", 
                      "Number", "% Share of Employed",  
                      "Number", "% Share of Employed", 
                      "Number", "% Share of Employed",
                      "Number", "% Share of Employed"),
      align = c("l",rep("c",8)),
      caption = "Employment Distribution by Occupation Categories and Race/Ethnicity in Chicago, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
  
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position",
                ) %>%
  column_spec(1, width = "12em") %>%
  column_spec(2:11, width = "4.8em") %>%
  add_header_above( c("Occupation", "Mexican" = 2, "Other Latinos" = 2,"White\n(non-Hispanic or Latino)" = 2, "Black\n(non-Hispanic or Latino)" = 2,  "Other\n(non-Hispanic or Latino)" = 2),
                    # background = "#cbc9e2",
                    bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>%
  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "") 
  

table_5a.3

```

\elandscape
\clearpage

```{r fig.width=6, fig.height=4 ,fig.align='center'}

color_race_ethnicity <- c("Mexican" = "#CE1126", "Other Latinos" = "#F9AA51",
                               "White (non-Hispanic or Latino)" = "#9CA168",
                               "Black (non-Hispanic or Latino)" = "#8CBEC0",
                               "Other (non-Hispanic or Latino)" = "#0B8489")
 
occupation %>% 
  mutate(race_ethnicity = fct_rev(race_ethnicity)) %>% 
  group_by(occupation) %>%
  mutate(prc_mexican = ifelse(race_ethnicity == "Mexican", prc, NA)) %>%
  ungroup() %>%
  arrange(prc_mexican) %>%
  mutate(occupation = factor(occupation, levels = unique(occupation[order(prc_mexican)]))) %>% 
  
  ggplot(aes(x = prc,
             y = occupation,
             fill = race_ethnicity)) +
  geom_bar(position = "stack", stat = "identity", 
           color = "white", 
           width=2/3) +
  labs(y="", x = "",
       title="Employment Distribution by Occupation Categories and Race/Ethnicity\nin Chicago, 2018-2022",
       caption = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
       fill="") +
  scale_fill_manual(values = color_race_ethnicity) + 
  
  geom_text(aes(label = prc2),
            position = position_stack(vjust = 0.5),
            # vjust = -0.5,
            # hjust = 0.5,
            size = 2.5  ,
            fontface = "bold",
            color = "white")+
  scale_y_discrete(labels = function(x) str_wrap(x, width = 20)) + # Modify labels of ggplot2 barplot
  scale_x_continuous(labels = function(x) paste0(x, "%"), limits = c(0,101), breaks = seq(0, 101, by = 100)) +
  
  theme_plots +
  theme(
    axis.text.y = element_text(size = 8),
        panel.background = element_blank(),
        # axis.ticks.y = element_blank(),
        # axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.line.x = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 7, color = "#636363"),
        legend.key.size = unit(0.5, "lines"))+
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) # Arrange legend items in two rows
  

```
\clearpage


```{r}

occupation2 <- usa_data %>%
  filter( city == 1190, year == 2022) %>%  #### dont forget to filter PUMA   ## Should I filter pernum or not?

  as_survey_design(weights = perwt) %>%
  survey_count(race_ethnicity, occ, employment=empstat_f, name="count") %>%
  filter(employment == "Employed") %>%
  group_by(occ) %>%
  mutate(total_employed = sum(count, na.rm = T)) %>%
  mutate(prc = 100* round(count/total_employed, 4),
         prc2 = paste0(prc,"%")) %>%
  filter(!is.na(occ)) %>% 
  ungroup()


top_occ_mxc <- occupation2 %>%
  filter(race_ethnicity == "Mexican") %>%
  arrange(desc(count)) %>%
  slice(1:10) %>%
  pull(occ)

top_occ_latinos <- occupation2 %>%
  filter(race_ethnicity == "Other Latinos") %>%
  arrange(desc(count)) %>%
  slice(1:10) %>%
  pull(occ)



occupation3 <- occupation2 %>% 
  filter(occ %in% top_occ_mxc & race_ethnicity == "Mexican"|
         occ %in% top_occ_latinos & race_ethnicity == "Other Latinos") %>% 
  
  mutate(sub_Occupation = case_when(occ == 4220 ~ "Janitors and building cleaners",
                                    occ == 9620 ~ "Laborers and freight, stock, and material movers, hand",
                                    occ == 4020 ~ "Cooks",
                                    occ == 4720 ~ "Cashiers",
                                    occ == 9130 ~ "Driver/sales workers and truck drivers",
                                    occ == 5240 ~ "Customer service representatives",
                                    occ == 6260 ~ "Construction laborers",
                                    occ == 4760 ~ "Retail salespersons",
                                    occ == 4110 ~ "Waiters and waitresses",
                                    occ == 8990 ~ "Miscellaneous production workers, including equipment operators and tenders",
                                    occ == 440 ~ "Other managers",
                                    occ == 4700 ~ "First-line supervisors of retail sales workers"), 
  Occupation_group = case_when(occ == 4220 ~ "Service Occupations",
                               occ == 9620 ~ "Transportation and Material Moving Occupations",
                               occ == 4020 ~ "Service Occupations",
                               occ == 4720 ~ "Sales and Related Occupations",
                               occ == 9130 ~ "Transportation and Material Moving Occupations",
                               occ == 5240 ~ "Office and Administrative Support Occupations",
                                occ == 6260 ~ "Construction and Extraction Occupations",
                               occ == 4760 ~ "Sales and Related Occupations",
                               occ == 4110 ~ "Service Occupations",
                               occ == 8990 ~ "Production Occupations",
                               occ == 440 ~ "Management, Business, and Financial Occupations",
                               occ == 4700 ~ "Sales and Related Occupations"
                               
                                    )) %>%
  arrange(factor(race_ethnicity, levels = levels(occupation2$race_ethnicity)), desc(count)) %>%
  ungroup()

##########


table_5a.3_2 <-  occupation3 %>%

  select(Occupation_group, sub_Occupation, count,  prc2) %>%

   # using kable
  kable(booktabs = T,
        col.names = c("Occupation Group","Occupation", "Number", "% Share of Employed"   ),
      align = c("l","l" ,rep("c",2)),
      caption = "The Top 10 Occupations with the Highest Employment of Mexicans and Other Latinos in Chicago (2018-2022)",
      format.args = list(big.mark = ","),
      linesep = "") %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                # latex_options = "HOLD_position",
                ) %>%
  column_spec(1:2, width = "20em") %>%
  column_spec(3:4, width = "7em") %>%
  # add_header_above( c("Race/Ethnicity", "2000" = 2, "2008-2012" = 2, "2018-2022" = 2, "Change from\n2000 to 2018-2022" = 2),
  #                   # background = "#cbc9e2",
  #                   bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>% 
  pack_rows("Mexican", 1,10, hline_after = T  ) %>% 
  pack_rows("Other Latinos", 11, 20, hline_before = T , hline_after = T) 

  

table_5a.3_2 


```

\clearpage

## 5C: Numbers and percentages of unionized Mexican workers

```{r}
  
options(knitr.kable.NA = '-') 

cps_ddi <- read_ipums_micro(read_ipums_ddi("C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/cps_00171.xml")) %>% 
  clean_names() 


Union <- cps_ddi %>% 
  filter( year == 2022) %>%  #### dont forget to filter PUMA   ## Should I filter pernum or not?
  mutate(race_f = as_factor(race),
         hispan_f = as_factor(hispan), 
         laborforce_f = as_factor(labforce),
         employment_f = as_factor(empstat),
         union_f = as_factor(union)) %>%

  mutate(race_ethnicity = case_when(hispan ==0 & race == 100 ~ "White (non-Hispanic or Latino)",
                                    hispan ==0 & race == 200 ~ "Black (non-Hispanic or Latino)",
                                    hispan %in% c(200:612) ~ "Other Latinos",
                                    hispan %in% c(100:109) ~ "Mexican", 
                                    hispan ==0 & !race %in%c(100,200) ~ "Other (non-Hispanic or Latino)",
                                    TRUE ~ NA_character_)) %>% 
  mutate(race_ethnicity = factor(race_ethnicity, level = c("Mexican", "Other Latinos","White (non-Hispanic or Latino)", "Black (non-Hispanic or Latino)",  "Other (non-Hispanic or Latino)"))) %>% 
  
  mutate(employment_f = case_when(empstat %in% c(1, 10, 12) ~ "Employed",
                              TRUE ~ "other")) %>% 
  
  
  filter(labforce != 0 |  empstat !=0) %>% 
  filter(employment_f == "Employed") %>%
  as_survey_design(weights = earnwt) %>% 
  
  survey_count(race_ethnicity, laborforce_f, employment_f,  union_f, name="count") %>% 
  group_by(race_ethnicity) %>% 
  mutate(total_employed = sum(count)) %>% 
  filter(union_f %in% c("Member of labor union", "Covered by union but not a member")) %>% 
  # group_by(race_ethnicity, total_employed) %>% 
  mutate(prc = 100*round(count/total_employed, 4),
            prc2 = paste0(prc, "%")) %>% 
  select(race_ethnicity,union_f, total_employed,  count, prc2) %>% 
  pivot_wider(names_from = union_f, values_from = c(count, prc2))
  


table5b <- Union %>% 
  select(race_ethnicity,  total_employed,  `count_Member of labor union`, `prc2_Member of labor union`, `count_Covered by union but not a member`, `prc2_Covered by union but not a member`  ) %>% 


  kbl(booktabs = T,
      col.names = c("",  "" ,"Number", "Percent", "Number", "Percent"),
      align = c("l",rep("c",5)),
      caption = " Numbers and percentages of unionized Mexican workers by Race/Ethnicity in Illinois, 2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
 kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:5, width = "5.16em") %>%
  add_header_above(align = c("l", rep("c",3)), c("Race/Ethnicity",  "Total Employed","Member of labor union" =2 ,"Covered by union but not a member" = 2),
                    # background = "#cbc9e2",
                    bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>%

  
  add_footnote(c( "Source: IPUMS-CPS database (2022). Tabulations by Great Cities Institute"),
 notation = "none")

table5b

```


\clearpage

## 5D: Transportation

```{r}
tranwork <- usa_data %>% 

  filter( city == 1190, year == 2022) %>%  #### dont forget to filter PUMA   ## Should I filter pernum or not?
  
  as_survey_design(weights = perwt) %>% 
  survey_count(race_ethnicity, employment=empstat_f, laborforce= labforce_f, tranwork_f, name="count") %>% 
  filter(employment == "Employed") %>%
  mutate(race_ethnicity = if_else(race_ethnicity%in% c("White (non-Hispanic or Latino)", "Black (non-Hispanic or Latino)", "Other (non-Hispanic or Latino)"), "Non-Hispanic or Latino",race_ethnicity )) %>% 
  
  
  group_by(race_ethnicity) %>%
  mutate(total_employed = sum(count, na.rm = T)) %>% 
  group_by(race_ethnicity, tranwork_f, total_employed) %>% 
  summarise(count = sum(count, na.rm =TRUE)) %>% 
  mutate(prc = 100 * round(count/total_employed, 4),
         prc2 = paste0(prc, "%")) 
  # mutate(tranwork_f = if_else(tranwork_f== "Light rail, streetcar, or trolley (Carro p\u00fablico in PR)", "Light rail, streetcar, or trolley", tranwork_f ))
  

# options(knitr.kable.NA = '-')   
  
table_5.d <- tranwork %>%
  pivot_wider(id_cols =tranwork_f, names_from = race_ethnicity,
              values_from = c(count, prc2 )) %>%
  # mutate(tranwork_f = factor(tranwork_f, levels = c("Auto, truck, or van", "Motorcycle", "Bus", "Light rail, streetcar, or trolley", "Subway or elevated", "Long-distance train or commuter train", "Taxicab", "Ferryboat",	"Bicycle", "Walked only", "Other", "Worked at home", "N/A"))) %>% 
  select(tranwork_f, count_Mexican, prc2_Mexican, `count_Other Latinos` ,`prc2_Other Latinos`, `count_Non-Hispanic or Latino`, `prc2_Non-Hispanic or Latino` ) %>%
  
  # using kable
  kbl(booktabs = T,
      col.names = c("", "Number", "% Share of Employed",
                    "Number", "% Share of Employed",
                    "Number", "% Share of Employed"),
      align = c("l",rep("c",6)), 
      caption = "Primary Means of Transportation to Work Race/Ethnicity in Chicago, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                # latex_options = "HOLD_position",
                ) %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:7, width = "5.16em") %>%
  add_header_above( c("Means of Transportation", "Mexican" = 2, "Other Latinos" = 2, "Non-Hispanic or Latino" = 2),
                    # background = "#cbc9e2",
                    bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "") 

table_5.d
```



# 6.Citizenship and Civic Participation

## 6.A:Number and percentages of Mexicans by status

```{r}
# Define df at the top
df <- usa_data %>% 
  select(race_ethnicity, citizen, perwt, year) %>%
  mutate(
    citizenship_status = case_when(
      citizen == 1 ~ "Citizen",
      citizen == 2 ~ "Citizen",
      citizen == 3 ~ "Not a Citizen",
      TRUE ~ "Unknown"  # This includes N/A and any other undefined categories
    )
  )


# 2022
  survey_design <- df %>%
    as_survey_design(weights = perwt)
  
  numerator_2022 <- survey_design %>%
    filter(year == 2022 & citizen == 3) %>%
    group_by(race_ethnicity, citizenship_status) %>%
    summarise(weighted_n = survey_total(vartype = "se"))
  
  denominator_2022 <- survey_design %>%
     filter(year == 2022)%>%
    group_by(race_ethnicity) %>%
    summarise(total_pop = survey_total(vartype = "se"))
  
  df_rates_2022 <- numerator_2022 %>%
    left_join(denominator_2022, by = "race_ethnicity") %>%
    mutate(rate = round(weighted_n / total_pop, 4)*100) %>% 
    mutate(year = 2022)
  
  
# 2012
  
  numerator_2012 <- survey_design %>%
    filter(year == 2012 & citizen == 3) %>%
    group_by(race_ethnicity, citizenship_status) %>%
    summarise(weighted_n = survey_total(vartype = "se"))
  
  denominator_2012 <- survey_design %>%
     filter(year == 2012)%>%
    group_by(race_ethnicity) %>%
    summarise(total_pop = survey_total(vartype = "se"))
  
  df_rates_2012 <- numerator_2012 %>%
    left_join(denominator_2012, by = "race_ethnicity") %>%
    mutate(rate = round(weighted_n / total_pop, 4)*100) %>% 
    mutate(year = 2012)
  
  
  
# 2000
   numerator_2000 <- survey_design %>%
    filter(year == 2000 & citizen == 3) %>%
    group_by(race_ethnicity, citizenship_status) %>%
    summarise(weighted_n = survey_total(vartype = "se"))
  
  denominator_2000 <- survey_design %>%
     filter(year == 2000)%>%
    group_by(race_ethnicity) %>%
    summarise(total_pop = survey_total(vartype = "se"))
  
  df_rates_2000 <- numerator_2000 %>%
    left_join(denominator_2000, by = "race_ethnicity") %>%
    mutate(rate = round(weighted_n / total_pop, 4)*100) %>% 
    mutate(year = 2000)
   
  

# Combine all years
citizenship <- bind_rows(df_rates_2022, df_rates_2012, df_rates_2000)
```



```{r}
 table_6.a1  <- citizenship %>%
  ungroup() %>%
  filter(citizenship_status != "Unknown") %>% 
  select(year, race_ethnicity,  citizenship_status, rate) %>%
  pivot_wider(id_cols = race_ethnicity,   names_from =c(citizenship_status, year) , values_from = rate) %>% 
  mutate(change_non_citizen = round(`Not a Citizen_2022` - `Not a Citizen_2000`, 2)) %>% 
    
    select(race_ethnicity, `Not a Citizen_2000` , `Not a Citizen_2012`,  `Not a Citizen_2022`,change_non_citizen) %>%
  mutate(across(-race_ethnicity, ~ paste0(., "%"))) %>% 
  
  kbl(booktabs = T,
      col.names = c("", "Non citizen Rate", "Non citizen Rate", "Non citizen Rate", "Non citizen Rate"),
      align = c("l",rep("c",4)),
      caption = "Citizenship by Race/Ethnicity in Chicago, 2000-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
 kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:5, width = "6.45em") %>%
  add_header_above(align = c("l", rep("c",4)), c("Race/Ethnicity", "2000" = 1, "2008-2012" = 1, "2018-2022" = 1, "Change from\n2000 to 2018-2022" = 1), 
                   bold = T, font_size =8) %>%
  # row_spec(0, bold = T,
  #          # background = "#f2f0f7",
  #          font_size = 8) %>%

  
  add_footnote(c( "Source: IPUMS-USA database (2000-2022). Tabulations by Great Cities Institute"),
 notation = "none")              

table_6.a1                                                                                                 
```

# 7.Cook County and Collar Counties

```{r include = FALSE}
pop_county_chicago_1990_2020 <- read_csv("Data Tables/mxc_county_chicago_1990_2020.csv") %>%
  ungroup() %>% 
  select(-`...1`) %>%
  # filter(county != "Cook County") %>% 
  mutate(year = factor(year, level = c( "1990", "2000", "2010", "2018-2022"))) %>%
  mutate(county = factor(county, level = c("Chicago", "Cook County outside of Chicago" ,"Cook County", "Kane County", "Lake County", "DuPage County", "Will County", "McHenry County"))) %>% 
  arrange(year, county) %>% 
  mutate(county = if_else(county == "Cook County outside of Chicago","Cook County Outside of Chicago" ,county
                          ))
  

##### Chicago boarder
Chicago_boundary_shp <- read_sf("C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/Boundaries_Chicago/geo_export_8881adc5-2460-457b-892f-04f4d6028b72.shp") %>% 
  st_transform(crs = 4326)
# mapview(community_shp)
collar_county_border <- st_read("C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/cb_2018_us_county_500k/cb_2018_us_county_500k.shp") %>% 
  filter(GEOID %in% c(17043, 17089, 17031, 17097, 17111, 17197)) %>% 
  st_transform(crs = 4326) %>% 
  select(GEOID,NAME, geometry) %>% 
  mutate(label = paste0(NAME, " County"))

```


## 7.A: Changing Mexican Population  Over Time



```{r}

county_pop_1990_2020 <- pop_county_chicago_1990_2020 %>% 
  mutate(prc_mex_his = 100*round(mexican/total_his, 4),
            prc_mex_total = 100*round(mexican/total_pop, 4)) %>% 
  mutate(prc_mex_his2 = paste0(format(round(prc_mex_his, 1), nsmall = 1), "%"),
         prc_mex_total2 = paste0(format(round(prc_mex_total, 1), nsmall = 1), "%")) 


### Table
county_pop_1990_2020_tb <- county_pop_1990_2020 %>% 
  filter(county != "Cook County") %>% 
  
  select(county, total_pop, total_his, mexican, prc_mex_his2,prc_mex_total2) %>%
  ## using kable
  kable(booktabs = T,
        col.names = c("Counties", "Total Population", "Total Hispanic or Latino",
                      "Total Mexican", "% Mexican of Hispanic or Latino", "% Mexican of Total Population"
                      ),
      align = c("l",rep("c",6)),
      caption = "Mexican and Hispanic/Latino Population in Cook County and Collar Counties, Illinois, 1980 to 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                # latex_options = "HOLD_position",
                ) %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:6, width = "7.16em") %>%
  # add_header_above( c("Race/Ethnicity", "2000" = 2, "2008-2012" = 2, "2018-2022" = 2, "Change from\n2000 to 2018-2022" = 2),
  #                   # background = "#cbc9e2",
  #                   bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>%

  pack_rows("1990", 1,7, hline_after = T  ) %>%
  pack_rows("2000", 8, 14, hline_before = T , hline_after = T) %>%
  pack_rows("2010", 15, 21,  hline_before = T , hline_after = T) %>%
  pack_rows("2020", 22, 28,  hline_before = T, hline_after = T ) %>%
  # pack_rows("2018-2022", 25, 30, hline_before = T, hline_after = T) %>% 
  footnote(general = "Source: IPUMS NHGIS (1990, 2000, 2010 Census, and 2018-2022). Tabulations by Great Cities Institute.",
           general_title = "") 
 #  add_footnote(c( "Source: IPUMS NHGIS (1980, 1990, 2000, 2010 Census, and 2018-2022). Tabulations by Great Cities Institute.", "Total Hispanic or Latino for 1980: person of Spanish/Hispanic origin or descent.", "Total Hispanic or Latino for 1990: person of Spanish/Hispanic origin.", "Total Hispanic or Latino for 2000: person of Spanish/Hispanic/Latino origin.", "Total Hispanic or Latino for 2010 and 2020: person of Hispanic, Latino, or Spanish origin."), threeparttable = TRUE,
 # notation = "symbol")

county_pop_1990_2020_tb

```



```{r}
county_pop_1990_2020_tb2 <- county_pop_1990_2020 %>% 
  filter(county != "Cook County") %>% 
  select(year, county, mexican, prc = prc_mex_total) %>%
  pivot_wider( names_from = c(year), values_from = c(mexican, prc)) %>% 
  select(county, mexican_1990, prc_1990, mexican_2000, prc_2000, mexican_2010, prc_2010, `mexican_2018-2022`, `prc_2018-2022`) %>% 
  
  mutate(change_1990_2020 = `mexican_2018-2022` - mexican_1990,
         growth_rate = 100*(`mexican_2018-2022` - mexican_1990)/mexican_1990,
         growth_rate = paste0(format(round(growth_rate, 1), nsmall = 1), "%")) %>%
  
  mutate(across(starts_with("prc_"), ~ paste0(format(round(.x, 1), nsmall = 1), "%"))) %>% 
  ## using kable
  kable(booktabs = T,
        col.names = c("" , "Number", "Percent",
                      "Number", "Percent", "Number", "Percent",
                      "Number", "Percent", "Number", "Growth Rate"),
      align = c("l",rep("c",11)),
      caption = "Mexican Population in Cook County and Collar Counties, Illinois, 1990 to 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position",
                ) %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:11, width = "4.8em") %>%
  add_header_above( c("Counties", "1990" = 2,  "2000" = 2, "2010" = 2, "2018-2022" = 2, "Change from\n1990 to 2018-2022" = 2),
                    # background = "#cbc9e2",
                    bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>%

  footnote(general = "Source: IPUMS NHGIS (1990, 2000, 2010 Census, and 2018-2022). Tabulations by Great Cities Institute.",
           general_title = "") %>% 
  kableExtra::landscape()
 #  add_footnote(c( "Source: IPUMS NHGIS (1980, 1990, 2000, 2010 Census, and 2018-2022). Tabulations by Great Cities Institute.", "Total Hispanic or Latino for 1980: person of Spanish/Hispanic origin or descent.", "Total Hispanic or Latino for 1990: person of Spanish/Hispanic origin.", "Total Hispanic or Latino for 2000: person of Spanish/Hispanic/Latino origin.", "Total Hispanic or Latino for 2010 and 2020: person of Hispanic, Latino, or Spanish origin."), threeparttable = TRUE,
 # notation = "symbol")

county_pop_1990_2020_tb2


```


```{r}

color_county <- c("Chicago" = "#997b66",
                  "Cook County Outside of Chicago" = "#d08c60",
                  "Kane County" = "#e8ac65",
                  "Lake County" = "#ffcb69",
                  "DuPage County" = "#d9ae94",
                  "Will County" = "#baa587",
                  "McHenry County" = "#797d62")

line_chart <- county_pop_1990_2020 %>%
  filter(county != "Cook County") %>% 
  ggplot() +
  geom_line(aes(x = year, y = mexican, group = county, colour = county),
            # color = "#636363",
            linewidth = 0.8 ) +
    scale_color_manual(values = color_county) +
  
  # geom_text(data = county_pop_1990_2020 %>% filter(year == "2018-2022" & county!= "DuPage County"),
  # aes(x = year, y = mexican,
  #     label = county),
  # color = "#636363",
  # nudge_x = 0.1,
  # hjust = "left",
  # size = 2.5) +

  geom_point(data = filter(county_pop_1990_2020, county!= "Cook County") ,
            aes(x = year, y = mexican, group = county, 
                colour = county
                ),
            shape = 20,
            size = 2 ) +
  theme_plots +
  labs(y="", x = "",
       title="Mexican Population in Cook County and Collar Counties,\nIllinois, 1990 to 2018-2022",
       caption = "Source: IPUMS NHGIS (1990, 2000, 2010 Census, and 2018-2022 ACS). Tabulations by Great Cities Institute",
       color="") +
  

  
  # scale_y_discrete(labels = function(x) str_wrap(x, width = 20)) + # Modify labels of ggplot2 barplot
  scale_y_continuous(breaks = seq(50000, 600000, by = 50000), labels = scales::comma) +
  coord_cartesian(ylim = c(0, 600000)) +
  
  theme_plots +
  theme(axis.text.y = element_text(size = 8),
        panel.background = element_blank(),
        # axis.ticks.y = element_blank(),
        # axis.title.y = element_blank(),
        # axis.text.x = element_blank(),
        axis.line.y = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 7, color = "#636363"),
        legend.key.size = unit(0.8, "lines"))+
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) +
  scale_x_discrete(expand = expand_scale(mult = c(0.05, 0.1)))

line_chart
```


### Maps

```{r fig.height=10, fig.width=8}

county_pop_1990_2020_2 = county_pop_1990_2020 %>% mutate(state_county = as.character(state_county)) %>% 
  filter(!county %in% c("Chicago", "Cook County Outside of Chicago"))

Collar_county_pop_shp <-
  left_join(collar_county_border , county_pop_1990_2020_2, by = join_by("GEOID" == "state_county"))



collar_mexican_map_2022 <-

  tm_shape(Collar_county_pop_shp) +
  tm_polygons(
    col = "mexican",
    palette="Blues",
    breaks =  c(4988, 40000, 80000, 120000, 160000, 1034038),
    alpha = 0.9,
    title = "Mexican Population",
    legend.show = FALSE
    ) +
  tm_facets(by = "year",
              ncol = 2) +

  tm_symbols(shape = 20,
             size = "prc_mex_total",
             alpha = 0.5,
             scale = 11,
             "#C91835",
             legend.size.show = FALSE
             ) +

  tm_borders(col = "black",
             alpha = 1,
             lwd = 4) +

  tm_facets(by = "year",
              ncol = 2) +
  tm_text("prc_mex_total2" , size = 1.5, alpha = 1, fontface="bold", fontfamily = "sans", col = "black") +

  tm_shape(Collar_county_pop_shp,
           bbox = bbox_new) +
  tm_text("NAME" , size = 1, alpha = 1, fontface="bold", fontfamily = "sans", col = "black",  ymod = 1.9) +
  # tm_facets(by = "year",
  #             ncol = 2) +
  tm_shape(Collar_county_pop_shp %>%
             mutate(mexican = scales::comma(mexican))) +
  tm_text("mexican" , size = 1, alpha = 1, fontface="plain", fontfamily = "sans", col = "black",  ymod = -1.9) +

  tm_facets(by = "year",
              ncol = 2) +
  tm_layout( frame = TRUE,
            legend.width = 1,
            legend.title.size = .9,
            legend.text.size = 0.8,
            legend.title.fontface = "bold",
            legend.position = c("right", "bottom"),
            # legend.position = c(0.05, 0.12)

            ) +
  tm_add_legend("fill", 
                labels = c("4,988 - 40,000", "40,001 - 80,000", "80,001 - 120,000", "120,001 - 160,000", "160,001 - 1,034,038"), 
                col = c("#eff3ff", "#bdd7e7", "#6baed6", "#3182bd", "#08519c"),
                alpha = 0.9,
                lwd = .3,

                border.col = "#ced4da",
                title = "Mexican Population",
                size = 0.7) +

   tm_add_legend("symbol",
                 shape = 20,
                 alpha = 0.5,
             # scale = 11,
                labels = "% Mexican of\nTotal Population",
                col = "#C91835",
                title = "",
                size = 5)
  


collar_mexican_map_2022

```

\clearpage


```{r}
### prc_mex_his2 = paste0(format(round(prc_mex_his, 1), nsmall = 1), "%")

pop_latino_2000_2020 <- read_csv("Data Tables/pop_latino_2000_2020.csv") %>%
  select(1:10, total_his, total_pop) %>%
  pivot_longer(cols = c(5:12),
               names_to = "origin",
               values_to = "count") %>%
  group_by(YEAR, COUNTY ) %>%

  mutate(per = round((count / count[origin == "total_pop"]) * 100, 2)) %>%

  pivot_wider(id_cols = c("COUNTY", "origin"),
              names_from = c("YEAR"),
              values_from = c("count", "per")) %>%

  mutate(per_2000 =  paste0(format(round(per_2000, 1), nsmall = 1), "%"),
         per_2010 = paste0(format(round(per_2010, 1), nsmall = 1), "%"),
         `per_2018-2022` = paste0(format(round(`per_2018-2022`, 1), nsmall = 1), "%")) %>%

  mutate(change_2000_2020 = `count_2018-2022` - count_2000,
         growth_rate = 100*(`count_2018-2022` - count_2000)/count_2000,
         growth_rate = paste0(format(round(growth_rate, 1), nsmall = 1), "%")) %>% 
  mutate(origin = case_when(
    
                            origin == "total_his" ~ "Total Hispanic or Latino",
                            origin == "total_pop" ~ "Total Population",
                            TRUE ~ origin))


pop_latino_2000_2020_tb <- pop_latino_2000_2020 %>%
  ungroup() %>%
  select(origin, count_2000, per_2000, count_2010, per_2010, `count_2018-2022`, `per_2018-2022`, change_2000_2020, growth_rate ) %>%



  ## using kable
  kable(booktabs = T,
        longtable = T, 
        col.names = c("", "Number", "Percent",
                      "Number", "Percent",
                      "Number", "Percent",
                      "Number", "Growth Rate"),
      align = c("l" ,rep("c",8)),
      caption = "Hispanic or Latino Population in Cook County and Collar Counties by Origin and Year, Illinois, 2000 to 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
  add_header_above( c("Origin", "2000" = 2, "2010" = 2, "2018-2022" = 2, "Change from 2000\nto 2018-2022" = 2),
                    # background = "#cbc9e2",
                    bold = T, font_size =8) %>%
  row_spec(0, bold = T,
           # background = "#f2f0f7",
           font_size = 8) %>% 
  kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = c("HOLD_position", "repeat_header"),
                repeat_header_continued = "\\textit{(Continued on Next Page...)}"
                ) %>%


  pack_rows("Cook County", 1,8, hline_after = T  ) %>%
  pack_rows("DuPage County", 9, 16, hline_before = T , hline_after = T) %>%
  pack_rows("Kane County", 17, 24,  hline_before = T , hline_after = T) %>%
  pack_rows("Lake County", 25, 32,  hline_before = T, hline_after = T ) %>%
  pack_rows("McHenry County", 33, 40,  
            # hline_before = T, 
            hline_after = T ) %>%
  pack_rows("Will County", 41, 48,  hline_before = T, hline_after = T ) %>%
  # column_spec(1, width = "8em", border_left = FALSE, extra_css = "text-align: left;", monospace = TRUE) %>%
  row_spec(c(7,8, 15,16, 23, 24, 31, 32, 39, 40, 47, 48),  background = "#f2f0f7") %>% 
  row_spec(c(6, 14, 22, 30, 38, 46), hline_after = T) %>% 
  column_spec(1, width = "12em") %>%
  column_spec(2:8, width = "4.6em") %>%
  footnote(general = "Source: IPUMS NHGIS (2000, 2010 Census, and 2018-2022). Tabulations by Great Cities Institute.",
           general_title = "")

pop_latino_2000_2020_tb



```
