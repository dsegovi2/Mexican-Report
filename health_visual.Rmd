---
title: "Mexican Report"
author: "Health"
date: "Great Cities Institute"
output: 
  pdf_document:
    latex_engine: xelatex
    toc: true
    highlight: pygments
    extra_dependencies: ["float"]
    fig_caption: true
mainfont: "Arial"
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, fig.pos="H")


```


```{r}

library(ipumsr)
library(tidyverse)
library(purrr)
library(sf)
library(tidycensus)
library(tidyr)
library(readxl)
library(sf)
library(htmltools)
library(leaflet)
library(janitor)
library(data.table)
library(tinytex)
library(survey) # for survey analysis
library(srvyr)  # for tidy survey analysis
library(tmap)
library("kableExtra") 
library(tmaptools)
library("RColorBrewer") 
# library(OpenStreetMap)
# remotes::install_github('yihui/knitr')
# install.packages("knitr")
# library(knitr)
# options(tinytex.verbose = TRUE)
# tinytex::reinstall_tinytex()
# install.packages('tinytex')

# update.packages(ask = FALSE, checkBuilt = TRUE)
# tinytex::tlmgr_update()
# tinytex::latexmk("demographic_visual.tex")

##### Chicago boarder
Chicago_boundary_shp <- read_sf("C:/Users/dsegovi2/Box/Great Cities Institute/Research/Mexican Report/Boundaries_Chicago/geo_export_8881adc5-2460-457b-892f-04f4d6028b72.shp") %>% 
  st_transform(crs = 4326)
# mapview(community_shp)


### usa data

# Read Data

usa_data <- read.csv("C:/Users/dsegovi2/Box/Great Cities Institute/Research/Mexican Report/final_Mexican_IL_2000_22.csv") %>% 
  mutate(race_ethnicity = case_when(hispan ==0 & race == 1 ~ "White (non-Hispanic or Latino)",
                                    hispan ==0 & race == 2 ~ "Black (non-Hispanic or Latino)",
                                    hispan %in% c(2,3,4) ~ "Other Latinos",
                                    hispan ==1 ~ "Mexican", 
                                    hispan ==0 & race %in%c(3:9) ~ "Other (non-Hispanic or Latino)",
                                    TRUE ~ NA_character_)) %>% 
  mutate(race_ethnicity = factor(race_ethnicity, level = c("Mexican", "Other Latinos","White (non-Hispanic or Latino)", "Black (non-Hispanic or Latino)",  "Other (non-Hispanic or Latino)")))

```



\renewcommand{\arraystretch}{1.4}
\clearpage



# Health 

## 1A: Number and Percentages of Mexicans without Health Insurance, 2018-2022:


```{r}
# analysis
## select variables, filter for year 2022
df <- usa_data %>%  filter(year == 2022) %>% select(race_ethnicity, hcovany, perwt)

# Create survey design object
survey_design <- df %>%
  as_survey_design(weights = perwt)
  
  
# Calculate numerator: weighted count of individuals without health insurance by race_ethnicity
numerator_without_insurance <- survey_design %>%
  filter(hcovany == 1) %>% 
  group_by(race_ethnicity) %>%
  summarise(weighted_n_without_insurance = survey_total(vartype = "se"))

# Calculate denominator: total population by race_ethnicity
denominator <- survey_design %>%
  group_by(race_ethnicity) %>%
  summarise(total_pop = survey_total(vartype = "se")) 
  
# calculate rate

# Join numerator and denominator
df_rates <- numerator_without_insurance %>%
  left_join(denominator, by = "race_ethnicity") %>%
  mutate(no_insurance_rate = (weighted_n_without_insurance / total_pop) * 100, 
         no_insurance_rate = paste0(round(no_insurance_rate, 1), "%"))
  


```


```{r}
# visuals
# visuals
table_1a <- df_rates  %>% select(race_ethnicity, weighted_n_without_insurance, no_insurance_rate)   %>% 
 
   # using kable 
  
  kbl(, booktabs = T,
      col.names = c("Race/Ethnicity", "Number without health insurance", "No Insurance Rate"),
      align = c("l",rep("c",2)),
      caption = "No Health Insurance, 2018-2022",
      format.args = list(big.mark = ","),
      linesep = "")  %>% 
  kable_classic(full_width = F,  
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>% 
  column_spec(1, width = "14.2em") %>%
  column_spec(2:3, width = "12.9em") %>%  

  row_spec(0, bold = T,
             #background = "#f2f0f7",
            font_size = 8) %>%

  footnote(general = "Source: IPUMS-USA database (2018-2022). Tabulations by Great Cities Institute",
           general_title = "")   


table_1a 

```






