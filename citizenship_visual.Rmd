---
title: "Mexican Report"
author: "Citizenship and Civic Participation"
date: "Great Cities Institute"
output: 
  pdf_document:
    latex_engine: xelatex
    toc: true
    highlight: pygments
    extra_dependencies: ["float"]
    fig_caption: true
mainfont: "Arial"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, fig.pos="H")
```


```{r echo=FALSE, message=FALSE, warning=FALSE}

library(ipumsr)
library(tidyverse)
library(purrr)
library(sf)
library(tidycensus)
library(tidyr)
library(readxl)
library(sf)
library(htmltools)
library(leaflet)
library(janitor)
library(data.table)
library(survey) # for survey analysis
library(srvyr)  # for tidy survey analysis
library(palmerpenguins)
library("kableExtra") 
library(stringr)
library(knitr)
library(palmerpenguins)
options(tinytex.verbose = TRUE)


usa_data <- read.csv("C:/Users/elhamp2/Box/Great Cities Institute/Research/Mexican Report/final_Mexican_IL_2000_22.csv") %>% 
  mutate(race_ethnicity = case_when(hispan ==0 & race == 1 ~ "White (non-Hispanic or Latino)",
                                    hispan ==0 & race == 2 ~ "Black (non-Hispanic or Latino)",
                                    hispan %in% c(2,3,4) ~ "Other Latinos",
                                    hispan ==1 ~ "Mexican", 
                                    hispan ==0 & race %in%c(3:9) ~ "Other (non-Hispanic or Latino)",
                                    TRUE ~ NA_character_)) %>% 
  mutate(race_ethnicity = factor(race_ethnicity, level = c("Mexican", "Other Latinos","White (non-Hispanic or Latino)", "Black (non-Hispanic or Latino)",  "Other (non-Hispanic or Latino)"))) 
# install.packages("knitr")


```

\renewcommand{\arraystretch}{1.4}
\clearpage

# 6.Citizenship and Civic Participation

## 6.A:Number and percentages of Mexicans by status

```{r}

process_year <- function(data, year) {
  
  df <- usa_data %>% 
    filter(year == !!year) %>% 
    select(race_ethnicity, citizen, perwt) %>%
    mutate(
      citizenship_status = case_when(
        citizen == 1 ~ "Citizen",
        citizen == 2 ~ "Citizen",
        citizen == 3 ~ "Not a Citizen",
        TRUE ~ "Unknown"  # This includes N/A and any other undefined categories
      )
    )
  
  survey_design <- df %>%
    as_survey_design(weights = perwt)
  
  numerator <- survey_design %>%
    group_by(race_ethnicity, citizenship_status) %>%
    summarise(weighted_n = survey_total(vartype = "se"))
  
  denominator <- survey_design %>%
    group_by(race_ethnicity) %>%
    summarise(total_pop = survey_total(vartype = "se"))
  
  rates <- numerator %>%
    left_join(denominator, by = "race_ethnicity") %>%
    mutate(rate = round(weighted_n / total_pop, 4)*100) %>% 
    mutate(year = !!year)
  
  return(rates)
}

# Process data for 2022, 2012, and 2000
df_rates_2022 <- process_year(data_chi, 2022)
df_rates_2012 <- process_year(data_chi, 2012)
df_rates_2000 <- process_year(data_chi, 2000)

# Combine all years
citizenship <- bind_rows(df_rates_2022, df_rates_2012, df_rates_2000)

```



```{r}
 table_6.a1  <- citizenship %>%
  ungroup() %>%
  filter(citizenship_status != "Unknown") %>% 
  select(year, race_ethnicity,  citizenship_status, rate) %>%
  pivot_wider(id_cols = race_ethnicity,   names_from =c(citizenship_status, year) , values_from = rate) %>% 
  mutate(change_non_citizen = round(`Not a Citizen_2022` - `Not a Citizen_2000`, 2) ,
         change_citizen = round(Citizen_2022 - Citizen_2000, 2)) %>% 
    
    select(race_ethnicity,  Citizen_2000, `Not a Citizen_2000` ,Citizen_2012, `Not a Citizen_2012`, Citizen_2022, `Not a Citizen_2022`, change_citizen, change_non_citizen) %>%
  mutate(across(-race_ethnicity, ~ paste0(., "%"))) %>% 
  
  kbl(booktabs = T,
      col.names = c("",  "Citizen Rate" ,"Non citizen Rate", "Citizen Rate" ,"Non citizen Rate", "Citizen Rate" ,"Non citizen Rate", "Citizen Rate" ,"Non citizen Rate"),
      align = c("l",rep("c",8)),
      caption = "Citizenship by Race/Ethnicity in Chicago, 2000-2022",
      format.args = list(big.mark = ","),
      linesep = "") %>%
 kable_classic(full_width = F,
                font_size = 8,
                html_font = "Arial",
                position = "center",
                latex_options = "HOLD_position") %>%
  column_spec(1, width = "14.2em") %>%
  column_spec(2:9, width = "3.8em") %>%
  add_header_above(align = c("l", rep("c",4)), c("Race/Ethnicity", "2000" = 2, "2008-2012" = 2, "2018-2022" = 2, "Change from\n2000 to 2018-2022" = 2), 
                   bold = T, font_size =8) %>%
  # row_spec(0, bold = T,
  #          # background = "#f2f0f7",
  #          font_size = 8) %>%

  
  add_footnote(c( "Source: IPUMS-USA database (2000-2022). Tabulations by Great Cities Institute"),
 notation = "none")              

table_6.a1                                                                                                                                                                                                                                                                                                                                                                                                      
```












